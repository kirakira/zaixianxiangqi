var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(q){return 8<=q}function Move(q,t,g,A,D,v){this.i1=q;this.j1=t;this.i2=g;this.j2=A;this.piece=D||PIECE_NONE;this.capture=v||PIECE_NONE}
function Chess(){function q(){return 0==l.length%2}function t(b){return 8<=b?b-8:b}function g(){n=[];l=[];for(var b=0;10>b;++b)for(n.push([]),j=0;9>j;++j)n[b].push(0);b="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=b.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var f=0;for(k=0;k<b[i].length;++k){if(9<=f)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var d=b[i][k];if("0"<=d&&"9">=d)f+=parseInt(b[i][k],10);else{var d=n[i],a=f,y=b[i][k],e=y==y.toLowerCase(),y=y.toLowerCase(),c=0;"k"==y?c=1:"a"==y?c=2:"e"==y?c=3:"h"==y?c=4:"r"==y?c=5:"c"==y?c=6:"p"==y&&(c=7);e||(c+=8);d[a]=c;++f}}}}function A(b,f,d,a){l.push(new Move(b,f,d,a,n[b][f],n[d][a]));n[d][a]=n[b][f];n[b][f]=0;return l[l.length-1]}function D(){var b=l.pop();n[b.i1][b.j1]=n[b.i2][b.j2];n[b.i2][b.j2]=b.capture}function v(b,f){return 0<=b&&10>b&&0<=f&&9>f}function m(b,f){return 3<=f&&5>=f&&
(0<=b&&2>=b||7<=b&&9>=b)}function x(b,f){var l=[];for(r=0;4>r;++r)m(b+h[r],f+d[r])&&l.push(new Move(b,f,b+h[r],f+d[r]));for(delta=-1;1>=delta;delta+=2)for(ii=b+delta;0<=ii&&10>ii&&(t(n[ii][f])==PIECE_K&&l.push(new Move(b,f,ii,f)),0==n[ii][f]);ii+=delta);return l}function B(b,f){var d=[];for(r=0;4>r;++r)m(b+e[r],f+c[r])&&d.push(new Move(b,f,b+e[r],f+c[r]));return d}function F(b,f){var d=[];for(r=0;4>r;++r)v(b+2*e[r],f+2*c[r])&&0==n[b+e[r]][f+c[r]]&&4<b+e[r]&&d.push(new Move(b,f,b+2*e[r],f+2*c[r]));
return d}function w(b,f){var d=[];for(r=0;4>r;++r)!v(b+2*e[r],f+2*c[r])||0!=n[b+e[r]][f+c[r]]||4<b+e[r]||d.push(new Move(b,f,b+2*e[r],f+2*c[r]));return d}function u(b,f){var d=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(l){v(b+l[0],f+l[1])&&0==n[b+l[2]][f+l[3]]&&d.push(new Move(b,f,b+l[0],f+l[1]))});return d}function a(b,f){var l=[];for(r=0;4>r;++r){var a,c;a=b+h[r];for(c=f+d[r];v(a,c)&&(l.push(new Move(b,f,a,c)),0==n[a][c]);a+=
h[r],c+=d[r]);}return l}function C(b,f){var l=[];for(r=0;4>r;++r){var a,c,e=!1;a=b+h[r];for(c=f+d[r];v(a,c);a+=h[r],c+=d[r])if(!e&&0==n[a][c])l.push(new Move(b,f,a,c));else if(!e&&0!=n[a][c])e=!0;else if(e&&0!=n[a][c]){l.push(new Move(b,f,a,c));break}}return l}function p(b,f){var d=[];4<b?d.push(new Move(b,f,b-1,f)):(v(b-1,f)&&d.push(new Move(b,f,b-1,f)),v(b,f-1)&&d.push(new Move(b,f,b,f-1)),v(b,f+1)&&d.push(new Move(b,f,b,f+1)));return d}function G(b,f){var d=[];4<b?(v(b+1,f)&&d.push(new Move(b,
f,b+1,f)),v(b,f-1)&&d.push(new Move(b,f,b,f-1)),v(b,f+1)&&d.push(new Move(b,f,b,f+1))):d.push(new Move(b,f,b+1,f));return d}function E(b,d,l){var c=t(n[b][d]),e=isRedPiece(n[b][d]),h=[];1==c?h=x(b,d):2==c?h=B(b,d):3==c?h=e?F(b,d):w(b,d):4==c?h=u(b,d):5==c?h=a(b,d):6==c?h=C(b,d):7==c&&(h=e?p(b,d):G(b,d));h.forEach(function(b){0!=n[b.i2][b.j2]&&isRedPiece(n[b.i2][b.j2])==e||l.push(b)})}function z(b){var d=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=n[i][j]&&isRedPiece(n[i][j])==b&&E(i,j,d);return d}this.reset=
g;this.setMoves=function(b){var d=l;g();for(var c=!0,a=0,e=0;e<b.length;++e)A(b[e][0],b[e][1],b[e][2],b[e][3]),c&&d.length>e&&d[e].i1==b[e][0]&&d[e].j1==b[e][1]&&d[e].i2==b[e][2]&&d[e].j2==b[e][3]?++a:c=!1;return a};this.move=A;this.checkMove=function(b,d,l,c){var a=q();if(!z(a).find(function(a,e,h){return a.i1==b&&a.j1==d&&a.i2==l&&a.j2==c}))return!1;if(n[l][c]==(a?PIECE_BK:PIECE_RK))return!0;var e=!1;A(b,d,l,c);z(!a).find(function(b,d,l){return n[b.i2][b.j2]==(a?PIECE_RK:PIECE_BK)})&&(e=!0);D();
return!e};this.moveHistory=function(){for(var b=[],d=0;d<l.length;++d)b.push(l[d]);return b};this.pieceAt=function(b,d){return n[b][d]};this.isRedNext=q;this.numMoves=function(){return l.length};var n=[],l=[];g();var h=[0,1,0,-1],d=[1,0,-1,0],e=[1,1,-1,-1],c=[1,-1,-1,1]};function removeAllChildren(q){for(q=document.getElementById(q);q.lastChild;)q.removeChild(q.lastChild)}
function BoardUI(q){function t(){return document.getElementById("board")}function g(l,a){n&&(a=8-a);return E/2+a*E}function A(a,h){n&&(a=9-a);return 5>h?E/2+a*E:E/2+a*E+z}function D(a,h,d,e,c,b){var f=document.createElementNS(p,"line");f.setAttribute("x1",a);f.setAttribute("y1",h);f.setAttribute("x2",d);f.setAttribute("y2",e);f.setAttribute("class",c);b&&(f.id=b);return f}function v(a,h,d,e,c){var b=g(a,h);a=A(a,h);h=document.createElementNS(p,"circle");h.setAttribute("cx",b);h.setAttribute("cy",
a);h.setAttribute("r",d);h.setAttribute("class",e);c&&(h.id=c);return h}function m(a,h){return"abcdefghi"[h]+(9-a).toString()}function x(a,h){return function(){q(a,h)}}function B(a,h){var d=v(a,h,23,"piece-cover","piece-cover-"+m(a,h));d.style.strokeWidth=0;d.style.fillOpacity=0;d.onmousedown=x(a,h);d.touchend=d.onmousedown;w(d)}function F(a,h){var d="piece-cover-"+m(a,h);null!=document.getElementById(d)&&u(d)}function w(a){t().appendChild(a)}function u(a){t().removeChild(document.getElementById(a))}
function a(a,h,d,e){var c;c=g(a,h);a=A(a,h);h=g(d,e);d=A(d,e);c=D(c,a,h,d,"grid",void 0);c.style.strokeWidth=1;c.style.stroke="gray";w(c)}function C(l){n=l;removeAllChildren("board");t();for(i=0;9>i;++i)a(0,i,4,i),0!=i&&8!=i||a(4,i,5,i),a(5,i,9,i);for(i=0;10>i;++i)a(i,0,i,8);a(0,3,2,5);a(0,5,2,3);a(7,3,9,5);a(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)B(i,j)}this.reset=C;this.drawPiece=function(a,h,d){F(a,h);var e=v(a,h,23,"piece-outer","piece-outer-"+m(a,h)),c=v(a,h,20,"piece-inner","piece-inner-"+
m(a,h)),b=G[d],f="piece-text-"+m(a,h),C=g(a,h)-12,n=A(a,h)+7.5,y=document.createElementNS(p,"text");y.style.fontSize=24;y.setAttribute("x",C);y.setAttribute("y",n);y.appendChild(document.createTextNode(b));y.setAttribute("class","piece-text");f&&(y.id=f);isRedPiece(d)?(e.setAttribute("stroke","red"),c.style.stroke="red",y.style.fill="red"):(e.style.stroke="black",c.style.stroke="black",y.style.fill="black");e.style.strokeWidth=2;c.style.strokeWidth=2;e.style.fill="white";c.style.fillOpacity=0;w(e);
w(c);w(y);B(a,h)};this.erasePiece=function(a,h){F(a,h);u("piece-text-"+m(a,h));u("piece-inner-"+m(a,h));u("piece-outer-"+m(a,h));B(a,h)};this.highlightSquare=function(a,h){var d=g(a,h),e=A(a,h),c=E/6;for(a=-1;1>=a;a+=2){var b=D(d-23,e+23*a,d-23+c,e+23*a,"highlighter",void 0);b.style.strokeWidth=2;b.style.stroke="blue";w(b);b=D(d+23-c,e+23*a,d+23,e+23*a,"highlighter",void 0);b.style.strokeWidth=2;b.style.stroke="blue";w(b)}for(a=-1;1>=a;a+=2)b=D(d+23*a,e-23,d+23*a,e-23+c,"highlighter",void 0),b.style.strokeWidth=
2,b.style.stroke="blue",w(b),b=D(d+23*a,e+23-c,d+23*a,e+23,"highlighter",void 0),b.style.strokeWidth=2,b.style.stroke="blue",w(b)};this.eraseHighlights=function(){for(var a=t().getElementsByClassName("highlighter");0<a.length;)t().removeChild(a[0])};var p="http://www.w3.org/2000/svg",G=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),E=50,z=0,n=!1;C(!1)};function Board(q){function t(){for(var a=0;10>a;++a)for(var g=0;9>g;++g)m.pieceAt(a,g)!=PIECE_NONE&&x.drawPiece(a,g,m.pieceAt(a,g));u=m.numMoves()}function g(a){a=Math.max(0,a);a=Math.min(m.numMoves(),a);if(a!=u){var g=m.moveHistory();if(a>u)for(var p=u;p<a;++p)D(g[p]);else for(p=u-1;p>=a;--p)0<p?v(g[p],g[p-1]):v(g[p],null);u=a}}function A(a){return a==PIECE_NONE?!1:"r"==B?isRedPiece(a):"b"==B?!isRedPiece(a):!1}function D(a){x.erasePiece(a.i1,a.j1);a.capture&&x.erasePiece(a.i2,a.j2);x.drawPiece(a.i2,
a.j2,a.piece);x.eraseHighlights();x.highlightSquare(a.i1,a.j1);x.highlightSquare(a.i2,a.j2);w=null}function v(a,g){x.drawPiece(a.i1,a.j1,a.piece);x.erasePiece(a.i2,a.j2);a.capture&&x.drawPiece(a.i2,a.j2,a.capture);x.eraseHighlights();g&&(x.highlightSquare(g.i1,g.j1),x.highlightSquare(g.i2,g.j2));w=null}this.setState=function(a,C,p){a!=B&&(B=a,x.reset("b"==a),m.reset(),t(),w=null);F=C;a=m.moveHistory();p=m.setMoves(p);C=u;u==a.length&&(C=m.numMoves());for(C=Math.min(C,m.numMoves());u>p;--u){var q=
u-1;0<q?v(a[q],a[q-1]):v(a[q],null)}g(C)};this.showMove=g;this.isRedNext=function(){return m.isRedNext()};this.numMoves=function(){return m.numMoves()};this.numMovesShown=function(){return u};var m=new Chess,x=new BoardUI(function(a,g){if(!F){var p=m.isRedNext();if(("r"==B&&p||"b"==B&&!p)&&u==m.numMoves())if(w)if(m.checkMove(w[0],w[1],a,g)){var p=w[0],t=w[1];D(m.move(p,t,a,g));++u;q(p,t,a,g)}else A(m.pieceAt(a,g))&&(x.eraseHighlights(),w=[a,g],x.highlightSquare(a,g));else A(m.pieceAt(a,g))&&(x.eraseHighlights(),
w=[a,g],x.highlightSquare(a,g))}}),B="r",F=!0,w=null,u=0;t()};String.prototype.endsWith||(String.prototype.endsWith=function(q,t){var g=this.toString();if(void 0===t||t>g.length)t=g.length;t-=q.length;g=g.indexOf(q,t);return-1!==g&&g===t});
function Game(q,t,g){function A(a,e,c,b,f,g,p){var m=new XMLHttpRequest;m.onreadystatechange=function(){if(4==m.readyState){var b=h.indexOf(c);if(-1!=b){h.splice(b,1);for(var a=n+1;a<=l;++a)if(b=h.indexOf(a),-1==b)n=a;else break;requestResolved=!0}else requestResolved=!1;200<=m.status&&299>=m.status?requestResolved||l==c?g(m.responseText):console.log("Dropped response from an old request."):p&&p(m.responseText)}};m.open(a,e,!0);b&&m.setRequestHeader("Content-type",b);f?m.send(f):m.send()}function D(a,
e,c,b){++l;h.push(l);A("POST",a,l,"application/x-www-form-urlencoded; charset=UTF-8",e,c,b)}function v(a){if("fail"==a)alert("Operation failed");else try{var e=JSON.parse(a);e.gameinfo&&("success"!==e.status&&console.log("last update failed"),e=e.gameinfo);g=e;E()}catch(c){console.log("Unrecognized server response: "+a)}}function m(a){a=a.split("/");for(var e=[],c=1;c<a.length;++c){var b=a[c];if("R"==b||"B"==b)break;e.push([parseInt(b[0],10),parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10)])}return e}
function x(a,e,c,b){var f=g;a=[a,e,c,b];f.moves+="/"+(""+a[0]+a[1]+a[2]+a[3]);C();D("/gameinfo","sid="+F("sid")+"&gid="+q+"&moves="+g.moves,v,B);G()}function B(a){console.log("Retrieve game info failed")}function F(a){a+="=";for(var e=document.cookie.split(";"),c=0;c<e.length;++c){for(var b=e[c];" "==b.charAt(0);)b=b.substring(1);if(0==b.indexOf(a))return b.substring(a.length,b.length)}return""}function w(a){var e=document.getElementById(a+"-player"),c=document.getElementById(a+"-sit-link");e.removeChild(c);
e.appendChild(document.createTextNode("sitting down..."));D("/gameinfo","sid="+F("sid")+"&gid="+q+"&sit="+a,v,B)}function u(a,e,c,b,f){var g=document.createElement("a");g.id=a;e&&(g.className=e);g.href=c;b&&(g.onclick=b);g.appendChild(document.createTextNode(f));return g}function a(){removeAllChildren("red-player");removeAllChildren("black-player");if(void 0!==g.red&&null!==g.red){var a="";g.red.id==t&&(a=" (you)");document.getElementById("red-player").appendChild(document.createTextNode("Red: "+
g.red.name+a))}else document.getElementById("red-player").appendChild(document.createTextNode("Red: ")),a=u("red-sit-link",void 0,"#",function(){w("red");return!1},"sit here"),document.getElementById("red-player").appendChild(a);void 0!==g.black&&null!==g.black?(a="",g.black.id==t&&(a=" (you)"),document.getElementById("black-player").appendChild(document.createTextNode("Black: "+g.black.name+a))):(document.getElementById("black-player").appendChild(document.createTextNode("Black: ")),a=u("black-sit-link",
void 0,"#",function(){w("black");return!1},"sit here"),document.getElementById("black-player").appendChild(a))}function C(){removeAllChildren("status");var a=document.getElementById("status");g.moves.endsWith("R")?a.appendChild(document.createTextNode("Red won")):g.moves.endsWith("B")?a.appendChild(document.createTextNode("Black won")):g.red&&g.black?z.isRedNext()?a.appendChild(document.createTextNode("Red to go")):a.appendChild(document.createTextNode("Black to go")):a.appendChild(document.createTextNode("Waiting for players to join..."))}
function p(a,e){var c=document.createElement("td");c.appendChild(e);a.appendChild(c)}function G(){removeAllChildren("move-history");var a=document.getElementById("move-history"),e=document.createElement("table");e.id="moveHistoryControls";var c=document.createElement("tr");e.appendChild(c);0<z.numMovesShown()?(p(c,u("move-history-first",void 0,"#",function(){z.showMove(0);G();return!1},"first")),p(c,u("move-history-prev",void 0,"#",function(){z.showMove(z.numMovesShown()-1);G();return!1},"prev"))):
(p(c,document.createTextNode("first")),p(c,document.createTextNode("prev")));p(c,document.createTextNode(""+z.numMovesShown()+" / "+z.numMoves()));z.numMovesShown()<z.numMoves()?(p(c,u("move-history-next",void 0,"#",function(){z.showMove(z.numMovesShown()+1);G();return!1},"next")),p(c,u("move-history-last",void 0,"#",function(){z.showMove(z.numMoves());G();return!1},"last"))):(p(c,document.createTextNode("next")),p(c,document.createTextNode("last")));a.appendChild(e);e=document.createElement("div");
e.id="moveHistoryFork";e.appendChild(u("move-history-fork-link",void 0,"/fork/"+q+"/"+z.numMovesShown().toString(),void 0,"fork"));e.appendChild(document.createTextNode(" this game from here"));a.appendChild(e)}function E(){a();var d="r";g.black&&g.black.id==t&&(d="b");var e=g.black&&g.black.id==t||g.red&&g.red.id==t;z.setState(d,!(g.red&&g.black&&!g.moves.endsWith("R")&&!g.moves.endsWith("B"))||!e,m(g.moves));C();G()}var z,n=0,l=0,h=[];(function(){z=new Board(x);E();window.setInterval(function(){A("GET",
"/gameinfo?gid="+q,n,void 0,void 0,v,B)},1E3)})()}document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,gameInfo)};

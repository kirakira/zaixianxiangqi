var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(w){return 8<=w}function Move(w,l,f,x,t,n){this.i1=w;this.j1=l;this.i2=f;this.j2=x;this.piece=t||PIECE_NONE;this.capture=n||PIECE_NONE}
function Chess(){function w(){return 0==v.length%2}function l(b){return 8<=b?b-8:b}function f(){m=[];v=[];for(var b=0;10>b;++b)for(m.push([]),j=0;9>j;++j)m[b].push(0);b="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=b.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var g=0;for(k=0;k<b[i].length;++k){if(9<=g)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var d=b[i][k];if("0"<=d&&"9">=d)g+=parseInt(b[i][k],10);else{var d=m[i],a=g,e=b[i][k],h=e==e.toLowerCase(),e=e.toLowerCase(),c=0;"k"==e?c=1:"a"==e?c=2:"e"==e?c=3:"h"==e?c=4:"r"==e?c=5:"c"==e?c=6:"p"==e&&(c=7);h||(c+=8);d[a]=c;++g}}}}function x(b,g,d,e){v.push(new Move(b,g,d,e,m[b][g],m[d][e]));m[d][e]=m[b][g];m[b][g]=0;return v[v.length-1]}function t(){var b=v.pop();m[b.i1][b.j1]=m[b.i2][b.j2];m[b.i2][b.j2]=b.capture}function n(b,g){return 0<=b&&10>b&&0<=g&&9>g}function q(b,g){return 3<=g&&5>=g&&
(0<=b&&2>=b||7<=b&&9>=b)}function a(b,g){var d=[];for(r=0;4>r;++r)q(b+B[r],g+e[r])&&d.push(new Move(b,g,b+B[r],g+e[r]));for(delta=-1;1>=delta;delta+=2)for(ii=b+delta;0<=ii&&10>ii&&(l(m[ii][g])==PIECE_K&&d.push(new Move(b,g,ii,g)),0==m[ii][g]);ii+=delta);return d}function p(b,g){var e=[];for(r=0;4>r;++r)q(b+c[r],g+d[r])&&e.push(new Move(b,g,b+c[r],g+d[r]));return e}function A(b,g){var e=[];for(r=0;4>r;++r)n(b+2*c[r],g+2*d[r])&&0==m[b+c[r]][g+d[r]]&&4<b+c[r]&&e.push(new Move(b,g,b+2*c[r],g+2*d[r]));
return e}function D(b,g){var e=[];for(r=0;4>r;++r)!n(b+2*c[r],g+2*d[r])||0!=m[b+c[r]][g+d[r]]||4<b+c[r]||e.push(new Move(b,g,b+2*c[r],g+2*d[r]));return e}function u(b,g){var d=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(e){n(b+e[0],g+e[1])&&0==m[b+e[2]][g+e[3]]&&d.push(new Move(b,g,b+e[0],g+e[1]))});return d}function y(b,g){var d=[];for(r=0;4>r;++r){var a,c;a=b+B[r];for(c=g+e[r];n(a,c)&&(d.push(new Move(b,g,a,c)),0==m[a][c]);a+=
B[r],c+=e[r]);}return d}function h(b,g){var d=[];for(r=0;4>r;++r){var a,c,h=!1;a=b+B[r];for(c=g+e[r];n(a,c);a+=B[r],c+=e[r])if(!h&&0==m[a][c])d.push(new Move(b,g,a,c));else if(!h&&0!=m[a][c])h=!0;else if(h&&0!=m[a][c]){d.push(new Move(b,g,a,c));break}}return d}function z(b,g){var d=[];4<b?d.push(new Move(b,g,b-1,g)):(n(b-1,g)&&d.push(new Move(b,g,b-1,g)),n(b,g-1)&&d.push(new Move(b,g,b,g-1)),n(b,g+1)&&d.push(new Move(b,g,b,g+1)));return d}function C(b,g){var d=[];4<b?(n(b+1,g)&&d.push(new Move(b,
g,b+1,g)),n(b,g-1)&&d.push(new Move(b,g,b,g-1)),n(b,g+1)&&d.push(new Move(b,g,b,g+1))):d.push(new Move(b,g,b+1,g));return d}function F(b,g,d){var e=l(m[b][g]),c=isRedPiece(m[b][g]),f=[];1==e?f=a(b,g):2==e?f=p(b,g):3==e?f=c?A(b,g):D(b,g):4==e?f=u(b,g):5==e?f=y(b,g):6==e?f=h(b,g):7==e&&(f=c?z(b,g):C(b,g));f.forEach(function(b){0!=m[b.i2][b.j2]&&isRedPiece(m[b.i2][b.j2])==c||d.push(b)})}function E(b){var g=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=m[i][j]&&isRedPiece(m[i][j])==b&&F(i,j,g);return g}this.reset=
f;this.setMoves=function(b){var g=v;f();for(var d=!0,e=0,c=0;c<b.length;++c)x(b[c][0],b[c][1],b[c][2],b[c][3]),d&&g.length>c&&g[c].i1==b[c][0]&&g[c].j1==b[c][1]&&g[c].i2==b[c][2]&&g[c].j2==b[c][3]?++e:d=!1;return e};this.move=x;this.checkMove=function(b,g,d,e){var c=w();if(!E(c).find(function(c,a,h){return c.i1==b&&c.j1==g&&c.i2==d&&c.j2==e}))return!1;if(m[d][e]==(c?PIECE_BK:PIECE_RK))return!0;var a=!1;x(b,g,d,e);E(!c).find(function(b,d,g){return m[b.i2][b.j2]==(c?PIECE_RK:PIECE_BK)})&&(a=!0);t();
return!a};this.moveHistory=function(){for(var b=[],d=0;d<v.length;++d)b.push(v[d]);return b};this.pieceAt=function(b,d){return m[b][d]};this.isRedNext=w;this.numMoves=function(){return v.length};var m=[],v=[];f();var B=[0,1,0,-1],e=[1,0,-1,0],c=[1,1,-1,-1],d=[1,-1,-1,1]};function removeAllChildren(w){for(w=document.getElementById(w);w.lastChild;)w.removeChild(w.lastChild)}
function BoardUI(w){function l(){return document.getElementById("board")}function f(e,c){B&&(c=8-c);return m/2+c*m}function x(e,c){B&&(e=9-e);return 5>c?m/2+e*m:m/2+e*m+v}function t(e,c,d,b,g,a){var h=document.createElementNS(C,"line");h.setAttribute("x1",e);h.setAttribute("y1",c);h.setAttribute("x2",d);h.setAttribute("y2",b);h.setAttribute("class",g);a&&(h.id=a);return h}function n(e,c,d,b,g){var a=f(e,c);e=x(e,c);c=document.createElementNS(C,"circle");c.setAttribute("cx",a);c.setAttribute("cy",
e);c.setAttribute("r",d);c.setAttribute("class",b);g&&(c.id=g);return c}function q(e,c){return"abcdefghi"[c]+(9-e).toString()}function a(e,c,d,b,g){D(c,d);var a=n(c,d,23,"piece-outer","piece-outer-"+q(c,d)),h=n(c,d,20,"piece-inner","piece-inner-"+q(c,d));g=g?E[b]:F[b];var p="piece-text-"+q(c,d),z=f(c,d);c=x(c,d);d=document.createElementNS(C,"text");d.style.fontFamily="Roboto,monospace";d.style.fontSize=24;d.setAttribute("text-anchor","middle");d.setAttribute("alignment-baseline","central");d.setAttribute("dominant-baseline",
"middle");d.setAttribute("x",z);d.setAttribute("y",c);d.appendChild(document.createTextNode(g));d.setAttribute("class","piece-text");d.userSelect="none";p&&(d.id=p);isRedPiece(b)?(a.setAttribute("stroke","red"),h.style.stroke="red",d.style.fill="red"):(a.style.stroke="black",h.style.stroke="black",d.style.fill="black");a.style.strokeWidth=2;h.style.strokeWidth=2;a.style.fill="white";h.style.fillOpacity=0;e.appendChild(a);e.appendChild(h);e.appendChild(d)}function p(e,c){return function(){w(e,c)}}
function A(e,c){var d=n(e,c,23,"piece-cover","piece-cover-"+q(e,c));d.style.strokeWidth=0;d.style.fillOpacity=0;d.userSelect="none";d.onmousedown=p(e,c);d.touchend=d.onmousedown;u(d)}function D(e,c){var d="piece-cover-"+q(e,c);null!=document.getElementById(d)&&y(d)}function u(e){l().appendChild(e)}function y(e){l().removeChild(document.getElementById(e))}function h(e,c,d,b){var g;g=f(e,c);e=x(e,c);c=f(d,b);d=x(d,b);g=t(g,e,c,d,"grid",void 0);g.style.strokeWidth=1;g.style.stroke="gray";u(g)}function z(e){B=
e;removeAllChildren("board");for(i=0;9>i;++i)h(0,i,4,i),0!=i&&8!=i||h(4,i,5,i),h(5,i,9,i);for(i=0;10>i;++i)h(i,0,i,8);h(0,3,2,5);h(0,5,2,3);h(7,3,9,5);h(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)A(i,j)}this.reset=z;this.drawPieceWithCover=function(e,c,d,b){a(l(),e,c,d,b);A(e,c)};this.erasePiece=function(e,c){D(e,c);y("piece-text-"+q(e,c));y("piece-inner-"+q(e,c));y("piece-outer-"+q(e,c));A(e,c)};this.drawColorIndicator=function(e,c){var d=1;c&&(d+=8);a(e,0,0,d,!1)};this.highlightSquare=function(e,
c){var d=f(e,c),b=x(e,c),g=m/6;for(e=-1;1>=e;e+=2){var a=t(d-23,b+23*e,d-23+g,b+23*e,"highlighter",void 0);a.style.strokeWidth=2;a.style.stroke="blue";u(a);a=t(d+23-g,b+23*e,d+23,b+23*e,"highlighter",void 0);a.style.strokeWidth=2;a.style.stroke="blue";u(a)}for(e=-1;1>=e;e+=2)a=t(d+23*e,b-23,d+23*e,b-23+g,"highlighter",void 0),a.style.strokeWidth=2,a.style.stroke="blue",u(a),a=t(d+23*e,b+23-g,d+23*e,b+23,"highlighter",void 0),a.style.strokeWidth=2,a.style.stroke="blue",u(a)};this.eraseHighlights=function(){for(var a=
l().getElementsByClassName("highlighter");0<a.length;)l().removeChild(a[0])};var C="http://www.w3.org/2000/svg",F=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),E=" \u5c07 \u58eb \u8c61 \ud83d\udc34 \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \ud83e\udd84 \u4fe5 \u70ae \u5175".split(" "),m=50,v=0,B=!1;z(!1)};function Board(w,l){function f(){for(var h=0;10>h;++h)for(var f=0;9>f;++f)a.pieceAt(h,f)!=PIECE_NONE&&p.drawPieceWithCover(h,f,a.pieceAt(h,f),!1);y=a.numMoves()}function x(h){h=Math.max(0,h);h=Math.min(a.numMoves(),h);if(h!=y){var f=a.moveHistory();if(h>y)for(var p=y;p<h;++p)n(f[p]);else for(p=y-1;p>=h;--p)0<p?q(f[p],f[p-1]):q(f[p],null);y=h}}function t(a){return a==PIECE_NONE?!1:"r"==A?isRedPiece(a):"b"==A?!isRedPiece(a):!1}function n(a){p.erasePiece(a.i1,a.j1);var f=!1;a.capture&&(p.erasePiece(a.i2,
a.j2),l&&(f=!0));p.drawPieceWithCover(a.i2,a.j2,a.piece,f);p.eraseHighlights();p.highlightSquare(a.i1,a.j1);p.highlightSquare(a.i2,a.j2);u=null}function q(a,f){p.drawPieceWithCover(a.i1,a.j1,a.piece,!1);p.erasePiece(a.i2,a.j2);a.capture&&p.drawPieceWithCover(a.i2,a.j2,a.capture,!1);p.eraseHighlights();f&&(p.highlightSquare(f.i1,f.j1),p.highlightSquare(f.i2,f.j2));u=null}this.setState=function(h,l,t){h!=A&&(A=h,p.reset("b"==h),a.reset(),f(),u=null);D=l;h=a.moveHistory();t=a.setMoves(t);l=y;y==h.length&&
(l=a.numMoves());for(l=Math.min(l,a.numMoves());y>t;--y){var n=y-1;0<n?q(h[n],h[n-1]):q(h[n],null)}x(l)};this.showMove=x;this.isRedNext=function(){return a.isRedNext()};this.numMoves=function(){return a.numMoves()};this.numMovesShown=function(){return y};var a=new Chess,p=new BoardUI(function(f,l){if(!D){var q=a.isRedNext();if(("r"==A&&q||"b"==A&&!q)&&y==a.numMoves())if(u)if(a.checkMove(u[0],u[1],f,l)){var q=u[0],x=u[1];n(a.move(q,x,f,l));++y;w(q,x,f,l)}else t(a.pieceAt(f,l))&&(p.eraseHighlights(),
u=[f,l],p.highlightSquare(f,l));else t(a.pieceAt(f,l))&&(p.eraseHighlights(),u=[f,l],p.highlightSquare(f,l))}}),A="r",D=!0,u=null,y=0;p.drawColorIndicator(document.getElementById("redIndicator"),!0);p.drawColorIndicator(document.getElementById("blackIndicator"),!1);f()};function Stopwatch(w){function l(){return document.getElementById(w)}function f(){if(n){var a=document.getElementById(w+"Hand"),f=.8*t,l=q/x*2*Math.PI;a.setAttribute("x2",f*Math.sin(l));a.setAttribute("y2",-f*Math.cos(l));++q;q%=x}}this.start=function(){n||(n=!0,q=0,f(),l().style.visibility="visible")};this.stop=function(){n=!1;l().style.visibility="hidden"};this.tick=f;this.frequency=function(){return x};var x=250,t=20,n=!1,q=0;(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",
"circle");a.setAttribute("cx",0);a.setAttribute("cy",0);a.setAttribute("r",t);a.style.stroke="black";a.style.strokeWidth=2;a.style.fillOpacity=0;l().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0);a.setAttribute("y1",-t);a.setAttribute("x2",0);a.setAttribute("y2",-t-6);a.style.strokeWidth=4;a.style.stroke="black";l().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",-3);a.setAttribute("y",-t-6-4);
a.setAttribute("width",6);a.setAttribute("height",4);a.style.strokeWidth=.5;a.style.stroke="black";a.style.fillOpacity=0;l().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",0);a.setAttribute("cy",-t-6-2);a.setAttribute("r",6);a.style.stroke="black";a.style.strokeWidth=1;a.style.fillOpacity=0;l().appendChild(a);for(a=-3;3>=a;a+=1){var f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",a);f.setAttribute("y1",-t-6-
4);f.setAttribute("x2",a);f.setAttribute("y2",-t-6);f.style.strokeWidth=.2;f.style.stroke="black";l().appendChild(f)}for(a=0;12>a;++a){var f=document.createElementNS("http://www.w3.org/2000/svg","line"),n=a/12*2*Math.PI,q=t,u=.7*t;f.setAttribute("x1",q*Math.sin(n));f.setAttribute("y1",-q*Math.cos(n));f.setAttribute("x2",u*Math.sin(n));f.setAttribute("y2",-u*Math.cos(n));f.style.strokeWidth=1;f.style.stroke="black";l().appendChild(f)}for(a=0;60>a;++a)f=document.createElementNS("http://www.w3.org/2000/svg",
"line"),n=a/60*2*Math.PI,q=t,u=.85*t,f.setAttribute("x1",q*Math.sin(n)),f.setAttribute("y1",-q*Math.cos(n)),f.setAttribute("x2",u*Math.sin(n)),f.setAttribute("y2",-u*Math.cos(n)),f.style.strokeWidth=.5,f.style.stroke="black",l().appendChild(f);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.id=w+"Hand";a.setAttribute("x1",0);a.setAttribute("y1",0);a.setAttribute("x2",0);a.setAttribute("y2",.8*-t);a.style.strokeWidth=1;a.style.stroke="black";l().appendChild(a);l().style.visibility=
"hidden"})()};String.prototype.endsWith||(String.prototype.endsWith=function(w,l){var f=this.toString();if(void 0===l||l>f.length)l=f.length;l-=w.length;f=f.indexOf(w,l);return-1!==f&&f===l});
function Game(w,l,f){function x(d,b,a,f,h,l,n){var m=new XMLHttpRequest;m.onreadystatechange=function(){if(4==m.readyState){var b=c.indexOf(a);if(-1!=b){c.splice(b,1);for(var d=B+1;d<=e;++d)if(b=c.indexOf(d),-1==b)B=d;else break;requestResolved=!0}else requestResolved=!1;200<=m.status&&299>=m.status?requestResolved||e==a?l(m.responseText):console.log("Dropped response from an old request."):n&&n(m.responseText)}};m.open(d,b,!0);f&&m.setRequestHeader("Content-type",f);h?m.send(h):m.send()}function t(d,
b,a,f){++e;c.push(e);x("POST",d,e,"application/x-www-form-urlencoded; charset=UTF-8",b,a,f)}function n(d){if("fail"==d)alert("Operation failed");else try{var b=JSON.parse(d);b.gameinfo&&("success"!==b.status&&console.log("last update failed"),b=b.gameinfo);f=b;F()}catch(a){console.log("Unrecognized server response: "+d)}}function q(d){d=d.split("/");for(var b=[],a=1;a<d.length;++a){var c=d[a];if("R"==c||"B"==c)break;b.push([parseInt(c[0],10),parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)])}return b}
function a(d,b,a,c){var e=f;d=[d,b,a,c];e.moves+="/"+(""+d[0]+d[1]+d[2]+d[3]);h();t("/gameinfo","uid="+l+"&sid="+A("sid")+"&gid="+w+"&moves="+f.moves,n,p);C()}function p(d){console.log("Retrieve game info failed")}function A(d){d+="=";for(var b=document.cookie.split(";"),a=0;a<b.length;++a){for(var c=b[a];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(d))return c.substring(d.length,c.length)}return""}function D(a){var b=document.getElementById(a+"-player"),c=document.getElementById(a+"-sit-link");
b.removeChild(c);b.appendChild(document.createTextNode("sitting down..."));t("/gameinfo","uid="+l+"&sid="+A("sid")+"&gid="+w+"&sit="+a,n,p)}function u(a,b,c,e,f){var h=document.createElement("a");h.id=a;b&&(h.className=b);h.href=c;e&&(h.onclick=e);h.appendChild(document.createTextNode(f));return h}function y(){removeAllChildren("red-player");removeAllChildren("black-player");if(void 0!==f.red&&null!==f.red){var a="";f.red.id==l&&(a=" (you)");document.getElementById("red-player").appendChild(document.createTextNode(f.red.name+
a))}else a=u("red-sit-link",void 0,"#",function(){D("red");return!1},"sit here"),document.getElementById("red-player").appendChild(a);void 0!==f.black&&null!==f.black?(a="",f.black.id==l&&(a=" (you)"),document.getElementById("black-player").appendChild(document.createTextNode(f.black.name+a))):(a=u("black-sit-link",void 0,"#",function(){D("black");return!1},"sit here"),document.getElementById("black-player").appendChild(a))}function h(){var a=document.getElementById("waitingStatus"),b=document.getElementById("playingStatus"),
c=document.getElementById("redWonStatus"),e=document.getElementById("blackWonStatus");a.style.display="none";b.style.display="none";c.style.display="none";e.style.display="none";f.moves.endsWith("R")?c.style.display="inline-block":f.moves.endsWith("B")?e.style.display="inline-block":f.red&&f.black?(b.style.display="inline-block",v.isRedNext()?(E.start(),m.stop()):(m.start(),E.stop())):a.style.display="inline-block"}function z(a,b){var c=document.createElement("td");c.appendChild(b);a.appendChild(c)}
function C(){removeAllChildren("move-history");var a=document.getElementById("move-history"),b=document.createElement("table");b.id="moveHistoryControls";var c=document.createElement("tr");b.appendChild(c);0<v.numMovesShown()?(z(c,u("move-history-first",void 0,"#",function(){v.showMove(0);C();return!1},"first")),z(c,u("move-history-prev",void 0,"#",function(){v.showMove(v.numMovesShown()-1);C();return!1},"prev"))):(z(c,document.createTextNode("first")),z(c,document.createTextNode("prev")));z(c,document.createTextNode(""+
v.numMovesShown()+" / "+v.numMoves()));v.numMovesShown()<v.numMoves()?(z(c,u("move-history-next",void 0,"#",function(){v.showMove(v.numMovesShown()+1);C();return!1},"next")),z(c,u("move-history-last",void 0,"#",function(){v.showMove(v.numMoves());C();return!1},"last"))):(z(c,document.createTextNode("next")),z(c,document.createTextNode("last")));a.appendChild(b);b=document.createElement("div");b.id="moveHistoryFork";b.appendChild(u("move-history-fork-link",void 0,"/fork/"+w+"/"+v.numMovesShown().toString(),
void 0,"fork"));b.appendChild(document.createTextNode(" this game from here"));a.appendChild(b)}function F(){y();var a="r";f.black&&f.black.id==l&&(a="b");var b=f.black&&f.black.id==l||f.red&&f.red.id==l;v.setState(a,!(f.red&&f.black&&!f.moves.endsWith("R")&&!f.moves.endsWith("B"))||!b,q(f.moves));h();C()}var E,m,v,B=0,e=0,c=[];(function(){E=new Stopwatch("redStopwatch");m=new Stopwatch("blackStopwatch");window.setInterval(function(){E.tick();m.tick()},6E4/E.frequency());v=new Board(a,!1);F();window.setInterval(function(){x("GET",
"/gameinfo?gid="+w,B,void 0,void 0,n,p)},1E3)})()}document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,gameInfo)};

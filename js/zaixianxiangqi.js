var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(v){return 8<=v}function Move(v,l,e,y,q,m){this.i1=v;this.j1=l;this.i2=e;this.j2=y;this.piece=q||PIECE_NONE;this.capture=m||PIECE_NONE}
function Chess(){function v(){return 0==z.length%2}function l(b){return 8<=b?b-8:b}function e(){p=[];z=[];for(var b=0;10>b;++b)for(p.push([]),j=0;9>j;++j)p[b].push(0);b="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=b.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var d=0;for(k=0;k<b[i].length;++k){if(9<=d)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var g=b[i][k];if("0"<=g&&"9">=g)d+=parseInt(b[i][k],10);else{var g=p[i],H=d,h=b[i][k],a=h==h.toLowerCase(),h=h.toLowerCase(),c=0;"k"==h?c=1:"a"==h?c=2:"e"==h?c=3:"h"==h?c=4:"r"==h?c=5:"c"==h?c=6:"p"==h&&(c=7);a||(c+=8);g[H]=c;++d}}}}function y(b,d,g,h){z.push(new Move(b,d,g,h,p[b][d],p[g][h]));p[g][h]=p[b][d];p[b][d]=0;return z[z.length-1]}function q(){var b=z.pop();p[b.i1][b.j1]=p[b.i2][b.j2];p[b.i2][b.j2]=b.capture}function m(b,d){return 0<=b&&10>b&&0<=d&&9>d}function u(b,d){return 3<=d&&5>=d&&
(0<=b&&2>=b||7<=b&&9>=b)}function a(b,d){var g=[];for(r=0;4>r;++r)u(b+A[r],d+h[r])&&g.push(new Move(b,d,b+A[r],d+h[r]));for(delta=-1;1>=delta;delta+=2)for(ii=b+delta;0<=ii&&10>ii&&(l(p[ii][d])==PIECE_K&&g.push(new Move(b,d,ii,d)),0==p[ii][d]);ii+=delta);return g}function n(b,d){var g=[];for(r=0;4>r;++r)u(b+w[r],d+f[r])&&g.push(new Move(b,d,b+w[r],d+f[r]));return g}function B(b,d){var g=[];for(r=0;4>r;++r)m(b+2*w[r],d+2*f[r])&&0==p[b+w[r]][d+f[r]]&&4<b+w[r]&&g.push(new Move(b,d,b+2*w[r],d+2*f[r]));
return g}function D(b,d){var g=[];for(r=0;4>r;++r)!m(b+2*w[r],d+2*f[r])||0!=p[b+w[r]][d+f[r]]||4<b+w[r]||g.push(new Move(b,d,b+2*w[r],d+2*f[r]));return g}function t(b,d){var g=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(h){m(b+h[0],d+h[1])&&0==p[b+h[2]][d+h[3]]&&g.push(new Move(b,d,b+h[0],d+h[1]))});return g}function x(b,d){var g=[];for(r=0;4>r;++r){var a,c;a=b+A[r];for(c=d+h[r];m(a,c)&&(g.push(new Move(b,d,a,c)),0==p[a][c]);a+=
A[r],c+=h[r]);}return g}function c(b,d){var g=[];for(r=0;4>r;++r){var a,c,w=!1;a=b+A[r];for(c=d+h[r];m(a,c);a+=A[r],c+=h[r])if(!w&&0==p[a][c])g.push(new Move(b,d,a,c));else if(!w&&0!=p[a][c])w=!0;else if(w&&0!=p[a][c]){g.push(new Move(b,d,a,c));break}}return g}function E(b,d){var g=[];4<b?g.push(new Move(b,d,b-1,d)):(m(b-1,d)&&g.push(new Move(b,d,b-1,d)),m(b,d-1)&&g.push(new Move(b,d,b,d-1)),m(b,d+1)&&g.push(new Move(b,d,b,d+1)));return g}function C(b,d){var g=[];4<b?(m(b+1,d)&&g.push(new Move(b,
d,b+1,d)),m(b,d-1)&&g.push(new Move(b,d,b,d-1)),m(b,d+1)&&g.push(new Move(b,d,b,d+1))):g.push(new Move(b,d,b+1,d));return g}function F(b,d,g){var h=l(p[b][d]),w=isRedPiece(p[b][d]),f=[];1==h?f=a(b,d):2==h?f=n(b,d):3==h?f=w?B(b,d):D(b,d):4==h?f=t(b,d):5==h?f=x(b,d):6==h?f=c(b,d):7==h&&(f=w?E(b,d):C(b,d));f.forEach(function(d){0!=p[d.i2][d.j2]&&isRedPiece(p[d.i2][d.j2])==w||g.push(d)})}function G(b){var d=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=p[i][j]&&isRedPiece(p[i][j])==b&&F(i,j,d);return d}this.reset=
e;this.setMoves=function(b){var d=z;e();for(var g=!0,h=0,a=0;a<b.length;++a)y(b[a][0],b[a][1],b[a][2],b[a][3]),g&&d.length>a&&d[a].i1==b[a][0]&&d[a].j1==b[a][1]&&d[a].i2==b[a][2]&&d[a].j2==b[a][3]?++h:g=!1;return h};this.move=y;this.checkMove=function(b,d,g,h){var a=v();if(!G(a).find(function(a,c,w){return a.i1==b&&a.j1==d&&a.i2==g&&a.j2==h}))return!1;if(p[g][h]==(a?PIECE_BK:PIECE_RK))return!0;var c=!1;y(b,d,g,h);G(!a).find(function(d,b,g){return p[d.i2][d.j2]==(a?PIECE_RK:PIECE_BK)})&&(c=!0);q();
return!c};this.moveHistory=function(){for(var b=[],d=0;d<z.length;++d)b.push(z[d]);return b};this.pieceAt=function(b,d){return p[b][d]};this.isRedNext=v;this.numMoves=function(){return z.length};var p=[],z=[];e();var A=[0,1,0,-1],h=[1,0,-1,0],w=[1,1,-1,-1],f=[1,-1,-1,1]};function removeAllChildren(v){for(v=document.getElementById(v);v.lastChild;)v.removeChild(v.lastChild)}
function BoardUI(v){function l(){return document.getElementById("board")}function e(h,a){A&&(a=8-a);return p/2+a*p}function y(a,c){A&&(a=9-a);return 5>c?p/2+a*p:p/2+a*p+z}function q(a,c,f,b,d,g){var n=document.createElementNS(C,"line");n.setAttribute("x1",a);n.setAttribute("y1",c);n.setAttribute("x2",f);n.setAttribute("y2",b);n.setAttribute("class",d);g&&(n.id=g);return n}function m(a,c,f,b,d){var g=e(a,c);a=y(a,c);c=document.createElementNS(C,"circle");c.setAttribute("cx",g);c.setAttribute("cy",
a);c.setAttribute("r",f);c.setAttribute("class",b);d&&(c.id=d);return c}function u(a,c){return"abcdefghi"[c]+(9-a).toString()}function a(a,c,f,b,d){D(c,f);var g=m(c,f,23,"piece-outer","piece-outer-"+u(c,f)),n=m(c,f,20,"piece-inner","piece-inner-"+u(c,f));d=d?G[b]:F[b];var E="piece-text-"+u(c,f),p=e(c,f);c=y(c,f);f=document.createElementNS(C,"text");f.style.fontFamily="Roboto,monospace";f.style.fontSize=24;f.setAttribute("text-anchor","middle");f.setAttribute("alignment-baseline","central");f.setAttribute("dominant-baseline",
"middle");f.setAttribute("x",p);f.setAttribute("y",c);f.appendChild(document.createTextNode(d));f.setAttribute("class","piece-text");f.userSelect="none";E&&(f.id=E);isRedPiece(b)?(g.setAttribute("stroke","red"),n.style.stroke="red",f.style.fill="red"):(g.style.stroke="black",n.style.stroke="black",f.style.fill="black");g.style.strokeWidth=2;n.style.strokeWidth=2;g.style.fill="white";n.style.fillOpacity=0;a.appendChild(g);a.appendChild(n);a.appendChild(f)}function n(a,c){return function(){v(a,c)}}
function B(a,c){var f=m(a,c,23,"piece-cover","piece-cover-"+u(a,c));f.style.strokeWidth=0;f.style.fillOpacity=0;f.userSelect="none";f.onmousedown=n(a,c);f.touchend=f.onmousedown;t(f)}function D(a,c){var f="piece-cover-"+u(a,c);null!=document.getElementById(f)&&x(f)}function t(a){l().appendChild(a)}function x(a){l().removeChild(document.getElementById(a))}function c(a,c,f,b){var d;d=e(a,c);a=y(a,c);c=e(f,b);f=y(f,b);d=q(d,a,c,f,"grid",void 0);d.style.strokeWidth=1;d.style.stroke="gray";t(d)}function E(a){A=
a;removeAllChildren("board");for(i=0;9>i;++i)c(0,i,4,i),0!=i&&8!=i||c(4,i,5,i),c(5,i,9,i);for(i=0;10>i;++i)c(i,0,i,8);c(0,3,2,5);c(0,5,2,3);c(7,3,9,5);c(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)B(i,j)}this.reset=E;this.drawPieceWithCover=function(c,n,f,b){a(l(),c,n,f,b);B(c,n)};this.erasePiece=function(a,c){D(a,c);x("piece-text-"+u(a,c));x("piece-inner-"+u(a,c));x("piece-outer-"+u(a,c));B(a,c)};this.drawColorIndicator=function(c,n){var f=1;n&&(f+=8);a(c,0,0,f,!1)};this.highlightSquare=function(a,
c){var f=e(a,c),b=y(a,c),d=p/6;for(a=-1;1>=a;a+=2){var g=q(f-23,b+23*a,f-23+d,b+23*a,"highlighter",void 0);g.style.strokeWidth=2;g.style.stroke="blue";t(g);g=q(f+23-d,b+23*a,f+23,b+23*a,"highlighter",void 0);g.style.strokeWidth=2;g.style.stroke="blue";t(g)}for(a=-1;1>=a;a+=2)g=q(f+23*a,b-23,f+23*a,b-23+d,"highlighter",void 0),g.style.strokeWidth=2,g.style.stroke="blue",t(g),g=q(f+23*a,b+23-d,f+23*a,b+23,"highlighter",void 0),g.style.strokeWidth=2,g.style.stroke="blue",t(g)};this.eraseHighlights=function(){for(var a=
l().getElementsByClassName("highlighter");0<a.length;)l().removeChild(a[0])};var C="http://www.w3.org/2000/svg",F=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),G=" \u5c07 \u58eb \u8c61 \ud83d\udc34 \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \ud83e\udd84 \u4fe5 \u70ae \u5175".split(" "),p=50,z=0,A=!1;E(!1)};function Board(v,l){function e(){for(var c=0;10>c;++c)for(var e=0;9>e;++e)a.pieceAt(c,e)!=PIECE_NONE&&n.drawPieceWithCover(c,e,a.pieceAt(c,e),!1);x=a.numMoves()}function y(c){c=Math.max(0,c);c=Math.min(a.numMoves(),c);if(c!=x){var n=a.moveHistory();if(c>x)for(var e=x;e<c;++e)m(n[e]);else for(e=x-1;e>=c;--e)0<e?u(n[e],n[e-1]):u(n[e],null);x=c}}function q(a){return a==PIECE_NONE?!1:"r"==B?isRedPiece(a):"b"==B?!isRedPiece(a):!1}function m(a){n.erasePiece(a.i1,a.j1);var e=!1;a.capture&&(n.erasePiece(a.i2,
a.j2),l&&(e=!0));n.drawPieceWithCover(a.i2,a.j2,a.piece,e);n.eraseHighlights();n.highlightSquare(a.i1,a.j1);n.highlightSquare(a.i2,a.j2);t=null}function u(a,e){n.drawPieceWithCover(a.i1,a.j1,a.piece,!1);n.erasePiece(a.i2,a.j2);a.capture&&n.drawPieceWithCover(a.i2,a.j2,a.capture,!1);n.eraseHighlights();e&&(n.highlightSquare(e.i1,e.j1),n.highlightSquare(e.i2,e.j2));t=null}this.setState=function(c,l,q){c!=B&&(B=c,n.reset("b"==c),a.reset(),e(),t=null);D=l;c=a.moveHistory();q=a.setMoves(q);l=x;x==c.length&&
(l=a.numMoves());for(l=Math.min(l,a.numMoves());x>q;--x){var m=x-1;0<m?u(c[m],c[m-1]):u(c[m],null)}y(l)};this.showMove=y;this.isRedNext=function(){return a.isRedNext()};this.numMoves=function(){return a.numMoves()};this.numMovesShown=function(){return x};var a=new Chess,n=new BoardUI(function(c,e){if(!D){var l=a.isRedNext();if(("r"==B&&l||"b"==B&&!l)&&x==a.numMoves())if(t)if(a.checkMove(t[0],t[1],c,e)){var l=t[0],u=t[1];m(a.move(l,u,c,e));++x;v(l,u,c,e)}else q(a.pieceAt(c,e))&&(n.eraseHighlights(),
t=[c,e],n.highlightSquare(c,e));else q(a.pieceAt(c,e))&&(n.eraseHighlights(),t=[c,e],n.highlightSquare(c,e))}}),B="r",D=!0,t=null,x=0;n.drawColorIndicator(document.getElementById("redIndicator"),!0);n.drawColorIndicator(document.getElementById("blackIndicator"),!1);e()};function Stopwatch(v){function l(){return document.getElementById(v)}function e(){if(m){var a=document.getElementById(v+"Hand"),e=.8*q,l=u/y*2*Math.PI;a.setAttribute("x2",e*Math.sin(l));a.setAttribute("y2",-e*Math.cos(l));++u;u%=y}}this.start=function(){m||(m=!0,u=0,e(),l().style.visibility="visible")};this.stop=function(){m=!1;l().style.visibility="hidden"};this.tick=e;this.frequency=function(){return y};var y=250,q=20,m=!1,u=0;(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",
"circle");a.setAttribute("cx",0);a.setAttribute("cy",0);a.setAttribute("r",q);a.style.stroke="black";a.style.strokeWidth=2;a.style.fillOpacity=0;l().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0);a.setAttribute("y1",-q);a.setAttribute("x2",0);a.setAttribute("y2",-q-6);a.style.strokeWidth=4;a.style.stroke="black";l().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",-3);a.setAttribute("y",-q-6-4);
a.setAttribute("width",6);a.setAttribute("height",4);a.style.strokeWidth=.5;a.style.stroke="black";a.style.fillOpacity=0;l().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",0);a.setAttribute("cy",-q-6-2);a.setAttribute("r",6);a.style.stroke="black";a.style.strokeWidth=1;a.style.fillOpacity=0;l().appendChild(a);for(a=-3;3>=a;a+=1){var e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1",a);e.setAttribute("y1",-q-6-
4);e.setAttribute("x2",a);e.setAttribute("y2",-q-6);e.style.strokeWidth=.2;e.style.stroke="black";l().appendChild(e)}for(a=0;12>a;++a){var e=document.createElementNS("http://www.w3.org/2000/svg","line"),m=a/12*2*Math.PI,u=q,t=.7*q;e.setAttribute("x1",u*Math.sin(m));e.setAttribute("y1",-u*Math.cos(m));e.setAttribute("x2",t*Math.sin(m));e.setAttribute("y2",-t*Math.cos(m));e.style.strokeWidth=1;e.style.stroke="black";l().appendChild(e)}for(a=0;60>a;++a)e=document.createElementNS("http://www.w3.org/2000/svg",
"line"),m=a/60*2*Math.PI,u=q,t=.85*q,e.setAttribute("x1",u*Math.sin(m)),e.setAttribute("y1",-u*Math.cos(m)),e.setAttribute("x2",t*Math.sin(m)),e.setAttribute("y2",-t*Math.cos(m)),e.style.strokeWidth=.5,e.style.stroke="black",l().appendChild(e);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.id=v+"Hand";a.setAttribute("x1",0);a.setAttribute("y1",0);a.setAttribute("x2",0);a.setAttribute("y2",.8*-q);a.style.strokeWidth=1;a.style.stroke="black";l().appendChild(a);l().style.visibility=
"hidden"})()};String.prototype.endsWith||(String.prototype.endsWith=function(v,l){var e=this.toString();if(void 0===l||l>e.length)l=e.length;l-=v.length;e=e.indexOf(v,l);return-1!==e&&e===l});
function Game(v,l,e){function y(a,g,c,e,h,l,n){var m=new XMLHttpRequest;m.onreadystatechange=function(){if(4==m.readyState){var a=b.indexOf(c);if(-1!=a){b.splice(a,1);for(var d=w+1;d<=f;++d)if(a=b.indexOf(d),-1==a)w=d;else break;requestResolved=!0}else requestResolved=!1;200<=m.status&&299>=m.status?requestResolved||f==c?l(m.responseText):console.log("Dropped response from an old request."):n&&n(m.responseText)}};m.open(a,g,!0);e&&m.setRequestHeader("Content-type",e);h?m.send(h):m.send()}function q(a,
g,c,e){++f;b.push(f);y("POST",a,f,"application/x-www-form-urlencoded; charset=UTF-8",g,c,e)}function m(a){if("fail"==a)alert("Operation failed");else try{var b=JSON.parse(a);b.gameinfo&&("success"!==b.status&&console.log("last update failed"),b=b.gameinfo);e=b;G()}catch(c){console.log("Unrecognized server response: "+a)}}function u(a){a=a.split("/");for(var b=[],c=1;c<a.length;++c){var e=a[c];if("R"==e||"B"==e)break;b.push([parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10)])}return b}
function a(a,b,c,f){var h=e;a=[a,b,c,f];h.moves+="/"+(""+a[0]+a[1]+a[2]+a[3]);E();q("/gameinfo","uid="+l+"&sid="+B("sid")+"&gid="+v+"&moves="+e.moves,m,n);F()}function n(a){console.log("Retrieve game info failed")}function B(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;++c){for(var e=b[c];" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(a))return e.substring(a.length,e.length)}return""}function D(a){var b=document.getElementById(a+"-player"),c=document.getElementById(a+"-sit-link");
b.removeChild(c);b.appendChild(document.createTextNode("sitting down..."));q("/gameinfo","uid="+l+"&sid="+B("sid")+"&gid="+v+"&sit="+a,m,n)}function t(a,b,c,e,f){var h=document.createElement("a");h.id=a;b&&(h.className=b);h.href=c;e&&(h.onclick=e);h.appendChild(document.createTextNode(f));return h}function x(a){var b=document.createElement("sub");b.className="hint-you";a?b.appendChild(document.createTextNode(" ")):b.appendChild(document.createTextNode(" you"));return b}function c(){removeAllChildren("red-player");
removeAllChildren("black-player");if(void 0!==e.red&&null!==e.red){var a=document.getElementById("red-player"),b=document.createElement("span");b.appendChild(document.createTextNode(e.red.name));a.appendChild(b);a.appendChild(x(e.red.id!=l))}else b=t("red-sit-link","sit-link","#",function(){D("red");return!1},"sit here"),document.getElementById("red-player").appendChild(b);void 0!==e.black&&null!==e.black?(a=document.getElementById("black-player"),b=document.createElement("span"),b.appendChild(document.createTextNode(e.black.name)),
a.appendChild(b),a.appendChild(x(e.black.id!=l))):(b=t("black-sit-link","sit-link","#",function(){D("black");return!1},"sit here"),document.getElementById("black-player").appendChild(b))}function E(){var a=document.getElementById("waitingStatus"),b=document.getElementById("playingStatus"),c=document.getElementById("redWonStatus"),f=document.getElementById("blackWonStatus");a.style.display="none";b.style.display="none";c.style.display="none";f.style.display="none";e.moves.endsWith("R")?c.style.display=
"inline-block":e.moves.endsWith("B")?f.style.display="inline-block":e.red&&e.black?(b.style.display="inline-block",h.isRedNext()?(z.start(),A.stop()):(A.start(),z.stop())):a.style.display="inline-block"}function C(a,b){var c=document.createElement("td");c.appendChild(b);a.appendChild(c)}function F(){removeAllChildren("move-history");var a=document.getElementById("move-history"),b=document.createElement("table");b.id="moveHistoryControls";var c=document.createElement("tr");b.appendChild(c);0<h.numMovesShown()?
(C(c,t("move-history-first",void 0,"#",function(){h.showMove(0);F();return!1},"first")),C(c,t("move-history-prev",void 0,"#",function(){h.showMove(h.numMovesShown()-1);F();return!1},"prev"))):(C(c,document.createTextNode("first")),C(c,document.createTextNode("prev")));C(c,document.createTextNode(""+h.numMovesShown()+" / "+h.numMoves()));h.numMovesShown()<h.numMoves()?(C(c,t("move-history-next",void 0,"#",function(){h.showMove(h.numMovesShown()+1);F();return!1},"next")),C(c,t("move-history-last",void 0,
"#",function(){h.showMove(h.numMoves());F();return!1},"last"))):(C(c,document.createTextNode("next")),C(c,document.createTextNode("last")));a.appendChild(b);b=document.createElement("div");b.id="moveHistoryFork";b.appendChild(t("move-history-fork-link",void 0,"/fork/"+v+"/"+h.numMovesShown().toString(),void 0,"fork"));b.appendChild(document.createTextNode(" this game from here"));a.appendChild(b)}function G(){c();var a="r";e.black&&e.black.id==l&&(a="b");var b=e.black&&e.black.id==l||e.red&&e.red.id==
l;h.setState(a,!(e.red&&e.black&&!e.moves.endsWith("R")&&!e.moves.endsWith("B"))||!b,u(e.moves));E();F()}function p(){var a=document.getElementById("board");.81*window.innerHeight<=window.innerWidth?(a.style.removeProperty("width"),a.style.height="90vh"):(a.style.width="100vw",a.style.removeProperty("height"))}var z,A,h,w=0,f=0,b=[];(function(){z=new Stopwatch("redStopwatch");A=new Stopwatch("blackStopwatch");window.setInterval(function(){z.tick();A.tick()},6E4/z.frequency());window.onload=p;window.onresize=
p;h=new Board(a,!1);G();window.setInterval(function(){y("GET","/gameinfo?gid="+v,w,void 0,void 0,m,n)},1E3)})()}document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,gameInfo)};

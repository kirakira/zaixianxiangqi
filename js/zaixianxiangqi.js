var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(t){return 8<=t}function Move(t,h,f,A,C,p){this.i1=t;this.j1=h;this.i2=f;this.j2=A;this.piece=C||PIECE_NONE;this.capture=p||PIECE_NONE}
function Chess(){function t(){return 0==y.length%2}function h(b){return 8<=b?b-8:b}function f(){n=[];y=[];for(var b=0;10>b;++b)for(n.push([]),j=0;9>j;++j)n[b].push(0);b="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=b.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var l=0;for(k=0;k<b[i].length;++k){if(9<=l)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var a=b[i][k];if("0"<=a&&"9">=a)l+=parseInt(b[i][k],10);else{var a=n[i],d=l,e=b[i][k],c=e==e.toLowerCase(),e=e.toLowerCase(),g=0;"k"==e?g=1:"a"==e?g=2:"e"==e?g=3:"h"==e?g=4:"r"==e?g=5:"c"==e?g=6:"p"==e&&(g=7);c||(g+=8);a[d]=g;++l}}}}function A(b,l,a,e){y.push(new Move(b,l,a,e,n[b][l],n[a][e]));n[a][e]=n[b][l];n[b][l]=0;return y[y.length-1]}function C(){var b=y.pop();n[b.i1][b.j1]=n[b.i2][b.j2];n[b.i2][b.j2]=b.capture}function p(b,l){return 0<=b&&10>b&&0<=l&&9>l}function x(b,l){return 3<=l&&5>=l&&
(0<=b&&2>=b||7<=b&&9>=b)}function w(b,l){var e=[];for(r=0;4>r;++r)x(b+d[r],l+a[r])&&e.push(new Move(b,l,b+d[r],l+a[r]));for(delta=-1;1>=delta;delta+=2)for(ii=b+delta;0<=ii&&10>ii&&(h(n[ii][l])==PIECE_K&&e.push(new Move(b,l,ii,l)),0==n[ii][l]);ii+=delta);return e}function u(b,l){var a=[];for(r=0;4>r;++r)x(b+e[r],l+g[r])&&a.push(new Move(b,l,b+e[r],l+g[r]));return a}function D(b,l){var a=[];for(r=0;4>r;++r)p(b+2*e[r],l+2*g[r])&&0==n[b+e[r]][l+g[r]]&&4<b+e[r]&&a.push(new Move(b,l,b+2*e[r],l+2*g[r]));
return a}function B(b,l){var a=[];for(r=0;4>r;++r)!p(b+2*e[r],l+2*g[r])||0!=n[b+e[r]][l+g[r]]||4<b+e[r]||a.push(new Move(b,l,b+2*e[r],l+2*g[r]));return a}function v(b,l){var a=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(e){p(b+e[0],l+e[1])&&0==n[b+e[2]][l+e[3]]&&a.push(new Move(b,l,b+e[0],l+e[1]))});return a}function m(b,l){var e=[];for(r=0;4>r;++r){var g,c;g=b+d[r];for(c=l+a[r];p(g,c)&&(e.push(new Move(b,l,g,c)),0==n[g][c]);g+=
d[r],c+=a[r]);}return e}function c(b,l){var e=[];for(r=0;4>r;++r){var g,c,z=!1;g=b+d[r];for(c=l+a[r];p(g,c);g+=d[r],c+=a[r])if(!z&&0==n[g][c])e.push(new Move(b,l,g,c));else if(!z&&0!=n[g][c])z=!0;else if(z&&0!=n[g][c]){e.push(new Move(b,l,g,c));break}}return e}function z(b,l){var a=[];4<b?a.push(new Move(b,l,b-1,l)):(p(b-1,l)&&a.push(new Move(b,l,b-1,l)),p(b,l-1)&&a.push(new Move(b,l,b,l-1)),p(b,l+1)&&a.push(new Move(b,l,b,l+1)));return a}function E(b,a){var e=[];4<b?(p(b+1,a)&&e.push(new Move(b,
a,b+1,a)),p(b,a-1)&&e.push(new Move(b,a,b,a-1)),p(b,a+1)&&e.push(new Move(b,a,b,a+1))):e.push(new Move(b,a,b+1,a));return e}function F(b,a,e){var g=h(n[b][a]),d=isRedPiece(n[b][a]),f=[];1==g?f=w(b,a):2==g?f=u(b,a):3==g?f=d?D(b,a):B(b,a):4==g?f=v(b,a):5==g?f=m(b,a):6==g?f=c(b,a):7==g&&(f=d?z(b,a):E(b,a));f.forEach(function(b){0!=n[b.i2][b.j2]&&isRedPiece(n[b.i2][b.j2])==d||e.push(b)})}function q(b){var a=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=n[i][j]&&isRedPiece(n[i][j])==b&&F(i,j,a);return a}this.reset=
f;this.setMoves=function(b){var a=y;f();for(var e=!0,g=0,d=0;d<b.length;++d)A(b[d][0],b[d][1],b[d][2],b[d][3]),e&&a.length>d&&a[d].i1==b[d][0]&&a[d].j1==b[d][1]&&a[d].i2==b[d][2]&&a[d].j2==b[d][3]?++g:e=!1;return g};this.move=A;this.checkMove=function(b,a,e,d){var g=t();if(!q(g).find(function(g,c,f){return g.i1==b&&g.j1==a&&g.i2==e&&g.j2==d}))return!1;if(n[e][d]==(g?PIECE_BK:PIECE_RK))return!0;var c=!1;A(b,a,e,d);q(!g).find(function(b,a,e){return n[b.i2][b.j2]==(g?PIECE_RK:PIECE_BK)})&&(c=!0);C();
return!c};this.moveHistory=function(){for(var b=[],a=0;a<y.length;++a)b.push(y[a]);return b};this.pieceAt=function(b,a){return n[b][a]};this.isRedNext=t;this.numMoves=function(){return y.length};var n=[],y=[];f();var d=[0,1,0,-1],a=[1,0,-1,0],e=[1,1,-1,-1],g=[1,-1,-1,1]};function removeAllChildren(t){for(t=document.getElementById(t);t.lastChild;)t.removeChild(t.lastChild)}
function BoardUI(t){function h(){return document.getElementById("board")}function f(d,a){y&&(a=8-a);return q/2+a*q}function A(d,a){y&&(d=9-d);return 5>a?q/2+d*q:q/2+d*q+n}function C(d,a,e,g,b,l){var c=document.createElementNS(z,"line");c.setAttribute("x1",d);c.setAttribute("y1",a);c.setAttribute("x2",e);c.setAttribute("y2",g);c.setAttribute("class",b);l&&(c.id=l);return c}function p(d,a,e,g,b){var c=f(d,a);d=A(d,a);a=document.createElementNS(z,"circle");a.setAttribute("cx",c);a.setAttribute("cy",
d);a.setAttribute("r",e);a.setAttribute("class",g);b&&(a.id=b);return a}function x(d,a){return"abcdefghi"[a]+(9-d).toString()}function w(d,a){return function(){t(d,a)}}function u(d,a){var e=p(d,a,23,"piece-cover","piece-cover-"+x(d,a));e.style.strokeWidth=0;e.style.fillOpacity=0;e.onmousedown=w(d,a);e.touchend=e.onmousedown;B(e)}function D(d,a){var e="piece-cover-"+x(d,a);null!=document.getElementById(e)&&v(e)}function B(d){h().appendChild(d)}function v(d){h().removeChild(document.getElementById(d))}
function m(d,a,e,g){var b;b=f(d,a);d=A(d,a);a=f(e,g);e=A(e,g);b=C(b,d,a,e,"grid",void 0);b.style.strokeWidth=1;b.style.stroke="gray";B(b)}function c(d){y=d;removeAllChildren("board");h();for(i=0;9>i;++i)m(0,i,4,i),0!=i&&8!=i||m(4,i,5,i),m(5,i,9,i);for(i=0;10>i;++i)m(i,0,i,8);m(0,3,2,5);m(0,5,2,3);m(7,3,9,5);m(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)u(i,j)}this.reset=c;this.drawPiece=function(d,a,e,g){D(d,a);var b=p(d,a,23,"piece-outer","piece-outer-"+x(d,a)),c=p(d,a,20,"piece-inner","piece-inner-"+
x(d,a));g=g?F[e]:E[e];var n="piece-text-"+x(d,a),m=f(d,a)-12,q=A(d,a)+7.5,h=document.createElementNS(z,"text");h.style.fontSize=24;h.setAttribute("x",m);h.setAttribute("y",q);h.appendChild(document.createTextNode(g));h.setAttribute("class","piece-text");n&&(h.id=n);isRedPiece(e)?(b.setAttribute("stroke","red"),c.style.stroke="red",h.style.fill="red"):(b.style.stroke="black",c.style.stroke="black",h.style.fill="black");b.style.strokeWidth=2;c.style.strokeWidth=2;b.style.fill="white";c.style.fillOpacity=
0;B(b);B(c);B(h);u(d,a)};this.erasePiece=function(d,a){D(d,a);v("piece-text-"+x(d,a));v("piece-inner-"+x(d,a));v("piece-outer-"+x(d,a));u(d,a)};this.highlightSquare=function(d,a){var e=f(d,a),g=A(d,a),b=q/6;for(d=-1;1>=d;d+=2){var c=C(e-23,g+23*d,e-23+b,g+23*d,"highlighter",void 0);c.style.strokeWidth=2;c.style.stroke="blue";B(c);c=C(e+23-b,g+23*d,e+23,g+23*d,"highlighter",void 0);c.style.strokeWidth=2;c.style.stroke="blue";B(c)}for(d=-1;1>=d;d+=2)c=C(e+23*d,g-23,e+23*d,g-23+b,"highlighter",void 0),
c.style.strokeWidth=2,c.style.stroke="blue",B(c),c=C(e+23*d,g+23-b,e+23*d,g+23,"highlighter",void 0),c.style.strokeWidth=2,c.style.stroke="blue",B(c)};this.eraseHighlights=function(){for(var c=h().getElementsByClassName("highlighter");0<c.length;)h().removeChild(c[0])};var z="http://www.w3.org/2000/svg",E=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),F=" \u5c07 \u58eb \u8c61 \ud83d\udc34 \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \ud83e\udd84 \u4fe5 \u70ae \u5175".split(" "),
q=50,n=0,y=!1;c(!1)};function Board(t,h){function f(){for(var c=0;10>c;++c)for(var f=0;9>f;++f)w.pieceAt(c,f)!=PIECE_NONE&&u.drawPiece(c,f,w.pieceAt(c,f),!1);m=w.numMoves()}function A(c){c=Math.max(0,c);c=Math.min(w.numMoves(),c);if(c!=m){var f=w.moveHistory();if(c>m)for(var h=m;h<c;++h)p(f[h]);else for(h=m-1;h>=c;--h)0<h?x(f[h],f[h-1]):x(f[h],null);m=c}}function C(c){return c==PIECE_NONE?!1:"r"==D?isRedPiece(c):"b"==D?!isRedPiece(c):!1}function p(c){u.erasePiece(c.i1,c.j1);var f=!1;c.capture&&(u.erasePiece(c.i2,c.j2),
h&&(f=!0));u.drawPiece(c.i2,c.j2,c.piece,f);u.eraseHighlights();u.highlightSquare(c.i1,c.j1);u.highlightSquare(c.i2,c.j2);v=null}function x(c,f){u.drawPiece(c.i1,c.j1,c.piece,!1);u.erasePiece(c.i2,c.j2);c.capture&&u.drawPiece(c.i2,c.j2,c.capture,!1);u.eraseHighlights();f&&(u.highlightSquare(f.i1,f.j1),u.highlightSquare(f.i2,f.j2));v=null}this.setState=function(c,h,t){c!=D&&(D=c,u.reset("b"==c),w.reset(),f(),v=null);B=h;c=w.moveHistory();t=w.setMoves(t);h=m;m==c.length&&(h=w.numMoves());for(h=Math.min(h,
w.numMoves());m>t;--m){var p=m-1;0<p?x(c[p],c[p-1]):x(c[p],null)}A(h)};this.showMove=A;this.isRedNext=function(){return w.isRedNext()};this.numMoves=function(){return w.numMoves()};this.numMovesShown=function(){return m};var w=new Chess,u=new BoardUI(function(c,f){if(!B){var h=w.isRedNext();if(("r"==D&&h||"b"==D&&!h)&&m==w.numMoves())if(v)if(w.checkMove(v[0],v[1],c,f)){var h=v[0],x=v[1];p(w.move(h,x,c,f));++m;t(h,x,c,f)}else C(w.pieceAt(c,f))&&(u.eraseHighlights(),v=[c,f],u.highlightSquare(c,f));
else C(w.pieceAt(c,f))&&(u.eraseHighlights(),v=[c,f],u.highlightSquare(c,f))}}),D="r",B=!0,v=null,m=0;f()};String.prototype.endsWith||(String.prototype.endsWith=function(t,h){var f=this.toString();if(void 0===h||h>f.length)h=f.length;h-=t.length;f=f.indexOf(t,h);return-1!==f&&f===h});
function Game(t,h,f){function A(a,e,c,b,f,h,p){var m=new XMLHttpRequest;m.onreadystatechange=function(){if(4==m.readyState){var a=d.indexOf(c);if(-1!=a){d.splice(a,1);for(var b=n+1;b<=y;++b)if(a=d.indexOf(b),-1==a)n=b;else break;requestResolved=!0}else requestResolved=!1;200<=m.status&&299>=m.status?requestResolved||y==c?h(m.responseText):console.log("Dropped response from an old request."):p&&p(m.responseText)}};m.open(a,e,!0);b&&m.setRequestHeader("Content-type",b);f?m.send(f):m.send()}function C(a,
e,c,b){++y;d.push(y);A("POST",a,y,"application/x-www-form-urlencoded; charset=UTF-8",e,c,b)}function p(a){if("fail"==a)alert("Operation failed");else try{var c=JSON.parse(a);c.gameinfo&&("success"!==c.status&&console.log("last update failed"),c=c.gameinfo);f=c;F()}catch(d){console.log("Unrecognized server response: "+a)}}function x(a){a=a.split("/");for(var c=[],d=1;d<a.length;++d){var b=a[d];if("R"==b||"B"==b)break;c.push([parseInt(b[0],10),parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10)])}return c}
function w(a,e,d,b){var l=f;a=[a,e,d,b];l.moves+="/"+(""+a[0]+a[1]+a[2]+a[3]);c();C("/gameinfo","sid="+D("sid")+"&gid="+t+"&moves="+f.moves,p,u);E()}function u(a){console.log("Retrieve game info failed")}function D(a){a+="=";for(var c=document.cookie.split(";"),d=0;d<c.length;++d){for(var b=c[d];" "==b.charAt(0);)b=b.substring(1);if(0==b.indexOf(a))return b.substring(a.length,b.length)}return""}function B(a){var c=document.getElementById(a+"-player"),d=document.getElementById(a+"-sit-link");c.removeChild(d);
c.appendChild(document.createTextNode("sitting down..."));C("/gameinfo","sid="+D("sid")+"&gid="+t+"&sit="+a,p,u)}function v(a,c,d,b,f){var h=document.createElement("a");h.id=a;c&&(h.className=c);h.href=d;b&&(h.onclick=b);h.appendChild(document.createTextNode(f));return h}function m(){removeAllChildren("red-player");removeAllChildren("black-player");if(void 0!==f.red&&null!==f.red){var a="";f.red.id==h&&(a=" (you)");document.getElementById("red-player").appendChild(document.createTextNode("Red: "+
f.red.name+a))}else document.getElementById("red-player").appendChild(document.createTextNode("Red: ")),a=v("red-sit-link",void 0,"#",function(){B("red");return!1},"sit here"),document.getElementById("red-player").appendChild(a);void 0!==f.black&&null!==f.black?(a="",f.black.id==h&&(a=" (you)"),document.getElementById("black-player").appendChild(document.createTextNode("Black: "+f.black.name+a))):(document.getElementById("black-player").appendChild(document.createTextNode("Black: ")),a=v("black-sit-link",
void 0,"#",function(){B("black");return!1},"sit here"),document.getElementById("black-player").appendChild(a))}function c(){removeAllChildren("status");var a=document.getElementById("status");f.moves.endsWith("R")?a.appendChild(document.createTextNode("Red won")):f.moves.endsWith("B")?a.appendChild(document.createTextNode("Black won")):f.red&&f.black?q.isRedNext()?a.appendChild(document.createTextNode("Red to go")):a.appendChild(document.createTextNode("Black to go")):a.appendChild(document.createTextNode("Waiting for players to join..."))}
function z(a,c){var d=document.createElement("td");d.appendChild(c);a.appendChild(d)}function E(){removeAllChildren("move-history");var a=document.getElementById("move-history"),c=document.createElement("table");c.id="moveHistoryControls";var d=document.createElement("tr");c.appendChild(d);0<q.numMovesShown()?(z(d,v("move-history-first",void 0,"#",function(){q.showMove(0);E();return!1},"first")),z(d,v("move-history-prev",void 0,"#",function(){q.showMove(q.numMovesShown()-1);E();return!1},"prev"))):
(z(d,document.createTextNode("first")),z(d,document.createTextNode("prev")));z(d,document.createTextNode(""+q.numMovesShown()+" / "+q.numMoves()));q.numMovesShown()<q.numMoves()?(z(d,v("move-history-next",void 0,"#",function(){q.showMove(q.numMovesShown()+1);E();return!1},"next")),z(d,v("move-history-last",void 0,"#",function(){q.showMove(q.numMoves());E();return!1},"last"))):(z(d,document.createTextNode("next")),z(d,document.createTextNode("last")));a.appendChild(c);c=document.createElement("div");
c.id="moveHistoryFork";c.appendChild(v("move-history-fork-link",void 0,"/fork/"+t+"/"+q.numMovesShown().toString(),void 0,"fork"));c.appendChild(document.createTextNode(" this game from here"));a.appendChild(c)}function F(){m();var a="r";f.black&&f.black.id==h&&(a="b");var d=f.black&&f.black.id==h||f.red&&f.red.id==h;q.setState(a,!(f.red&&f.black&&!f.moves.endsWith("R")&&!f.moves.endsWith("B"))||!d,x(f.moves));c();E()}var q,n=0,y=0,d=[];(function(){q=new Board(w,!1);F();window.setInterval(function(){A("GET",
"/gameinfo?gid="+t,n,void 0,void 0,p,u)},1E3)})()}document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,gameInfo)};

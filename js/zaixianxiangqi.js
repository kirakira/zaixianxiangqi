var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(u){return 8<=u}function Move(u,y,e,A,C,v){this.i1=u;this.j1=y;this.i2=e;this.j2=A;this.piece=C||PIECE_NONE;this.capture=v||PIECE_NONE}
function Chess(){function u(){return 0==c.length%2}function y(d){return 8<=d?d-8:d}function e(){l=[];c=[];for(var d=0;10>d;++d)for(l.push([]),j=0;9>j;++j)l[d].push(0);d="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=d.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var p=0;for(k=0;k<d[i].length;++k){if(9<=p)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var a=d[i][k];if("0"<=a&&"9">=a)p+=parseInt(d[i][k],10);else{var a=l[i],b=p,m=d[i][k],g=m==m.toLowerCase(),m=m.toLowerCase(),f=0;"k"==m?f=1:"a"==m?f=2:"e"==m?f=3:"h"==m?f=4:"r"==m?f=5:"c"==m?f=6:"p"==m&&(f=7);g||(f+=8);a[b]=f;++p}}}}function A(d,p,a,m){c.push(new Move(d,p,a,m,l[d][p],l[a][m]));l[a][m]=l[d][p];l[d][p]=0;return c[c.length-1]}function C(){var d=c.pop();l[d.i1][d.j1]=l[d.i2][d.j2];l[d.i2][d.j2]=d.capture}function v(d,p){return 0<=d&&10>d&&0<=p&&9>p}function q(d,p){return 3<=p&&5>=p&&
(0<=d&&2>=d||7<=d&&9>=d)}function z(d,p){var c=[];for(r=0;4>r;++r)q(d+a[r],p+m[r])&&c.push(new Move(d,p,d+a[r],p+m[r]));for(delta=-1;1>=delta;delta+=2)for(ii=d+delta;0<=ii&&10>ii&&(y(l[ii][p])==PIECE_K&&c.push(new Move(d,p,ii,p)),0==l[ii][p]);ii+=delta);return c}function B(d,p){var a=[];for(r=0;4>r;++r)q(d+g[r],p+f[r])&&a.push(new Move(d,p,d+g[r],p+f[r]));return a}function D(d,a){var c=[];for(r=0;4>r;++r)v(d+2*g[r],a+2*f[r])&&0==l[d+g[r]][a+f[r]]&&4<d+g[r]&&c.push(new Move(d,a,d+2*g[r],a+2*f[r]));
return c}function w(d,a){var c=[];for(r=0;4>r;++r)!v(d+2*g[r],a+2*f[r])||0!=l[d+g[r]][a+f[r]]||4<d+g[r]||c.push(new Move(d,a,d+2*g[r],a+2*f[r]));return c}function t(d,a){var c=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(m){v(d+m[0],a+m[1])&&0==l[d+m[2]][a+m[3]]&&c.push(new Move(d,a,d+m[0],a+m[1]))});return c}function b(d,p){var c=[];for(r=0;4>r;++r){var b,g;b=d+a[r];for(g=p+m[r];v(b,g)&&(c.push(new Move(d,p,b,g)),0==l[b][g]);b+=
a[r],g+=m[r]);}return c}function x(d,p){var c=[];for(r=0;4>r;++r){var b,g,f=!1;b=d+a[r];for(g=p+m[r];v(b,g);b+=a[r],g+=m[r])if(!f&&0==l[b][g])c.push(new Move(d,p,b,g));else if(!f&&0!=l[b][g])f=!0;else if(f&&0!=l[b][g]){c.push(new Move(d,p,b,g));break}}return c}function h(d,a){var c=[];4<d?c.push(new Move(d,a,d-1,a)):(v(d-1,a)&&c.push(new Move(d,a,d-1,a)),v(d,a-1)&&c.push(new Move(d,a,d,a-1)),v(d,a+1)&&c.push(new Move(d,a,d,a+1)));return c}function F(d,a){var c=[];4<d?(v(d+1,a)&&c.push(new Move(d,
a,d+1,a)),v(d,a-1)&&c.push(new Move(d,a,d,a-1)),v(d,a+1)&&c.push(new Move(d,a,d,a+1))):c.push(new Move(d,a,d+1,a));return c}function n(a,c,m){var g=y(l[a][c]),f=isRedPiece(l[a][c]),e=[];1==g?e=z(a,c):2==g?e=B(a,c):3==g?e=f?D(a,c):w(a,c):4==g?e=t(a,c):5==g?e=b(a,c):6==g?e=x(a,c):7==g&&(e=f?h(a,c):F(a,c));e.forEach(function(a){0!=l[a.i2][a.j2]&&isRedPiece(l[a.i2][a.j2])==f||m.push(a)})}function E(a){var c=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=l[i][j]&&isRedPiece(l[i][j])==a&&n(i,j,c);return c}this.reset=
e;this.setMoves=function(a){var m=c;e();for(var g=!0,b=0,f=0;f<a.length;++f)A(a[f][0],a[f][1],a[f][2],a[f][3]),g&&m.length>f&&m[f].i1==a[f][0]&&m[f].j1==a[f][1]&&m[f].i2==a[f][2]&&m[f].j2==a[f][3]?++b:g=!1;return b};this.move=A;this.checkMove=function(a,c,m,g){var b=u();if(!E(b).find(function(b,f,e){return b.i1==a&&b.j1==c&&b.i2==m&&b.j2==g}))return!1;if(l[m][g]==(b?PIECE_BK:PIECE_RK))return!0;var f=!1;A(a,c,m,g);E(!b).find(function(a,c,d){return l[a.i2][a.j2]==(b?PIECE_RK:PIECE_BK)})&&(f=!0);C();
return!f};this.moveHistory=function(){for(var a=[],b=0;b<c.length;++b)a.push(c[b]);return a};this.pieceAt=function(a,c){return l[a][c]};this.isRedNext=u;this.numMoves=function(){return c.length};var l=[],c=[];e();var a=[0,1,0,-1],m=[1,0,-1,0],g=[1,1,-1,-1],f=[1,-1,-1,1]};function removeAllChildren(u){for(u=document.getElementById(u);u.lastChild;)u.removeChild(u.lastChild)}
function BoardUI(u){function y(){return document.getElementById("board")}function e(c,a){l&&(a=8-a);return n/2+a*n}function A(c,a){l&&(c=9-c);return 5>a?n/2+c*n:n/2+c*n+E}function C(c,a,b,g,f,d){var e=document.createElementNS(h,"line");e.setAttribute("x1",c);e.setAttribute("y1",a);e.setAttribute("x2",b);e.setAttribute("y2",g);e.setAttribute("class",f);d&&(e.id=d);return e}function v(c,a,b,g,f){var d=e(c,a);c=A(c,a);a=document.createElementNS(h,"circle");a.setAttribute("cx",d);a.setAttribute("cy",
c);a.setAttribute("r",b);a.setAttribute("class",g);f&&(a.id=f);return a}function q(c,a){return"abcdefghi"[a]+(9-c).toString()}function z(c,a){return function(){u(c,a)}}function B(c,a){var b=v(c,a,23,"piece-cover","piece-cover-"+q(c,a));b.style.strokeWidth=0;b.style.fillOpacity=0;b.onmousedown=z(c,a);b.touchend=b.onmousedown;w(b)}function D(c,a){var b="piece-cover-"+q(c,a);null!=document.getElementById(b)&&t(b)}function w(c){y().appendChild(c)}function t(c){y().removeChild(document.getElementById(c))}
function b(c,a,b,g){var f;f=e(c,a);c=A(c,a);a=e(b,g);b=A(b,g);f=C(f,c,a,b,"grid",void 0);f.style.strokeWidth=1;f.style.stroke="gray";w(f)}function x(c){l=c;removeAllChildren("board");y();for(i=0;9>i;++i)b(0,i,4,i),0!=i&&8!=i||b(4,i,5,i),b(5,i,9,i);for(i=0;10>i;++i)b(i,0,i,8);b(0,3,2,5);b(0,5,2,3);b(7,3,9,5);b(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)B(i,j)}this.reset=x;this.drawPiece=function(c,a,b){D(c,a);var g=v(c,a,23,"piece-outer","piece-outer-"+q(c,a)),f=v(c,a,20,"piece-inner","piece-inner-"+
q(c,a)),d=F[b],x="piece-text-"+q(c,a),l=e(c,a)-12,t=A(c,a)+7.5,n=document.createElementNS(h,"text");n.style.fontSize=24;n.setAttribute("x",l);n.setAttribute("y",t);n.appendChild(document.createTextNode(d));n.setAttribute("class","piece-text");x&&(n.id=x);isRedPiece(b)?(g.setAttribute("stroke","red"),f.style.stroke="red",n.style.fill="red"):(g.style.stroke="black",f.style.stroke="black",n.style.fill="black");g.style.strokeWidth=2;f.style.strokeWidth=2;g.style.fill="white";f.style.fillOpacity=0;w(g);
w(f);w(n);B(c,a)};this.erasePiece=function(c,a){D(c,a);t("piece-text-"+q(c,a));t("piece-inner-"+q(c,a));t("piece-outer-"+q(c,a));B(c,a)};this.highlightSquare=function(c,a){var b=e(c,a),g=A(c,a),f=n/6;for(c=-1;1>=c;c+=2){var d=C(b-23,g+23*c,b-23+f,g+23*c,"highlighter",void 0);d.style.strokeWidth=2;d.style.stroke="blue";w(d);d=C(b+23-f,g+23*c,b+23,g+23*c,"highlighter",void 0);d.style.strokeWidth=2;d.style.stroke="blue";w(d)}for(c=-1;1>=c;c+=2)d=C(b+23*c,g-23,b+23*c,g-23+f,"highlighter",void 0),d.style.strokeWidth=
2,d.style.stroke="blue",w(d),d=C(b+23*c,g+23-f,b+23*c,g+23,"highlighter",void 0),d.style.strokeWidth=2,d.style.stroke="blue",w(d)};this.eraseHighlights=function(){for(var b=y().getElementsByClassName("highlighter");0<b.length;)y().removeChild(b[0])};var h="http://www.w3.org/2000/svg",F=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),n=50,E=0,l=!1;x(!1)};function Board(u){function y(){for(var b=0;10>b;++b)for(var e=0;9>e;++e)q.pieceAt(b,e)!=PIECE_NONE&&z.drawPiece(b,e,q.pieceAt(b,e));t=q.numMoves()}function e(b){b=Math.max(0,b);b=Math.min(q.numMoves(),b);if(b!=t){var e=q.moveHistory();if(b>t)for(var h=t;h<b;++h)C(e[h]);else for(h=t-1;h>=b;--h)0<h?v(e[h],e[h-1]):v(e[h],null);t=b}}function A(b){return b==PIECE_NONE?!1:"r"==B?isRedPiece(b):"b"==B?!isRedPiece(b):!1}function C(b){z.erasePiece(b.i1,b.j1);b.capture&&z.erasePiece(b.i2,b.j2);z.drawPiece(b.i2,
b.j2,b.piece);z.eraseHighlights();z.highlightSquare(b.i1,b.j1);z.highlightSquare(b.i2,b.j2);w=null}function v(b,e){z.drawPiece(b.i1,b.j1,b.piece);z.erasePiece(b.i2,b.j2);b.capture&&z.drawPiece(b.i2,b.j2,b.capture);z.eraseHighlights();e&&(z.highlightSquare(e.i1,e.j1),z.highlightSquare(e.i2,e.j2));w=null}this.setState=function(b,x,h){b!=B&&(B=b,z.reset("b"==b),q.reset(),y(),w=null);D=x;b=q.moveHistory();h=q.setMoves(h);x=t;t==b.length&&(x=q.numMoves());for(x=Math.min(x,q.numMoves());t>h;--t){var u=
t-1;0<u?v(b[u],b[u-1]):v(b[u],null)}e(x)};this.showMove=e;this.isRedNext=function(){return q.isRedNext()};this.numMoves=function(){return q.numMoves()};this.numMovesShown=function(){return t};var q=new Chess,z=new BoardUI(function(b,e){if(!D){var h=q.isRedNext();if(("r"==B&&h||"b"==B&&!h)&&t==q.numMoves())if(w)if(q.checkMove(w[0],w[1],b,e)){var h=w[0],v=w[1];C(q.move(h,v,b,e));++t;u(h,v,b,e)}else A(q.pieceAt(b,e))&&(z.eraseHighlights(),w=[b,e],z.highlightSquare(b,e));else A(q.pieceAt(b,e))&&(z.eraseHighlights(),
w=[b,e],z.highlightSquare(b,e))}}),B="r",D=!0,w=null,t=0;y()};String.prototype.endsWith||(String.prototype.endsWith=function(u,y){var e=this.toString();if(void 0===y||y>e.length)y=e.length;y-=u.length;e=e.indexOf(u,y);return-1!==e&&e===y});
function Game(u,y,e){function A(a,b,g,f,d,e,n){var h=new XMLHttpRequest;h.onreadystatechange=function(){if(4==h.readyState){var a=c.indexOf(g);if(-1!=a){c.splice(a,1);for(var b=E+1;b<=l;++b)if(a=c.indexOf(b),-1==a)E=b;else break;requestResolved=!0}else requestResolved=!1;200<=h.status&&299>=h.status?requestResolved||l==g?e(h.responseText):console.log("Dropped response from an old request."):n&&n(h.responseText)}};h.open(a,b,!0);f&&h.setRequestHeader("Content-type",f);d?h.send(d):h.send()}function C(a,
b,g,f){++l;c.push(l);A("POST",a,l,"application/x-www-form-urlencoded; charset=UTF-8",b,g,f)}function v(a){if("fail"==a)alert("Operation failed");else try{var b=JSON.parse(a);b.gameinfo&&("success"!==b.status&&console.log("last update failed"),b=b.gameinfo);e=b;F()}catch(c){console.log("Unrecognized server response: "+a)}}function q(a){a=a.split("/");for(var b=[],c=1;c<a.length;++c){var f=a[c];if("R"==f||"B"==f)break;b.push([parseInt(f[0],10),parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10)])}return b}
function z(a,b,c,f){var d=e;a=[a,b,c,f];d.moves+="/"+(""+a[0]+a[1]+a[2]+a[3]);C("/gameinfo","sid="+D("sid")+"&gid="+u+"&moves="+e.moves,v,B);h()}function B(a){console.log("Retrieve game info failed")}function D(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;++c){for(var f=b[c];" "==f.charAt(0);)f=f.substring(1);if(0==f.indexOf(a))return f.substring(a.length,f.length)}return""}function w(a){var b=document.getElementById(a+"-player"),c=document.getElementById(a+"-sit-link");b.removeChild(c);
b.appendChild(document.createTextNode("sitting down..."));C("/gameinfo","sid="+D("sid")+"&gid="+u+"&sit="+a,v,B)}function t(a,b,c,f,d){var e=document.createElement("a");e.id=a;b&&(e.className=b);e.href=c;f&&(e.onclick=f);e.appendChild(document.createTextNode(d));return e}function b(){removeAllChildren("red-player");removeAllChildren("black-player");if(void 0!==e.red&&null!==e.red){var a="";e.red.id==y&&(a=" (you)");document.getElementById("red-player").appendChild(document.createTextNode("Red: "+
e.red.name+a))}else document.getElementById("red-player").appendChild(document.createTextNode("Red: ")),a=t("red-sit-link",void 0,"#",function(){w("red");return!1},"sit here"),document.getElementById("red-player").appendChild(a);void 0!==e.black&&null!==e.black?(a="",e.black.id==y&&(a=" (you)"),document.getElementById("black-player").appendChild(document.createTextNode("Black: "+e.black.name+a))):(document.getElementById("black-player").appendChild(document.createTextNode("Black: ")),a=t("black-sit-link",
void 0,"#",function(){w("black");return!1},"sit here"),document.getElementById("black-player").appendChild(a))}function x(a,b){var c=document.createElement("td");c.appendChild(b);a.appendChild(c)}function h(){removeAllChildren("move-history");var a=document.getElementById("move-history"),b=document.createElement("table");b.id="moveHistoryControls";var c=document.createElement("tr");b.appendChild(c);0<n.numMovesShown()?(x(c,t("move-history-first",void 0,"#",function(){n.showMove(0);h();return!1},"first")),
x(c,t("move-history-prev",void 0,"#",function(){n.showMove(n.numMovesShown()-1);h();return!1},"prev"))):(x(c,document.createTextNode("first")),x(c,document.createTextNode("prev")));x(c,document.createTextNode(""+n.numMovesShown()+" / "+n.numMoves()));n.numMovesShown()<n.numMoves()?(x(c,t("move-history-next",void 0,"#",function(){n.showMove(n.numMovesShown()+1);h();return!1},"next")),x(c,t("move-history-last",void 0,"#",function(){n.showMove(n.numMoves());h();return!1},"last"))):(x(c,document.createTextNode("next")),
x(c,document.createTextNode("last")));x(c,t("move-history-fork",void 0,"/fork/"+u+"/"+n.numMovesShown().toString(),void 0,"fork from here"));a.appendChild(b)}function F(){b();var a="r";e.black&&e.black.id==y&&(a="b");n.setState(a,!(e.red&&e.black&&!e.moves.endsWith("R")&&!e.moves.endsWith("B")),q(e.moves));removeAllChildren("status");a=document.getElementById("status");e.moves.endsWith("R")?a.appendChild(document.createTextNode("Red won")):e.moves.endsWith("B")?a.appendChild(document.createTextNode("Black won")):
e.red&&e.black?n.isRedNext()?a.appendChild(document.createTextNode("Red to go")):a.appendChild(document.createTextNode("Black to go")):a.appendChild(document.createTextNode("Waiting for players to join..."));h()}var n,E=0,l=0,c=[];(function(){n=new Board(z);F();window.setInterval(function(){A("GET","/gameinfo?gid="+u,E,void 0,void 0,v,B)},1E3)})()}document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,gameInfo)};

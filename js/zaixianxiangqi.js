var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(w){return 8<=w}function Move(w,h,e,z,q,l){this.i1=w;this.j1=h;this.i2=e;this.j2=z;this.piece=q||PIECE_NONE;this.capture=l||PIECE_NONE}
function Chess(){function w(){return 0==A.length%2}function h(d){return 8<=d?d-8:d}function e(){n=[];A=[];for(var d=0;10>d;++d)for(n.push([]),j=0;9>j;++j)n[d].push(0);d="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=d.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var b=0;for(k=0;k<d[i].length;++k){if(9<=b)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var g=d[i][k];if("0"<=g&&"9">=g)b+=parseInt(d[i][k],10);else{var g=n[i],a=b,p=d[i][k],v=p==p.toLowerCase(),p=p.toLowerCase(),c=0;"k"==p?c=1:"a"==p?c=2:"e"==p?c=3:"h"==p?c=4:"r"==p?c=5:"c"==p?c=6:"p"==p&&(c=7);v||(c+=8);g[a]=c;++b}}}}function z(d,b,g,p){A.push(new Move(d,b,g,p,n[d][b],n[g][p]));n[g][p]=n[d][b];n[d][b]=0;return A[A.length-1]}function q(){var d=A.pop();n[d.i1][d.j1]=n[d.i2][d.j2];n[d.i2][d.j2]=d.capture}function l(d,b){return 0<=d&&10>d&&0<=b&&9>b}function u(d,b){return 3<=b&&5>=b&&
(0<=d&&2>=d||7<=d&&9>=d)}function a(d,b){var g=[];for(r=0;4>r;++r)u(d+x[r],b+p[r])&&g.push(new Move(d,b,d+x[r],b+p[r]));for(delta=-1;1>=delta;delta+=2)for(ii=d+delta;0<=ii&&10>ii&&(h(n[ii][b])==PIECE_K&&g.push(new Move(d,b,ii,b)),0==n[ii][b]);ii+=delta);return g}function m(d,b){var g=[];for(r=0;4>r;++r)u(d+v[r],b+f[r])&&g.push(new Move(d,b,d+v[r],b+f[r]));return g}function B(d,b){var g=[];for(r=0;4>r;++r)l(d+2*v[r],b+2*f[r])&&0==n[d+v[r]][b+f[r]]&&4<d+v[r]&&g.push(new Move(d,b,d+2*v[r],b+2*f[r]));
return g}function D(d,b){var g=[];for(r=0;4>r;++r)!l(d+2*v[r],b+2*f[r])||0!=n[d+v[r]][b+f[r]]||4<d+v[r]||g.push(new Move(d,b,d+2*v[r],b+2*f[r]));return g}function t(d,b){var g=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(p){l(d+p[0],b+p[1])&&0==n[d+p[2]][b+p[3]]&&g.push(new Move(d,b,d+p[0],b+p[1]))});return g}function y(d,b){var g=[];for(r=0;4>r;++r){var a,c;a=d+x[r];for(c=b+p[r];l(a,c)&&(g.push(new Move(d,b,a,c)),0==n[a][c]);a+=
x[r],c+=p[r]);}return g}function c(d,b){var g=[];for(r=0;4>r;++r){var a,c,v=!1;a=d+x[r];for(c=b+p[r];l(a,c);a+=x[r],c+=p[r])if(!v&&0==n[a][c])g.push(new Move(d,b,a,c));else if(!v&&0!=n[a][c])v=!0;else if(v&&0!=n[a][c]){g.push(new Move(d,b,a,c));break}}return g}function F(d,b){var g=[];4<d?g.push(new Move(d,b,d-1,b)):(l(d-1,b)&&g.push(new Move(d,b,d-1,b)),l(d,b-1)&&g.push(new Move(d,b,d,b-1)),l(d,b+1)&&g.push(new Move(d,b,d,b+1)));return g}function C(d,b){var g=[];4<d?(l(d+1,b)&&g.push(new Move(d,
b,d+1,b)),l(d,b-1)&&g.push(new Move(d,b,d,b-1)),l(d,b+1)&&g.push(new Move(d,b,d,b+1))):g.push(new Move(d,b,d+1,b));return g}function E(d,b,g){var p=h(n[d][b]),v=isRedPiece(n[d][b]),f=[];1==p?f=a(d,b):2==p?f=m(d,b):3==p?f=v?B(d,b):D(d,b):4==p?f=t(d,b):5==p?f=y(d,b):6==p?f=c(d,b):7==p&&(f=v?F(d,b):C(d,b));f.forEach(function(d){0!=n[d.i2][d.j2]&&isRedPiece(n[d.i2][d.j2])==v||g.push(d)})}function G(d){var b=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=n[i][j]&&isRedPiece(n[i][j])==d&&E(i,j,b);return b}this.reset=
e;this.setMoves=function(d){var b=A;e();for(var g=!0,p=0,a=0;a<d.length;++a)z(d[a][0],d[a][1],d[a][2],d[a][3]),g&&b.length>a&&b[a].i1==d[a][0]&&b[a].j1==d[a][1]&&b[a].i2==d[a][2]&&b[a].j2==d[a][3]?++p:g=!1;return p};this.move=z;this.checkMove=function(d,b,a,p){var c=w();if(!G(c).find(function(c,v,f){return c.i1==d&&c.j1==b&&c.i2==a&&c.j2==p}))return!1;if(n[a][p]==(c?PIECE_BK:PIECE_RK))return!0;var v=!1;z(d,b,a,p);G(!c).find(function(d,b,a){return n[d.i2][d.j2]==(c?PIECE_RK:PIECE_BK)})&&(v=!0);q();
return!v};this.moveHistory=function(){for(var d=[],b=0;b<A.length;++b)d.push(A[b]);return d};this.pieceAt=function(d,b){return n[d][b]};this.isRedNext=w;this.numMoves=function(){return A.length};var n=[],A=[];e();var x=[0,1,0,-1],p=[1,0,-1,0],v=[1,1,-1,-1],f=[1,-1,-1,1]};function removeAllChildren(w){for(w=document.getElementById(w);w.lastChild;)w.removeChild(w.lastChild)}
function BoardUI(w){function h(){return document.getElementById("board")}function e(a,c){x&&(c=8-c);return n/2+c*n}function z(a,c){x&&(a=9-a);return 5>c?n/2+a*n:n/2+a*n+A}function q(a,c,f,d,b,g){var m=document.createElementNS(C,"line");m.setAttribute("x1",a);m.setAttribute("y1",c);m.setAttribute("x2",f);m.setAttribute("y2",d);m.setAttribute("class",b);g&&(m.id=g);return m}function l(a,c,f,d,b){var g=e(a,c);a=z(a,c);c=document.createElementNS(C,"circle");c.setAttribute("cx",g);c.setAttribute("cy",
a);c.setAttribute("r",f);c.setAttribute("class",d);b&&(c.id=b);return c}function u(a,c){return"abcdefghi"[c]+(9-a).toString()}function a(a,c,f,d,b){D(c,f);var g=l(c,f,23,"piece-outer","piece-outer-"+u(c,f)),m=l(c,f,20,"piece-inner","piece-inner-"+u(c,f));b=b?G[d]:E[d];var n="piece-text-"+u(c,f),F=e(c,f);c=z(c,f);f=document.createElementNS(C,"text");f.style.fontFamily="Roboto,monospace";f.style.fontSize=24;f.setAttribute("text-anchor","middle");f.setAttribute("alignment-baseline","central");f.setAttribute("dominant-baseline",
"middle");f.setAttribute("x",F);f.setAttribute("y",c);f.appendChild(document.createTextNode(b));f.setAttribute("class","piece-text");f.userSelect="none";n&&(f.id=n);isRedPiece(d)?(g.setAttribute("stroke","red"),m.style.stroke="red",f.style.fill="red"):(g.style.stroke="black",m.style.stroke="black",f.style.fill="black");g.style.strokeWidth=2;m.style.strokeWidth=2;g.style.fill="white";m.style.fillOpacity=0;a.appendChild(g);a.appendChild(m);a.appendChild(f)}function m(a,c){return function(){w(a,c)}}
function B(a,c){var f=l(a,c,23,"piece-cover","piece-cover-"+u(a,c));f.style.strokeWidth=0;f.style.fillOpacity=0;f.userSelect="none";f.onmousedown=m(a,c);f.touchend=f.onmousedown;t(f)}function D(a,c){var f="piece-cover-"+u(a,c);null!=document.getElementById(f)&&y(f)}function t(a){h().appendChild(a)}function y(a){h().removeChild(document.getElementById(a))}function c(a,c,f,d){var b;b=e(a,c);a=z(a,c);c=e(f,d);f=z(f,d);b=q(b,a,c,f,"grid",void 0);b.style.strokeWidth=1;b.style.stroke="gray";t(b)}function F(a){x=
a;removeAllChildren("board");for(i=0;9>i;++i)c(0,i,4,i),0!=i&&8!=i||c(4,i,5,i),c(5,i,9,i);for(i=0;10>i;++i)c(i,0,i,8);c(0,3,2,5);c(0,5,2,3);c(7,3,9,5);c(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)B(i,j)}this.reset=F;this.drawPieceWithCover=function(c,m,f,d){a(h(),c,m,f,d);B(c,m)};this.erasePiece=function(a,c){D(a,c);y("piece-text-"+u(a,c));y("piece-inner-"+u(a,c));y("piece-outer-"+u(a,c));B(a,c)};this.drawColorIndicator=function(c,m){var f=1;m&&(f+=8);a(c,0,0,f,!1)};this.highlightSquare=function(a,
c){var f=e(a,c),d=z(a,c),b=n/6;for(a=-1;1>=a;a+=2){var g=q(f-23,d+23*a,f-23+b,d+23*a,"highlighter",void 0);g.style.strokeWidth=2;g.style.stroke="blue";t(g);g=q(f+23-b,d+23*a,f+23,d+23*a,"highlighter",void 0);g.style.strokeWidth=2;g.style.stroke="blue";t(g)}for(a=-1;1>=a;a+=2)g=q(f+23*a,d-23,f+23*a,d-23+b,"highlighter",void 0),g.style.strokeWidth=2,g.style.stroke="blue",t(g),g=q(f+23*a,d+23-b,f+23*a,d+23,"highlighter",void 0),g.style.strokeWidth=2,g.style.stroke="blue",t(g)};this.eraseHighlights=function(){for(var a=
h().getElementsByClassName("highlighter");0<a.length;)h().removeChild(a[0])};var C="http://www.w3.org/2000/svg",E=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),G=" \u5c07 \u58eb \u8c61 \ud83d\udc34 \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \ud83e\udd84 \u4fe5 \u70ae \u5175".split(" "),n=50,A=0,x=!1;F(!1)};function Board(w,h){function e(){for(var c=0;10>c;++c)for(var e=0;9>e;++e)a.pieceAt(c,e)!=PIECE_NONE&&m.drawPieceWithCover(c,e,a.pieceAt(c,e),!1);y=a.numMoves()}function z(c){c=Math.max(0,c);c=Math.min(a.numMoves(),c);if(c!=y){var m=a.moveHistory();if(c>y)for(var e=y;e<c;++e)l(m[e]);else for(e=y-1;e>=c;--e)0<e?u(m[e],m[e-1]):u(m[e],null);y=c}}function q(a){return a==PIECE_NONE?!1:"r"==B?isRedPiece(a):"b"==B?!isRedPiece(a):!1}function l(a){m.erasePiece(a.i1,a.j1);var e=!1;a.capture&&(m.erasePiece(a.i2,
a.j2),h&&(e=!0));m.drawPieceWithCover(a.i2,a.j2,a.piece,e);m.eraseHighlights();m.highlightSquare(a.i1,a.j1);m.highlightSquare(a.i2,a.j2);t=null}function u(a,e){m.drawPieceWithCover(a.i1,a.j1,a.piece,!1);m.erasePiece(a.i2,a.j2);a.capture&&m.drawPieceWithCover(a.i2,a.j2,a.capture,!1);m.eraseHighlights();e&&(m.highlightSquare(e.i1,e.j1),m.highlightSquare(e.i2,e.j2));t=null}this.setState=function(c,h,q){c!=B&&(B=c,m.reset("b"==c),a.reset(),e(),t=null);D=h;c=a.moveHistory();q=a.setMoves(q);h=y;y==c.length&&
(h=a.numMoves());for(h=Math.min(h,a.numMoves());y>q;--y){var l=y-1;0<l?u(c[l],c[l-1]):u(c[l],null)}z(h)};this.showMove=z;this.isRedNext=function(){return a.isRedNext()};this.numMoves=function(){return a.numMoves()};this.numMovesShown=function(){return y};var a=new Chess,m=new BoardUI(function(c,e){if(!D){var h=a.isRedNext();if(("r"==B&&h||"b"==B&&!h)&&y==a.numMoves())if(t)if(a.checkMove(t[0],t[1],c,e)){var h=t[0],u=t[1];l(a.move(h,u,c,e));++y;w(h,u,c,e)}else q(a.pieceAt(c,e))&&(m.eraseHighlights(),
t=[c,e],m.highlightSquare(c,e));else q(a.pieceAt(c,e))&&(m.eraseHighlights(),t=[c,e],m.highlightSquare(c,e))}}),B="r",D=!0,t=null,y=0;m.drawColorIndicator(document.getElementById("redIndicator"),!0);m.drawColorIndicator(document.getElementById("blackIndicator"),!1);e()};function Stopwatch(w){function h(){return document.getElementById(w)}function e(){if(l){var a=document.getElementById(w+"Hand"),e=.8*q,h=u/z*2*Math.PI;a.setAttribute("x2",e*Math.sin(h));a.setAttribute("y2",-e*Math.cos(h));++u;u%=z}}this.start=function(){l||(l=!0,u=0,e(),h().style.visibility="visible")};this.stop=function(){l=!1;h().style.visibility="hidden"};this.tick=e;this.frequency=function(){return z};var z=250,q=20,l=!1,u=0;(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",
"circle");a.setAttribute("cx",0);a.setAttribute("cy",0);a.setAttribute("r",q);a.style.stroke="black";a.style.strokeWidth=2;a.style.fillOpacity=0;h().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0);a.setAttribute("y1",-q);a.setAttribute("x2",0);a.setAttribute("y2",-q-6);a.style.strokeWidth=4;a.style.stroke="black";h().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",-3);a.setAttribute("y",-q-6-4);
a.setAttribute("width",6);a.setAttribute("height",4);a.style.strokeWidth=.5;a.style.stroke="black";a.style.fillOpacity=0;h().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",0);a.setAttribute("cy",-q-6-2);a.setAttribute("r",6);a.style.stroke="black";a.style.strokeWidth=1;a.style.fillOpacity=0;h().appendChild(a);for(a=-3;3>=a;a+=1){var e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1",a);e.setAttribute("y1",-q-6-
4);e.setAttribute("x2",a);e.setAttribute("y2",-q-6);e.style.strokeWidth=.2;e.style.stroke="black";h().appendChild(e)}for(a=0;12>a;++a){var e=document.createElementNS("http://www.w3.org/2000/svg","line"),l=a/12*2*Math.PI,u=q,t=.7*q;e.setAttribute("x1",u*Math.sin(l));e.setAttribute("y1",-u*Math.cos(l));e.setAttribute("x2",t*Math.sin(l));e.setAttribute("y2",-t*Math.cos(l));e.style.strokeWidth=1;e.style.stroke="black";h().appendChild(e)}for(a=0;60>a;++a)e=document.createElementNS("http://www.w3.org/2000/svg",
"line"),l=a/60*2*Math.PI,u=q,t=.85*q,e.setAttribute("x1",u*Math.sin(l)),e.setAttribute("y1",-u*Math.cos(l)),e.setAttribute("x2",t*Math.sin(l)),e.setAttribute("y2",-t*Math.cos(l)),e.style.strokeWidth=.5,e.style.stroke="black",h().appendChild(e);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.id=w+"Hand";a.setAttribute("x1",0);a.setAttribute("y1",0);a.setAttribute("x2",0);a.setAttribute("y2",.8*-q);a.style.strokeWidth=1;a.style.stroke="black";h().appendChild(a);h().style.visibility=
"hidden"})()};String.prototype.endsWith||(String.prototype.endsWith=function(w,h){var e=this.toString();if(void 0===h||h>e.length)h=e.length;h-=w.length;e=e.indexOf(w,h);return-1!==e&&e===h});
function Game(w,h,e){function z(a,b,c,e,h,m,n){var l=new XMLHttpRequest;l.onreadystatechange=function(){if(4==l.readyState){var a=f.indexOf(c);if(-1!=a){f.splice(a,1);for(var d=p+1;d<=v;++d)if(a=f.indexOf(d),-1==a)p=d;else break;requestResolved=!0}else requestResolved=!1;200<=l.status&&299>=l.status?requestResolved||v==c?m(l.responseText):console.log("Dropped response from an old request."):n&&n(l.responseText)}};l.open(a,b,!0);e&&l.setRequestHeader("Content-type",e);h?l.send(h):l.send()}function q(a,
b,c,e){++v;f.push(v);z("POST",a,v,"application/x-www-form-urlencoded; charset=UTF-8",b,c,e)}function l(a){if("fail"==a)alert("Operation failed");else try{var b=JSON.parse(a);b.gameinfo&&("success"!==b.status&&console.log("last update failed"),b=b.gameinfo);e=b;G()}catch(c){console.log("Unrecognized server response: "+a)}}function u(a){a=a.split("/");for(var b=[],c=1;c<a.length;++c){var e=a[c];if("R"==e||"B"==e)break;b.push([parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10)])}return b}
function a(a,b,c,f){var n=e;a=[a,b,c,f];n.moves+="/"+(""+a[0]+a[1]+a[2]+a[3]);F();q("/gameinfo","uid="+h+"&sid="+B("sid")+"&gid="+w+"&moves="+e.moves,l,m);E()}function m(a){console.log("Retrieve game info failed")}function B(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;++c){for(var e=b[c];" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(a))return e.substring(a.length,e.length)}return""}function D(a){var b=document.getElementById(a+"-player"),c=document.getElementById(a+"-sit-link");
b.removeChild(c);b.appendChild(document.createTextNode("sitting down..."));q("/gameinfo","uid="+h+"&sid="+B("sid")+"&gid="+w+"&sit="+a,l,m)}function t(a,b,c,e,f){var h=document.createElement("a");h.id=a;b&&(h.className=b);h.href=c;e&&(h.onclick=e);h.appendChild(document.createTextNode(f));return h}function y(a){var b=document.createElement("sub");b.className="hint-you";a?b.appendChild(document.createTextNode(" ")):b.appendChild(document.createTextNode(" you"));return b}function c(){removeAllChildren("red-player");
removeAllChildren("black-player");if(void 0!==e.red&&null!==e.red){var a=document.getElementById("red-player"),b=document.createElement("span");b.appendChild(document.createTextNode(e.red.name));a.appendChild(b);a.appendChild(y(e.red.id!=h))}else b=t("red-sit-link","sit-link","#",function(){D("red");return!1},"sit here"),document.getElementById("red-player").appendChild(b);void 0!==e.black&&null!==e.black?(a=document.getElementById("black-player"),b=document.createElement("span"),b.appendChild(document.createTextNode(e.black.name)),
a.appendChild(b),a.appendChild(y(e.black.id!=h))):(b=t("black-sit-link","sit-link","#",function(){D("black");return!1},"sit here"),document.getElementById("black-player").appendChild(b))}function F(){var a=document.getElementById("waitingStatus"),b=document.getElementById("playingStatus"),c=document.getElementById("redWonStatus"),f=document.getElementById("blackWonStatus");a.style.display="none";b.style.display="none";c.style.display="none";f.style.display="none";e.moves.endsWith("R")?c.style.display=
"inline-block":e.moves.endsWith("B")?f.style.display="inline-block":e.red&&e.black?(b.style.display="inline-block",x.isRedNext()?(n.start(),A.stop()):(A.start(),n.stop())):a.style.display="inline-block"}function C(a,b){var c=document.createElement("td");c.appendChild(b);a.appendChild(c)}function E(){removeAllChildren("move-history");var a=document.getElementById("move-history"),b=document.createElement("table");b.id="moveHistoryControls";var c=document.createElement("tr");b.appendChild(c);0<x.numMovesShown()?
(C(c,t("move-history-first",void 0,"#",function(){x.showMove(0);E();return!1},"first")),C(c,t("move-history-prev",void 0,"#",function(){x.showMove(x.numMovesShown()-1);E();return!1},"prev"))):(C(c,document.createTextNode("first")),C(c,document.createTextNode("prev")));C(c,document.createTextNode(""+x.numMovesShown()+" / "+x.numMoves()));x.numMovesShown()<x.numMoves()?(C(c,t("move-history-next",void 0,"#",function(){x.showMove(x.numMovesShown()+1);E();return!1},"next")),C(c,t("move-history-last",void 0,
"#",function(){x.showMove(x.numMoves());E();return!1},"last"))):(C(c,document.createTextNode("next")),C(c,document.createTextNode("last")));a.appendChild(b);b=document.createElement("div");b.id="moveHistoryFork";b.appendChild(t("move-history-fork-link",void 0,"/fork/"+w+"/"+x.numMovesShown().toString(),void 0,"fork"));b.appendChild(document.createTextNode(" this game from here"));a.appendChild(b)}function G(){c();var a="r";e.black&&e.black.id==h&&(a="b");var b=e.black&&e.black.id==h||e.red&&e.red.id==
h;x.setState(a,!(e.red&&e.black&&!e.moves.endsWith("R")&&!e.moves.endsWith("B"))||!b,u(e.moves));F();E()}var n,A,x,p=0,v=0,f=[];(function(){n=new Stopwatch("redStopwatch");A=new Stopwatch("blackStopwatch");window.setInterval(function(){n.tick();A.tick()},6E4/n.frequency());x=new Board(a,!1);G();window.setInterval(function(){z("GET","/gameinfo?gid="+w,p,void 0,void 0,l,m)},1E3)})()}document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,gameInfo)};

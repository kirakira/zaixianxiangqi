function parseMoves(q){q=q.split("/");for(var l=[],t=1;t<q.length;++t){var u=q[t];if("R"==u||"B"==u||"D"==u)break;l.push([parseInt(u[0],10),parseInt(u[1],10),parseInt(u[2],10),parseInt(u[3],10)])}return l}function removeAllChildren(q){for(q=document.getElementById(q);q.lastChild;)q.removeChild(q.lastChild)}function createLink(q,l,t,u,y){var r=document.createElement("a");q&&(r.id=q);l&&(r.className=l);r.href=t;u&&(r.onclick=u);r.appendChild(document.createTextNode(y));return r}
String.prototype.endsWith||(String.prototype.endsWith=function(q,l){var t=this.toString();if(void 0===l||l>t.length)l=t.length;l-=q.length;t=t.indexOf(q,l);return-1!==t&&t===l});var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(q){return 8<=q}function Move(q,l,t,u,y,r){this.i1=q;this.j1=l;this.i2=t;this.j2=u;this.piece=y||PIECE_NONE;this.capture=r||PIECE_NONE}
function Chess(){function q(){return 0==A.length%2}function l(e){return 8<=e?e-8:e}function t(){p=[];A=[];for(var e=0;10>e;++e){p.push([]);for(var f=0;9>f;++f)p[e].push(0)}e="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=e.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(f=0;10>f;++f)for(var a=0,d=0;d<e[f].length;++d){if(9<=a)throw"Malformed fen string at row "+f+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var x=e[f][d];if("0"<=x&&"9">=x)a+=parseInt(e[f][d],10);else{var x=p[f],b=a,c=e[f][d],m=c==c.toLowerCase(),c=c.toLowerCase(),g=0;"k"==c?g=1:"a"==c?g=2:"e"==c?g=3:"h"==c?g=4:"r"==c?g=5:"c"==c?g=6:"p"==c&&(g=7);m||(g+=8);x[b]=g;++a}}}function u(e,f,a,d){A.push(new Move(e,f,a,d,p[e][f],p[a][d]));p[a][d]=p[e][f];p[e][f]=0;return A[A.length-1]}function y(){var e=A.pop();p[e.i1][e.j1]=p[e.i2][e.j2];p[e.i2][e.j2]=e.capture}function r(e,f){return 0<=e&&10>e&&0<=f&&9>f}function k(e,f){return 3<=f&&5>=f&&(0<=
e&&2>=e||7<=e&&9>=e)}function n(e,f){for(var a=[],d=0;4>d;++d)k(e+B[d],f+x[d])&&a.push(new Move(e,f,e+B[d],f+x[d]));for(d=-1;1>=d;d+=2)for(var c=e+d;0<=c&&10>c&&(l(p[c][f])==PIECE_K&&a.push(new Move(e,f,c,f)),0==p[c][f]);c+=d);return a}function z(e,f){for(var a=[],d=0;4>d;++d)k(e+m[d],f+c[d])&&a.push(new Move(e,f,e+m[d],f+c[d]));return a}function v(e,f){for(var a=[],d=0;4>d;++d)r(e+2*m[d],f+2*c[d])&&0==p[e+m[d]][f+c[d]]&&4<e+m[d]&&a.push(new Move(e,f,e+2*m[d],f+2*c[d]));return a}function w(e,f){for(var a=
[],d=0;4>d;++d)!r(e+2*m[d],f+2*c[d])||0!=p[e+m[d]][f+c[d]]||4<e+m[d]||a.push(new Move(e,f,e+2*m[d],f+2*c[d]));return a}function g(e,f){var a=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(d){r(e+d[0],f+d[1])&&0==p[e+d[2]][f+d[3]]&&a.push(new Move(e,f,e+d[0],f+d[1]))});return a}function a(e,a){for(var c=[],d=0;4>d;++d){var b,m;b=e+B[d];for(m=a+x[d];r(b,m)&&(c.push(new Move(e,a,b,m)),0==p[b][m]);b+=B[d],m+=x[d]);}return c}function b(e,
a){for(var c=[],d=0;4>d;++d){var b,m,g=!1;b=e+B[d];for(m=a+x[d];r(b,m);b+=B[d],m+=x[d])if(!g&&0==p[b][m])c.push(new Move(e,a,b,m));else if(!g&&0!=p[b][m])g=!0;else if(g&&0!=p[b][m]){c.push(new Move(e,a,b,m));break}}return c}function h(e,a){var c=[];4<e?c.push(new Move(e,a,e-1,a)):(r(e-1,a)&&c.push(new Move(e,a,e-1,a)),r(e,a-1)&&c.push(new Move(e,a,e,a-1)),r(e,a+1)&&c.push(new Move(e,a,e,a+1)));return c}function D(a,f){var c=[];4<a?(r(a+1,f)&&c.push(new Move(a,f,a+1,f)),r(a,f-1)&&c.push(new Move(a,
f,a,f-1)),r(a,f+1)&&c.push(new Move(a,f,a,f+1))):c.push(new Move(a,f,a+1,f));return c}function C(e,f,c){var d=l(p[e][f]),x=isRedPiece(p[e][f]),m=[];1==d?m=n(e,f):2==d?m=z(e,f):3==d?m=x?v(e,f):w(e,f):4==d?m=g(e,f):5==d?m=a(e,f):6==d?m=b(e,f):7==d&&(m=x?h(e,f):D(e,f));m.forEach(function(a){0!=p[a.i2][a.j2]&&isRedPiece(p[a.i2][a.j2])==x||c.push(a)})}function E(a){for(var f=[],c=0;10>c;++c)for(var d=0;9>d;++d)0!=p[c][d]&&isRedPiece(p[c][d])==a&&C(c,d,f);return f}this.reset=t;this.setMoves=function(a){var f=
A;t();for(var c=!0,d=0,b=0;b<a.length;++b)u(a[b][0],a[b][1],a[b][2],a[b][3]),c&&f.length>b&&f[b].i1==a[b][0]&&f[b].j1==a[b][1]&&f[b].i2==a[b][2]&&f[b].j2==a[b][3]?++d:c=!1;return d};this.move=u;this.checkMove=function(a,c,b,d){var m=q();if(!E(m).find(function(m,x,g){return m.i1==a&&m.j1==c&&m.i2==b&&m.j2==d}))return!1;if(p[b][d]==(m?PIECE_BK:PIECE_RK))return!0;var x=!1;u(a,c,b,d);E(!m).find(function(a,c,e){return p[a.i2][a.j2]==(m?PIECE_RK:PIECE_BK)})&&(x=!0);y();return!x};this.moveHistory=function(){for(var a=
[],c=0;c<A.length;++c)a.push(A[c]);return a};this.lastMove=function(){return A[A.length-1]};this.pieceAt=function(a,c){return p[a][c]};this.isRedNext=q;this.numMoves=function(){return A.length};var p=[],A=[];t();var B=[0,1,0,-1],x=[1,0,-1,0],m=[1,1,-1,-1],c=[1,-1,-1,1]};function BoardUI(q){function l(){return document.getElementById("board")}function t(a,b){B&&(b=8-b);return p/2+b*p}function u(a,b){B&&(a=9-a);return 5>b?p/2+a*p:p/2+a*p+A}function y(a,b,c,e,f,g){var d=document.createElementNS(C,"line");d.setAttribute("x1",a);d.setAttribute("y1",b);d.setAttribute("x2",c);d.setAttribute("y2",e);d.classList.add(f);g&&(d.id=g);return d}function r(a,b,c,e,f){var g=t(a,b);b=u(a,b);var d=document.createElementNS(C,"circle");d.setAttribute("cx",g);d.setAttribute("cy",b);
d.setAttribute("r",c);d.classList.add(e[a]);d.classList.add("piece-element");f&&(d.id=f);return d}function k(a,b){return"abcdefghi"[b]+(9-a).toString()}function n(a,b,c,e,f){f&&w(b,c);var g=void 0;f&&(g="piece-outer-"+k(b,c));var g=r(b,c,23,"piece-outer",g),d=void 0;f&&(d="piece-inner-"+k(b,c));var d=r(b,c,20,"piece-inner",d),h=E[e],p=void 0;f&&(p="piece-text-"+k(b,c));f=p;p=t(b,c);b=u(b,c);c=document.createElementNS(C,"text");c.style.fontFamily="Roboto,monospace";c.style.fontSize="24px";c.setAttribute("text-anchor",
"middle");c.setAttribute("alignment-baseline","central");c.setAttribute("dominant-baseline","middle");c.setAttribute("x",p);c.setAttribute("y",b);c.appendChild(document.createTextNode(h));c.classList.add("piece-text");c.classList.add("piece-element");c.userSelect="none";f&&(c.id=f);isRedPiece(e)?(g.setAttribute("stroke","red"),d.style.stroke="red",c.style.fill="red"):(g.style.stroke="black",d.style.stroke="black",c.style.fill="black");g.style.strokeWidth=2;d.style.strokeWidth=2;g.style.fill="white";
d.style.fillOpacity=0;a.appendChild(g);a.appendChild(d);a.appendChild(c)}function z(a,b){return function(){q(a,b)}}function v(a,b){var c=r(a,b,23,"piece-cover","piece-cover-"+k(a,b));c.style.strokeWidth=0;c.style.fillOpacity=0;c.userSelect="none";c.onmousedown=z(a,b);c.touchend=c.onmousedown;g(c)}function w(b,g){var c="piece-cover-"+k(b,g);null!=document.getElementById(c)&&a(c)}function g(a){l().appendChild(a)}function a(a){l().removeChild(document.getElementById(a))}function b(a,b,c,e){var f;f=t(a,
b);a=u(a,b);b=t(c,e);c=u(c,e);f=y(f,a,b,c,"grid",void 0);f.style.strokeWidth=1;f.style.stroke="gray";g(f)}function h(){for(i=0;9>i;++i)b(0,i,4,i),0!=i&&8!=i||b(4,i,5,i),b(5,i,9,i);for(i=0;10>i;++i)b(i,0,i,8);b(0,3,2,5);b(0,5,2,3);b(7,3,9,5);b(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)v(i,j)}function D(){for(var a=l().getElementsByClassName("highlighter");0<a.length;)l().removeChild(a[0])}this.reset=function(a){if(B==a){for(a=l().getElementsByClassName("piece-element");0<a.length;)l().removeChild(a[0]);
D()}else B=a,removeAllChildren("board"),h()};this.drawPieceWithCover=function(a,b,c){n(l(),a,b,c,!0);v(a,b)};this.erasePiece=function(b,g){w(b,g);a("piece-text-"+k(b,g));a("piece-inner-"+k(b,g));a("piece-outer-"+k(b,g));v(b,g)};this.drawColorIndicator=function(a,b){var c=1;b&&(c+=8);n(a,0,0,c,!1)};this.highlightSquare=function(a,b){var c=t(a,b),e=u(a,b),f=p/6;for(a=-1;1>=a;a+=2){var h=y(c-23,e+23*a,c-23+f,e+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";g(h);h=y(c+23-f,e+23*
a,c+23,e+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";g(h)}for(a=-1;1>=a;a+=2)h=y(c+23*a,e-23,c+23*a,e-23+f,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",g(h),h=y(c+23*a,e+23-f,c+23*a,e+23,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",g(h)};this.eraseHighlights=D;var C="http://www.w3.org/2000/svg",E=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),p=50,A=0,B=!1;h()};function Board(q){function l(){for(var a=0;10>a;++a)for(var b=0;9>b;++b)k.pieceAt(a,b)!=PIECE_NONE&&n.drawPieceWithCover(a,b,k.pieceAt(a,b));g=k.numMoves()}function t(a){a=Math.max(0,a);a=Math.min(k.numMoves(),a);if(a!=g){var b=k.moveHistory();if(a>g)for(var h=g;h<a;++h)y(b[h]);else for(h=g-1;h>=a;--h)0<h?r(b[h],b[h-1]):r(b[h],null);g=a}}function u(a){return a==PIECE_NONE?!1:"r"==z?isRedPiece(a):"b"==z?!isRedPiece(a):!1}function y(a){n.erasePiece(a.i1,a.j1);a.capture&&n.erasePiece(a.i2,a.j2);n.drawPieceWithCover(a.i2,
a.j2,a.piece);n.eraseHighlights();n.highlightSquare(a.i1,a.j1);n.highlightSquare(a.i2,a.j2);w=null}function r(a,b){n.drawPieceWithCover(a.i1,a.j1,a.piece);n.erasePiece(a.i2,a.j2);a.capture&&n.drawPieceWithCover(a.i2,a.j2,a.capture);n.eraseHighlights();b&&(n.highlightSquare(b.i1,b.j1),n.highlightSquare(b.i2,b.j2));w=null}this.setState=function(a,b,h){a!=z&&(z=a,n.reset("b"==a),k.reset(),l(),w=null);v=b;a=k.moveHistory();h=k.setMoves(h);b=g;g==a.length&&(b=k.numMoves());for(b=Math.min(b,k.numMoves());g>
h;--g){var q=g-1;0<q?r(a[q],a[q-1]):r(a[q],null)}t(b)};this.resetState=function(a,b,h){z=a;n.reset("b"==a);k.reset();k.setMoves(h);l();w=null;g=k.numMoves();0<k.numMoves()&&(a=k.lastMove(),n.highlightSquare(a.i1,a.j1),n.highlightSquare(a.i2,a.j2))};this.showMove=t;this.isRedNext=function(){return k.isRedNext()};this.numMoves=function(){return k.numMoves()};this.numMovesShown=function(){return g};var k=new Chess,n=new BoardUI(function(a,b){if(!v){var h=k.isRedNext();if(("r"==z&&h||"b"==z&&!h)&&g==
k.numMoves())if(w)if(k.checkMove(w[0],w[1],a,b)){var h=w[0],l=w[1];y(k.move(h,l,a,b));++g;q(h,l,a,b)}else u(k.pieceAt(a,b))&&(n.eraseHighlights(),w=[a,b],n.highlightSquare(a,b));else u(k.pieceAt(a,b))&&(n.eraseHighlights(),w=[a,b],n.highlightSquare(a,b))}}),z="r",v=!0,w=null,g=0;n.drawColorIndicator(document.getElementById("redIndicator"),!0);n.drawColorIndicator(document.getElementById("blackIndicator"),!1);l()};function ExperimentViewer(q,l){function t(g,a,b,h,k,n){var l=new XMLHttpRequest;l.onreadystatechange=function(){4==l.readyState&&(200<=l.status&&299>=l.status?k(l.responseText):n&&n(l.responseText))};l.open(g,a,!0);b&&l.setRequestHeader("Content-type",b);h?l.send(h):l.send()}function u(g,a,b){t("GET",g,void 0,void 0,a,b)}function y(g){var a=document.getElementById("game-record-"+g);a?(a.classList.add("pendingSelection"),r(g)):alert("Game "+g+" does not exist.")}function r(g){u(encodeURI("/game_record/"+
q.id+"/"+g),function(a){v=JSON.parse(a);w&&w.classList.remove("selectedGame");a=document.getElementById("game-record-"+g);a.classList.remove("pendingSelection");a.classList.add("selectedGame");w=a;window.location.hash="#"+g;k()},function(a,b){var g=document.getElementById("game-record-"+a);g&&g.classList.remove("pendingSelection");alert("Failed to retrieve game record")})}function k(){removeAllChildren("red-player");var g=document.getElementById("red-player"),a=document.createElement("span");v&&a.appendChild(document.createTextNode(v.red.name));
g.appendChild(a);removeAllChildren("black-player");g=document.getElementById("black-player");a=document.createElement("span");v&&a.appendChild(document.createTextNode(v.black.name));g.appendChild(a);board_.resetState("r",!0,parseMoves(v?v.moves:""));removeAllChildren("gameTitle");a=document.getElementById("gameTitle");g=document.createElement("h3");g.appendChild(document.createTextNode(v?v.title:""));a.appendChild(g);var a=document.getElementById("playingStatus"),g=document.getElementById("redWonStatus"),
b=document.getElementById("blackWonStatus"),h=document.getElementById("drawStatus");a.style.display="none";g.style.display="none";b.style.display="none";h.style.display="none";v&&(v.moves.endsWith("R")?g.style.display="inline-block":v.moves.endsWith("B")?b.style.display="inline-block":v.moves.endsWith("D")?h.style.display="inline-block":a.style.display="inline-block");z()}function n(g,a){var b=document.createElement("td");b.appendChild(a);g.appendChild(b)}function z(){removeAllChildren("move-history");
var g=document.getElementById("move-history"),a=document.createElement("table");a.id="moveHistoryControls";var b=document.createElement("tr");a.appendChild(b);0<board_.numMovesShown()?(n(b,createLink("move-history-first",void 0,"#",function(){board_.showMove(0);z();return!1},"first")),n(b,createLink("move-history-prev",void 0,"#",function(){board_.showMove(board_.numMovesShown()-1);z();return!1},"prev"))):(n(b,document.createTextNode("first")),n(b,document.createTextNode("prev")));n(b,document.createTextNode(""+
board_.numMovesShown()+" / "+board_.numMoves()));board_.numMovesShown()<board_.numMoves()?(n(b,createLink("move-history-next",void 0,"#",function(){board_.showMove(board_.numMovesShown()+1);z();return!1},"next")),n(b,createLink("move-history-last",void 0,"#",function(){board_.showMove(board_.numMoves());z();return!1},"last"))):(n(b,document.createTextNode("next")),n(b,document.createTextNode("last")));g.appendChild(a)}var v=null,w=null;board_=new Board(function(g,a,b,h){});(function(){for(var g=q.hasOwnProperty("control_is_red")&&
q.control_is_red,a=document.getElementById("gameList"),b=0;b<l.length;b++){var h=l[b],n=document.createElement("tr"),k=document.createElement("td"),r=0;h.hasOwnProperty("result")&&(1==h.result?r=g?2:1:2==h.result&&(r=g?1:2));0==r?(k.appendChild(document.createTextNode("D")),k.classList.add("draw")):1==r?(k.appendChild(document.createTextNode("W")),k.classList.add("win")):(k.appendChild(document.createTextNode("L")),k.classList.add("loss"));n.appendChild(k);k=document.createElement("td");k.appendChild(document.createTextNode(h.game_id));
k.onclick=function(a){return function(){y(a.game_id)}}(h);k.id="game-record-"+h.game_id;n.appendChild(k);a.appendChild(n)}})();k();window.location.hash?y(window.location.hash.substring(1)):0<l.length&&y(l[0].game_id)}document.onreadystatechange=function(){"interactive"==document.readyState&&new ExperimentViewer(experimentMetadata,toc)};

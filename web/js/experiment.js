function parseMoves(m){m=m.split("/");for(var p=[],u=1;u<m.length;++u){var w=m[u];if("R"==w||"B"==w||"D"==w)break;p.push([parseInt(w[0],10),parseInt(w[1],10),parseInt(w[2],10),parseInt(w[3],10)])}return p}function removeAllChildren(m){for(m=document.getElementById(m);m.lastChild;)m.removeChild(m.lastChild)}function createLink(m,p,u,w,z){var n=document.createElement("a");m&&(n.id=m);p&&(n.className=p);n.href=u;w&&(n.onclick=w);n.appendChild(document.createTextNode(z));return n}
String.prototype.endsWith||(String.prototype.endsWith=function(m,p){var u=this.toString();if(void 0===p||p>u.length)p=u.length;p-=m.length;u=u.indexOf(m,p);return-1!==u&&u===p});var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(m){return 8<=m}function Move(m,p,u,w,z,n){this.i1=m;this.j1=p;this.i2=u;this.j2=w;this.piece=z||PIECE_NONE;this.capture=n||PIECE_NONE}
function Chess(){function m(){return 0==B.length%2}function p(d){return 8<=d?d-8:d}function u(){q=[];B=[];for(var d=0;10>d;++d)for(q.push([]),j=0;9>j;++j)q[d].push(0);d="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=d.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var f=0;for(k=0;k<d[i].length;++k){if(9<=f)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var a=d[i][k];if("0"<=a&&"9">=a)f+=parseInt(d[i][k],10);else{var a=q[i],v=f,b=d[i][k],c=b==b.toLowerCase(),b=b.toLowerCase(),h=0;"k"==b?h=1:"a"==b?h=2:"e"==b?h=3:"h"==b?h=4:"r"==b?h=5:"c"==b?h=6:"p"==b&&(h=7);c||(h+=8);a[v]=h;++f}}}}function w(d,f,a,b){B.push(new Move(d,f,a,b,q[d][f],q[a][b]));q[a][b]=q[d][f];q[d][f]=0;return B[B.length-1]}function z(){var d=B.pop();q[d.i1][d.j1]=q[d.i2][d.j2];q[d.i2][d.j2]=d.capture}function n(d,f){return 0<=d&&10>d&&0<=f&&9>f}function e(d,f){return 3<=f&&5>=f&&
(0<=d&&2>=d||7<=d&&9>=d)}function l(d,f){var a=[];for(r=0;4>r;++r)e(d+C[r],f+v[r])&&a.push(new Move(d,f,d+C[r],f+v[r]));for(delta=-1;1>=delta;delta+=2)for(ii=d+delta;0<=ii&&10>ii&&(p(q[ii][f])==PIECE_K&&a.push(new Move(d,f,ii,f)),0==q[ii][f]);ii+=delta);return a}function A(d,f){var a=[];for(r=0;4>r;++r)e(d+h[r],f+c[r])&&a.push(new Move(d,f,d+h[r],f+c[r]));return a}function x(d,f){var a=[];for(r=0;4>r;++r)n(d+2*h[r],f+2*c[r])&&0==q[d+h[r]][f+c[r]]&&4<d+h[r]&&a.push(new Move(d,f,d+2*h[r],f+2*c[r]));
return a}function y(d,a){var b=[];for(r=0;4>r;++r)!n(d+2*h[r],a+2*c[r])||0!=q[d+h[r]][a+c[r]]||4<d+h[r]||b.push(new Move(d,a,d+2*h[r],a+2*c[r]));return b}function g(d,a){var b=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(v){n(d+v[0],a+v[1])&&0==q[d+v[2]][a+v[3]]&&b.push(new Move(d,a,d+v[0],a+v[1]))});return b}function a(d,a){var b=[];for(r=0;4>r;++r){var h,c;h=d+C[r];for(c=a+v[r];n(h,c)&&(b.push(new Move(d,a,h,c)),0==q[h][c]);h+=
C[r],c+=v[r]);}return b}function b(d,a){var b=[];for(r=0;4>r;++r){var h,c,g=!1;h=d+C[r];for(c=a+v[r];n(h,c);h+=C[r],c+=v[r])if(!g&&0==q[h][c])b.push(new Move(d,a,h,c));else if(!g&&0!=q[h][c])g=!0;else if(g&&0!=q[h][c]){b.push(new Move(d,a,h,c));break}}return b}function t(a,f){var b=[];4<a?b.push(new Move(a,f,a-1,f)):(n(a-1,f)&&b.push(new Move(a,f,a-1,f)),n(a,f-1)&&b.push(new Move(a,f,a,f-1)),n(a,f+1)&&b.push(new Move(a,f,a,f+1)));return b}function E(a,f){var b=[];4<a?(n(a+1,f)&&b.push(new Move(a,
f,a+1,f)),n(a,f-1)&&b.push(new Move(a,f,a,f-1)),n(a,f+1)&&b.push(new Move(a,f,a,f+1))):b.push(new Move(a,f,a+1,f));return b}function D(d,f,h){var v=p(q[d][f]),c=isRedPiece(q[d][f]),e=[];1==v?e=l(d,f):2==v?e=A(d,f):3==v?e=c?x(d,f):y(d,f):4==v?e=g(d,f):5==v?e=a(d,f):6==v?e=b(d,f):7==v&&(e=c?t(d,f):E(d,f));e.forEach(function(a){0!=q[a.i2][a.j2]&&isRedPiece(q[a.i2][a.j2])==c||h.push(a)})}function F(a){var b=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=q[i][j]&&isRedPiece(q[i][j])==a&&D(i,j,b);return b}this.reset=
u;this.setMoves=function(a){var b=B;u();for(var v=!0,h=0,c=0;c<a.length;++c)w(a[c][0],a[c][1],a[c][2],a[c][3]),v&&b.length>c&&b[c].i1==a[c][0]&&b[c].j1==a[c][1]&&b[c].i2==a[c][2]&&b[c].j2==a[c][3]?++h:v=!1;return h};this.move=w;this.checkMove=function(a,b,c,v){var h=m();if(!F(h).find(function(h,g,e){return h.i1==a&&h.j1==b&&h.i2==c&&h.j2==v}))return!1;if(q[c][v]==(h?PIECE_BK:PIECE_RK))return!0;var g=!1;w(a,b,c,v);F(!h).find(function(a,b,c){return q[a.i2][a.j2]==(h?PIECE_RK:PIECE_BK)})&&(g=!0);z();
return!g};this.moveHistory=function(){for(var a=[],b=0;b<B.length;++b)a.push(B[b]);return a};this.lastMove=function(){return B[B.length-1]};this.pieceAt=function(a,b){return q[a][b]};this.isRedNext=m;this.numMoves=function(){return B.length};var q=[],B=[];u();var C=[0,1,0,-1],v=[1,0,-1,0],h=[1,1,-1,-1],c=[1,-1,-1,1]};function BoardUI(m){function p(){return document.getElementById("board")}function u(a,b){C&&(b=8-b);return q/2+b*q}function w(a,b){C&&(a=9-a);return 5>b?q/2+a*q:q/2+a*q+B}function z(a,b,c,d,f,g){var e=document.createElementNS(D,"line");e.setAttribute("x1",a);e.setAttribute("y1",b);e.setAttribute("x2",c);e.setAttribute("y2",d);e.classList.add(f);g&&(e.id=g);return e}function n(a,b,c,d,f){var g=u(a,b);b=w(a,b);var e=document.createElementNS(D,"circle");e.setAttribute("cx",g);e.setAttribute("cy",b);
e.setAttribute("r",c);e.classList.add(d[a]);e.classList.add("piece-element");f&&(e.id=f);return e}function e(a,b){return"abcdefghi"[b]+(9-a).toString()}function l(a,b,c,d,f){f&&y(b,c);var g=void 0;f&&(g="piece-outer-"+e(b,c));var g=n(b,c,23,"piece-outer",g),t=void 0;f&&(t="piece-inner-"+e(b,c));var t=n(b,c,20,"piece-inner",t),q=F[d],l=void 0;f&&(l="piece-text-"+e(b,c));f=l;l=u(b,c);b=w(b,c);c=document.createElementNS(D,"text");c.style.fontFamily="Roboto,monospace";c.style.fontSize="24px";c.setAttribute("text-anchor",
"middle");c.setAttribute("alignment-baseline","central");c.setAttribute("dominant-baseline","middle");c.setAttribute("x",l);c.setAttribute("y",b);c.appendChild(document.createTextNode(q));c.classList.add("piece-text");c.classList.add("piece-element");c.userSelect="none";f&&(c.id=f);isRedPiece(d)?(g.setAttribute("stroke","red"),t.style.stroke="red",c.style.fill="red"):(g.style.stroke="black",t.style.stroke="black",c.style.fill="black");g.style.strokeWidth=2;t.style.strokeWidth=2;g.style.fill="white";
t.style.fillOpacity=0;a.appendChild(g);a.appendChild(t);a.appendChild(c)}function A(a,b){return function(){m(a,b)}}function x(a,b){var c=n(a,b,23,"piece-cover","piece-cover-"+e(a,b));c.style.strokeWidth=0;c.style.fillOpacity=0;c.userSelect="none";c.onmousedown=A(a,b);c.touchend=c.onmousedown;g(c)}function y(b,g){var c="piece-cover-"+e(b,g);null!=document.getElementById(c)&&a(c)}function g(a){p().appendChild(a)}function a(a){p().removeChild(document.getElementById(a))}function b(a,b,c,d){var f;f=u(a,
b);a=w(a,b);b=u(c,d);c=w(c,d);f=z(f,a,b,c,"grid",void 0);f.style.strokeWidth=1;f.style.stroke="gray";g(f)}function t(){for(i=0;9>i;++i)b(0,i,4,i),0!=i&&8!=i||b(4,i,5,i),b(5,i,9,i);for(i=0;10>i;++i)b(i,0,i,8);b(0,3,2,5);b(0,5,2,3);b(7,3,9,5);b(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)x(i,j)}function E(){for(var a=p().getElementsByClassName("highlighter");0<a.length;)p().removeChild(a[0])}this.reset=function(a){if(C==a){for(a=p().getElementsByClassName("piece-element");0<a.length;)p().removeChild(a[0]);
E()}else C=a,removeAllChildren("board"),t()};this.drawPieceWithCover=function(a,b,c){l(p(),a,b,c,!0);x(a,b)};this.erasePiece=function(b,g){y(b,g);a("piece-text-"+e(b,g));a("piece-inner-"+e(b,g));a("piece-outer-"+e(b,g));x(b,g)};this.drawColorIndicator=function(a,b){var c=1;b&&(c+=8);l(a,0,0,c,!1)};this.highlightSquare=function(a,b){var c=u(a,b),d=w(a,b),f=q/6;for(a=-1;1>=a;a+=2){var e=z(c-23,d+23*a,c-23+f,d+23*a,"highlighter",void 0);e.style.strokeWidth=2;e.style.stroke="blue";g(e);e=z(c+23-f,d+23*
a,c+23,d+23*a,"highlighter",void 0);e.style.strokeWidth=2;e.style.stroke="blue";g(e)}for(a=-1;1>=a;a+=2)e=z(c+23*a,d-23,c+23*a,d-23+f,"highlighter",void 0),e.style.strokeWidth=2,e.style.stroke="blue",g(e),e=z(c+23*a,d+23-f,c+23*a,d+23,"highlighter",void 0),e.style.strokeWidth=2,e.style.stroke="blue",g(e)};this.eraseHighlights=E;var D="http://www.w3.org/2000/svg",F=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),q=50,B=0,C=!1;t()};function Board(m){function p(){for(var a=0;10>a;++a)for(var b=0;9>b;++b)e.pieceAt(a,b)!=PIECE_NONE&&l.drawPieceWithCover(a,b,e.pieceAt(a,b));g=e.numMoves()}function u(a){a=Math.max(0,a);a=Math.min(e.numMoves(),a);if(a!=g){var b=e.moveHistory();if(a>g)for(var t=g;t<a;++t)z(b[t]);else for(t=g-1;t>=a;--t)0<t?n(b[t],b[t-1]):n(b[t],null);g=a}}function w(a){return a==PIECE_NONE?!1:"r"==A?isRedPiece(a):"b"==A?!isRedPiece(a):!1}function z(a){l.erasePiece(a.i1,a.j1);a.capture&&l.erasePiece(a.i2,a.j2);l.drawPieceWithCover(a.i2,
a.j2,a.piece);l.eraseHighlights();l.highlightSquare(a.i1,a.j1);l.highlightSquare(a.i2,a.j2);y=null}function n(a,b){l.drawPieceWithCover(a.i1,a.j1,a.piece);l.erasePiece(a.i2,a.j2);a.capture&&l.drawPieceWithCover(a.i2,a.j2,a.capture);l.eraseHighlights();b&&(l.highlightSquare(b.i1,b.j1),l.highlightSquare(b.i2,b.j2));y=null}this.setState=function(a,b,t){a!=A&&(A=a,l.reset("b"==a),e.reset(),p(),y=null);x=b;a=e.moveHistory();t=e.setMoves(t);b=g;g==a.length&&(b=e.numMoves());for(b=Math.min(b,e.numMoves());g>
t;--g){var m=g-1;0<m?n(a[m],a[m-1]):n(a[m],null)}u(b)};this.resetState=function(a,b,t){A=a;l.reset("b"==a);e.reset();e.setMoves(t);p();y=null;g=e.numMoves();0<e.numMoves()&&(a=e.lastMove(),l.highlightSquare(a.i1,a.j1),l.highlightSquare(a.i2,a.j2))};this.showMove=u;this.isRedNext=function(){return e.isRedNext()};this.numMoves=function(){return e.numMoves()};this.numMovesShown=function(){return g};var e=new Chess,l=new BoardUI(function(a,b){if(!x){var t=e.isRedNext();if(("r"==A&&t||"b"==A&&!t)&&g==
e.numMoves())if(y)if(e.checkMove(y[0],y[1],a,b)){var t=y[0],p=y[1];z(e.move(t,p,a,b));++g;m(t,p,a,b)}else w(e.pieceAt(a,b))&&(l.eraseHighlights(),y=[a,b],l.highlightSquare(a,b));else w(e.pieceAt(a,b))&&(l.eraseHighlights(),y=[a,b],l.highlightSquare(a,b))}}),A="r",x=!0,y=null,g=0;l.drawColorIndicator(document.getElementById("redIndicator"),!0);l.drawColorIndicator(document.getElementById("blackIndicator"),!1);p()};function ExperimentViewer(m,p){function u(g,a,b,e,l,p){var m=new XMLHttpRequest;m.onreadystatechange=function(){4==m.readyState&&(200<=m.status&&299>=m.status?l(m.responseText):p&&p(m.responseText))};m.open(g,a,!0);b&&m.setRequestHeader("Content-type",b);e?m.send(e):m.send()}function w(g,a,b){u("GET",g,void 0,void 0,a,b)}function z(g){var a=document.getElementById("game-record-"+g);a?(a.classList.add("pendingSelection"),n(g)):alert("Game "+g+" does not exist.")}function n(g){w(encodeURI("/game_record/"+
m.id+"/"+g),function(a){x=JSON.parse(a);y&&y.classList.remove("selectedGame");a=document.getElementById("game-record-"+g);a.classList.remove("pendingSelection");a.classList.add("selectedGame");y=a;window.location.hash="#"+g;e()},function(a,b){var g=document.getElementById("game-record-"+a);g&&g.classList.remove("pendingSelection");alert("Failed to retrieve game record")})}function e(){removeAllChildren("red-player");var g=document.getElementById("red-player"),a=document.createElement("span");x&&a.appendChild(document.createTextNode(x.red.name));
g.appendChild(a);removeAllChildren("black-player");g=document.getElementById("black-player");a=document.createElement("span");x&&a.appendChild(document.createTextNode(x.black.name));g.appendChild(a);board_.resetState("r",!0,parseMoves(x?x.moves:""));removeAllChildren("gameTitle");a=document.getElementById("gameTitle");g=document.createElement("h3");g.appendChild(document.createTextNode(x?x.title:""));a.appendChild(g);var a=document.getElementById("playingStatus"),g=document.getElementById("redWonStatus"),
b=document.getElementById("blackWonStatus"),e=document.getElementById("drawStatus");a.style.display="none";g.style.display="none";b.style.display="none";e.style.display="none";x&&(x.moves.endsWith("R")?g.style.display="inline-block":x.moves.endsWith("B")?b.style.display="inline-block":x.moves.endsWith("D")?e.style.display="inline-block":a.style.display="inline-block");A()}function l(g,a){var b=document.createElement("td");b.appendChild(a);g.appendChild(b)}function A(){removeAllChildren("move-history");
var g=document.getElementById("move-history"),a=document.createElement("table");a.id="moveHistoryControls";var b=document.createElement("tr");a.appendChild(b);0<board_.numMovesShown()?(l(b,createLink("move-history-first",void 0,"#",function(){board_.showMove(0);A();return!1},"first")),l(b,createLink("move-history-prev",void 0,"#",function(){board_.showMove(board_.numMovesShown()-1);A();return!1},"prev"))):(l(b,document.createTextNode("first")),l(b,document.createTextNode("prev")));l(b,document.createTextNode(""+
board_.numMovesShown()+" / "+board_.numMoves()));board_.numMovesShown()<board_.numMoves()?(l(b,createLink("move-history-next",void 0,"#",function(){board_.showMove(board_.numMovesShown()+1);A();return!1},"next")),l(b,createLink("move-history-last",void 0,"#",function(){board_.showMove(board_.numMoves());A();return!1},"last"))):(l(b,document.createTextNode("next")),l(b,document.createTextNode("last")));g.appendChild(a)}var x=null,y=null;board_=new Board(function(g,a,b,e){});(function(){for(var g=m.hasOwnProperty("control_is_red")&&
m.control_is_red,a=document.getElementById("gameList"),b=0;b<p.length;b++){var e=p[b],l=document.createElement("tr"),n=document.createElement("td"),u=0;e.hasOwnProperty("result")&&(1==e.result?u=g?2:1:2==e.result&&(u=g?1:2));0==u?(n.appendChild(document.createTextNode("D")),n.classList.add("draw")):1==u?(n.appendChild(document.createTextNode("W")),n.classList.add("win")):(n.appendChild(document.createTextNode("L")),n.classList.add("loss"));l.appendChild(n);n=document.createElement("td");n.appendChild(document.createTextNode(e.game_id));
n.onclick=function(a){return function(){z(a.game_id)}}(e);n.id="game-record-"+e.game_id;l.appendChild(n);a.appendChild(l)}})();e();window.location.hash?z(window.location.hash.substring(1)):0<p.length&&z(p[0].game_id)}document.onreadystatechange=function(){"interactive"==document.readyState&&new ExperimentViewer(experimentMetadata,toc)};

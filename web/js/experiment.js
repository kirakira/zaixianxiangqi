function parseMoves(m){m=m.split("/");for(var q=[],v=1;v<m.length;++v){var u=m[v];if("R"==u||"B"==u||"D"==u)break;q.push([parseInt(u[0],10),parseInt(u[1],10),parseInt(u[2],10),parseInt(u[3],10)])}return q}function removeAllChildren(m){for(m=document.getElementById(m);m.lastChild;)m.removeChild(m.lastChild)}function createLink(m,q,v,u,x){var p=document.createElement("a");m&&(p.id=m);q&&(p.className=q);p.href=v;u&&(p.onclick=u);p.appendChild(document.createTextNode(x));return p}
String.prototype.endsWith||(String.prototype.endsWith=function(m,q){var v=this.toString();if(void 0===q||q>v.length)q=v.length;q-=m.length;v=v.indexOf(m,q);return-1!==v&&v===q});var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(m){return 8<=m}function Move(m,q,v,u,x,p){this.i1=m;this.j1=q;this.i2=v;this.j2=u;this.piece=x||PIECE_NONE;this.capture=p||PIECE_NONE}
function Chess(){function m(){return 0==A.length%2}function q(c){return 8<=c?c-8:c}function v(){t=[];A=[];for(var c=0;10>c;++c)for(t.push([]),j=0;9>j;++j)t[c].push(0);c="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=c.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var e=0;for(k=0;k<c[i].length;++k){if(9<=e)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var a=c[i][k];if("0"<=a&&"9">=a)e+=parseInt(c[i][k],10);else{var a=t[i],n=e,d=c[i][k],f=d==d.toLowerCase(),d=d.toLowerCase(),b=0;"k"==d?b=1:"a"==d?b=2:"e"==d?b=3:"h"==d?b=4:"r"==d?b=5:"c"==d?b=6:"p"==d&&(b=7);f||(b+=8);a[n]=b;++e}}}}function u(c,e,a,n){A.push(new Move(c,e,a,n,t[c][e],t[a][n]));t[a][n]=t[c][e];t[c][e]=0;return A[A.length-1]}function x(){var c=A.pop();t[c.i1][c.j1]=t[c.i2][c.j2];t[c.i2][c.j2]=c.capture}function p(c,e){return 0<=c&&10>c&&0<=e&&9>e}function g(c,e){return 3<=e&&5>=e&&
(0<=c&&2>=c||7<=c&&9>=c)}function l(c,e){var a=[];for(r=0;4>r;++r)g(c+B[r],e+n[r])&&a.push(new Move(c,e,c+B[r],e+n[r]));for(delta=-1;1>=delta;delta+=2)for(ii=c+delta;0<=ii&&10>ii&&(q(t[ii][e])==PIECE_K&&a.push(new Move(c,e,ii,e)),0==t[ii][e]);ii+=delta);return a}function y(c,e){var a=[];for(r=0;4>r;++r)g(c+f[r],e+d[r])&&a.push(new Move(c,e,c+f[r],e+d[r]));return a}function w(c,e){var a=[];for(r=0;4>r;++r)p(c+2*f[r],e+2*d[r])&&0==t[c+f[r]][e+d[r]]&&4<c+f[r]&&a.push(new Move(c,e,c+2*f[r],e+2*d[r]));
return a}function z(c,e){var a=[];for(r=0;4>r;++r)!p(c+2*f[r],e+2*d[r])||0!=t[c+f[r]][e+d[r]]||4<c+f[r]||a.push(new Move(c,e,c+2*f[r],e+2*d[r]));return a}function h(c,e){var a=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(n){p(c+n[0],e+n[1])&&0==t[c+n[2]][e+n[3]]&&a.push(new Move(c,e,c+n[0],e+n[1]))});return a}function a(c,a){var d=[];for(r=0;4>r;++r){var b,f;b=c+B[r];for(f=a+n[r];p(b,f)&&(d.push(new Move(c,a,b,f)),0==t[b][f]);b+=
B[r],f+=n[r]);}return d}function b(c,a){var d=[];for(r=0;4>r;++r){var b,f,h=!1;b=c+B[r];for(f=a+n[r];p(b,f);b+=B[r],f+=n[r])if(!h&&0==t[b][f])d.push(new Move(c,a,b,f));else if(!h&&0!=t[b][f])h=!0;else if(h&&0!=t[b][f]){d.push(new Move(c,a,b,f));break}}return d}function D(c,a){var n=[];4<c?n.push(new Move(c,a,c-1,a)):(p(c-1,a)&&n.push(new Move(c,a,c-1,a)),p(c,a-1)&&n.push(new Move(c,a,c,a-1)),p(c,a+1)&&n.push(new Move(c,a,c,a+1)));return n}function E(a,e){var n=[];4<a?(p(a+1,e)&&n.push(new Move(a,
e,a+1,e)),p(a,e-1)&&n.push(new Move(a,e,a,e-1)),p(a,e+1)&&n.push(new Move(a,e,a,e+1))):n.push(new Move(a,e,a+1,e));return n}function C(c,e,n){var d=q(t[c][e]),f=isRedPiece(t[c][e]),g=[];1==d?g=l(c,e):2==d?g=y(c,e):3==d?g=f?w(c,e):z(c,e):4==d?g=h(c,e):5==d?g=a(c,e):6==d?g=b(c,e):7==d&&(g=f?D(c,e):E(c,e));g.forEach(function(a){0!=t[a.i2][a.j2]&&isRedPiece(t[a.i2][a.j2])==f||n.push(a)})}function F(a){var e=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=t[i][j]&&isRedPiece(t[i][j])==a&&C(i,j,e);return e}this.reset=
v;this.setMoves=function(a){var e=A;v();for(var n=!0,d=0,f=0;f<a.length;++f)u(a[f][0],a[f][1],a[f][2],a[f][3]),n&&e.length>f&&e[f].i1==a[f][0]&&e[f].j1==a[f][1]&&e[f].i2==a[f][2]&&e[f].j2==a[f][3]?++d:n=!1;return d};this.move=u;this.checkMove=function(a,e,n,f){var d=m();if(!F(d).find(function(d,b,h){return d.i1==a&&d.j1==e&&d.i2==n&&d.j2==f}))return!1;if(t[n][f]==(d?PIECE_BK:PIECE_RK))return!0;var b=!1;u(a,e,n,f);F(!d).find(function(a,c,n){return t[a.i2][a.j2]==(d?PIECE_RK:PIECE_BK)})&&(b=!0);x();
return!b};this.moveHistory=function(){for(var a=[],n=0;n<A.length;++n)a.push(A[n]);return a};this.lastMove=function(){return A[A.length-1]};this.pieceAt=function(a,n){return t[a][n]};this.isRedNext=m;this.numMoves=function(){return A.length};var t=[],A=[];v();var B=[0,1,0,-1],n=[1,0,-1,0],f=[1,1,-1,-1],d=[1,-1,-1,1]};function BoardUI(m){function q(){return document.getElementById("board")}function v(a,f){B&&(f=8-f);return t/2+f*t}function u(a,f){B&&(a=9-a);return 5>f?t/2+a*t:t/2+a*t+A}function x(a,f,d,c,e,b){var h=document.createElementNS(C,"line");h.setAttribute("x1",a);h.setAttribute("y1",f);h.setAttribute("x2",d);h.setAttribute("y2",c);h.classList.add(e);b&&(h.id=b);return h}function p(a,f,d,c,e){var b=v(a,f);f=u(a,f);var h=document.createElementNS(C,"circle");h.setAttribute("cx",b);h.setAttribute("cy",f);
h.setAttribute("r",d);h.classList.add(c[a]);h.classList.add("piece-element");e&&(h.id=e);return h}function g(a,f){return"abcdefghi"[f]+(9-a).toString()}function l(a,f,d,c,e){e&&z(f,d);var b=void 0;e&&(b="piece-outer-"+g(f,d));var b=p(f,d,23,"piece-outer",b),h=void 0;e&&(h="piece-inner-"+g(f,d));var h=p(f,d,20,"piece-inner",h),t=F[c],l=void 0;e&&(l="piece-text-"+g(f,d));e=l;l=v(f,d);f=u(f,d);d=document.createElementNS(C,"text");d.style.fontFamily="Roboto,monospace";d.style.fontSize="24px";d.setAttribute("text-anchor",
"middle");d.setAttribute("alignment-baseline","central");d.setAttribute("dominant-baseline","middle");d.setAttribute("x",l);d.setAttribute("y",f);d.appendChild(document.createTextNode(t));d.classList.add("piece-text");d.classList.add("piece-element");d.userSelect="none";e&&(d.id=e);isRedPiece(c)?(b.setAttribute("stroke","red"),h.style.stroke="red",d.style.fill="red"):(b.style.stroke="black",h.style.stroke="black",d.style.fill="black");b.style.strokeWidth=2;h.style.strokeWidth=2;b.style.fill="white";
h.style.fillOpacity=0;a.appendChild(b);a.appendChild(h);a.appendChild(d)}function y(a,f){return function(){m(a,f)}}function w(a,f){var d=p(a,f,23,"piece-cover","piece-cover-"+g(a,f));d.style.strokeWidth=0;d.style.fillOpacity=0;d.userSelect="none";d.onmousedown=y(a,f);d.touchend=d.onmousedown;h(d)}function z(b,f){var d="piece-cover-"+g(b,f);null!=document.getElementById(d)&&a(d)}function h(a){q().appendChild(a)}function a(a){q().removeChild(document.getElementById(a))}function b(a,b,d,c){var e;e=v(a,
b);a=u(a,b);b=v(d,c);d=u(d,c);e=x(e,a,b,d,"grid",void 0);e.style.strokeWidth=1;e.style.stroke="gray";h(e)}function D(){for(i=0;9>i;++i)b(0,i,4,i),0!=i&&8!=i||b(4,i,5,i),b(5,i,9,i);for(i=0;10>i;++i)b(i,0,i,8);b(0,3,2,5);b(0,5,2,3);b(7,3,9,5);b(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)w(i,j)}function E(){for(var a=q().getElementsByClassName("highlighter");0<a.length;)q().removeChild(a[0])}this.reset=function(a){if(B==a){for(a=q().getElementsByClassName("piece-element");0<a.length;)q().removeChild(a[0]);
E()}else B=a,removeAllChildren("board"),D()};this.drawPieceWithCover=function(a,b,d){l(q(),a,b,d,!0);w(a,b)};this.erasePiece=function(b,f){z(b,f);a("piece-text-"+g(b,f));a("piece-inner-"+g(b,f));a("piece-outer-"+g(b,f));w(b,f)};this.drawColorIndicator=function(a,b){var d=1;b&&(d+=8);l(a,0,0,d,!1)};this.highlightSquare=function(a,b){var d=v(a,b),c=u(a,b),e=t/6;for(a=-1;1>=a;a+=2){var g=x(d-23,c+23*a,d-23+e,c+23*a,"highlighter",void 0);g.style.strokeWidth=2;g.style.stroke="blue";h(g);g=x(d+23-e,c+23*
a,d+23,c+23*a,"highlighter",void 0);g.style.strokeWidth=2;g.style.stroke="blue";h(g)}for(a=-1;1>=a;a+=2)g=x(d+23*a,c-23,d+23*a,c-23+e,"highlighter",void 0),g.style.strokeWidth=2,g.style.stroke="blue",h(g),g=x(d+23*a,c+23-e,d+23*a,c+23,"highlighter",void 0),g.style.strokeWidth=2,g.style.stroke="blue",h(g)};this.eraseHighlights=E;var C="http://www.w3.org/2000/svg",F=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),t=50,A=0,B=!1;D()};function Board(m){function q(){for(var a=0;10>a;++a)for(var b=0;9>b;++b)g.pieceAt(a,b)!=PIECE_NONE&&l.drawPieceWithCover(a,b,g.pieceAt(a,b));h=g.numMoves()}function v(a){a=Math.max(0,a);a=Math.min(g.numMoves(),a);if(a!=h){var b=g.moveHistory();if(a>h)for(var l=h;l<a;++l)x(b[l]);else for(l=h-1;l>=a;--l)0<l?p(b[l],b[l-1]):p(b[l],null);h=a}}function u(a){return a==PIECE_NONE?!1:"r"==y?isRedPiece(a):"b"==y?!isRedPiece(a):!1}function x(a){l.erasePiece(a.i1,a.j1);a.capture&&l.erasePiece(a.i2,a.j2);l.drawPieceWithCover(a.i2,
a.j2,a.piece);l.eraseHighlights();l.highlightSquare(a.i1,a.j1);l.highlightSquare(a.i2,a.j2);z=null}function p(a,b){l.drawPieceWithCover(a.i1,a.j1,a.piece);l.erasePiece(a.i2,a.j2);a.capture&&l.drawPieceWithCover(a.i2,a.j2,a.capture);l.eraseHighlights();b&&(l.highlightSquare(b.i1,b.j1),l.highlightSquare(b.i2,b.j2));z=null}this.setState=function(a,b,m){a!=y&&(y=a,l.reset("b"==a),g.reset(),q(),z=null);w=b;a=g.moveHistory();m=g.setMoves(m);b=h;h==a.length&&(b=g.numMoves());for(b=Math.min(b,g.numMoves());h>
m;--h){var u=h-1;0<u?p(a[u],a[u-1]):p(a[u],null)}v(b)};this.resetState=function(a,b,m){y=a;l.reset("b"==a);g.reset();g.setMoves(m);q();z=null;h=g.numMoves();0<g.numMoves()&&(a=g.lastMove(),l.highlightSquare(a.i1,a.j1),l.highlightSquare(a.i2,a.j2))};this.showMove=v;this.isRedNext=function(){return g.isRedNext()};this.numMoves=function(){return g.numMoves()};this.numMovesShown=function(){return h};var g=new Chess,l=new BoardUI(function(a,b){if(!w){var q=g.isRedNext();if(("r"==y&&q||"b"==y&&!q)&&h==
g.numMoves())if(z)if(g.checkMove(z[0],z[1],a,b)){var q=z[0],p=z[1];x(g.move(q,p,a,b));++h;m(q,p,a,b)}else u(g.pieceAt(a,b))&&(l.eraseHighlights(),z=[a,b],l.highlightSquare(a,b));else u(g.pieceAt(a,b))&&(l.eraseHighlights(),z=[a,b],l.highlightSquare(a,b))}}),y="r",w=!0,z=null,h=0;l.drawColorIndicator(document.getElementById("redIndicator"),!0);l.drawColorIndicator(document.getElementById("blackIndicator"),!1);q()};function ExperimentViewer(m,q){function v(g,h,a,b,l,q){var m=new XMLHttpRequest;m.onreadystatechange=function(){4==m.readyState&&(200<=m.status&&299>=m.status?l(m.responseText):q&&q(m.responseText))};m.open(g,h,!0);a&&m.setRequestHeader("Content-type",a);b?m.send(b):m.send()}function u(g,h,a){v("GET",g,void 0,void 0,h,a)}function x(l){u(encodeURI("/game_record/"+m.id+"/"+l),function(h){w=JSON.parse(h);g()},function(h){alert("failed to retrieve game record")})}function p(){var g=m.hasOwnProperty("control_is_red")&&
m.control_is_red,h=document.getElementById("gameList");removeAllChildren("gameList");for(var a=0;a<q.length;a++){var b=q[a],l=document.createElement("tr"),p=document.createElement("td"),u=0;b.hasOwnProperty("result")&&(1==b.result?u=g?2:1:2==b.result&&(u=g?1:2));0==u?(p.appendChild(document.createTextNode("D")),p.classList.add("draw")):1==u?(p.appendChild(document.createTextNode("W")),p.classList.add("win")):(p.appendChild(document.createTextNode("L")),p.classList.add("loss"));l.appendChild(p);p=
document.createElement("td");p.appendChild(createLink(void 0,void 0,"#"+b.game_id,function(a){return function(){x(a.game_id)}}(b),b.game_id));l.appendChild(p);h.appendChild(l)}}function g(){p();removeAllChildren("red-player");var g=document.getElementById("red-player"),h=document.createElement("span");w&&h.appendChild(document.createTextNode(w.red.name));g.appendChild(h);removeAllChildren("black-player");g=document.getElementById("black-player");h=document.createElement("span");w&&h.appendChild(document.createTextNode(w.black.name));
g.appendChild(h);board_.resetState("r",!0,parseMoves(w?w.moves:""));removeAllChildren("gameTitle");h=document.getElementById("gameTitle");g=document.createElement("h3");g.appendChild(document.createTextNode(w?w.title:""));h.appendChild(g);var h=document.getElementById("playingStatus"),g=document.getElementById("redWonStatus"),a=document.getElementById("blackWonStatus"),b=document.getElementById("drawStatus");h.style.display="none";g.style.display="none";a.style.display="none";b.style.display="none";
w&&(w.moves.endsWith("R")?g.style.display="inline-block":w.moves.endsWith("B")?a.style.display="inline-block":w.moves.endsWith("D")?b.style.display="inline-block":h.style.display="inline-block");y()}function l(g,h){var a=document.createElement("td");a.appendChild(h);g.appendChild(a)}function y(){removeAllChildren("move-history");var g=document.getElementById("move-history"),h=document.createElement("table");h.id="moveHistoryControls";var a=document.createElement("tr");h.appendChild(a);0<board_.numMovesShown()?
(l(a,createLink("move-history-first",void 0,"#",function(){board_.showMove(0);y();return!1},"first")),l(a,createLink("move-history-prev",void 0,"#",function(){board_.showMove(board_.numMovesShown()-1);y();return!1},"prev"))):(l(a,document.createTextNode("first")),l(a,document.createTextNode("prev")));l(a,document.createTextNode(""+board_.numMovesShown()+" / "+board_.numMoves()));board_.numMovesShown()<board_.numMoves()?(l(a,createLink("move-history-next",void 0,"#",function(){board_.showMove(board_.numMovesShown()+
1);y();return!1},"next")),l(a,createLink("move-history-last",void 0,"#",function(){board_.showMove(board_.numMoves());y();return!1},"last"))):(l(a,document.createTextNode("next")),l(a,document.createTextNode("last")));g.appendChild(h)}var w=null;board_=new Board(function(g,h,a,b){});g();window.location.hash?x(window.location.hash.substring(1)):0<q.length&&x(q[0].game_id)}document.onreadystatechange=function(){"interactive"==document.readyState&&new ExperimentViewer(experimentMetadata,toc)};

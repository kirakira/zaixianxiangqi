function parseMoves(p){p=p.split("/");for(var l=[],t=1;t<p.length;++t){var u=p[t];if("R"==u||"B"==u||"D"==u)break;l.push([parseInt(u[0],10),parseInt(u[1],10),parseInt(u[2],10),parseInt(u[3],10)])}return l}function removeAllChildren(p){for(p=document.getElementById(p);p.lastChild;)p.removeChild(p.lastChild)}function createLink(p,l,t,u,y){var r=document.createElement("a");p&&(r.id=p);l&&(r.className=l);r.href=t;u&&(r.onclick=u);r.appendChild(document.createTextNode(y));return r}
String.prototype.endsWith||(String.prototype.endsWith=function(p,l){var t=this.toString();if(void 0===l||l>t.length)l=t.length;l-=p.length;t=t.indexOf(p,l);return-1!==t&&t===l});var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(p){return 8<=p}function Move(p,l,t,u,y,r){this.i1=p;this.j1=l;this.i2=t;this.j2=u;this.piece=y||PIECE_NONE;this.capture=r||PIECE_NONE}
function Chess(){function p(){return 0==A.length%2}function l(f){return 8<=f?f-8:f}function t(){n=[];A=[];for(var f=0;10>f;++f){n.push([]);for(var e=0;9>e;++e)n[f].push(0)}f="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=f.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(e=0;10>e;++e)for(var a=0,d=0;d<f[e].length;++d){if(9<=a)throw"Malformed fen string at row "+e+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var b=f[e][d];if("0"<=b&&"9">=b)a+=parseInt(f[e][d],10);else{var b=n[e],x=a,c=f[e][d],q=c==c.toLowerCase(),c=c.toLowerCase(),g=0;"k"==c?g=1:"a"==c?g=2:"e"==c?g=3:"h"==c?g=4:"r"==c?g=5:"c"==c?g=6:"p"==c&&(g=7);q||(g+=8);b[x]=g;++a}}}function u(f,e,a,d){A.push(new Move(f,e,a,d,n[f][e],n[a][d]));n[a][d]=n[f][e];n[f][e]=0;return A[A.length-1]}function y(){var f=A.pop();n[f.i1][f.j1]=n[f.i2][f.j2];n[f.i2][f.j2]=f.capture}function r(f,e){return 0<=f&&10>f&&0<=e&&9>e}function m(f,e){return 3<=e&&5>=e&&(0<=
f&&2>=f||7<=f&&9>=f)}function k(f,e){for(var a=[],d=0;4>d;++d)m(f+B[d],e+x[d])&&a.push(new Move(f,e,f+B[d],e+x[d]));for(d=-1;1>=d;d+=2)for(var b=f+d;0<=b&&10>b&&(l(n[b][e])==PIECE_K&&a.push(new Move(f,e,b,e)),0==n[b][e]);b+=d);return a}function z(f,e){for(var a=[],d=0;4>d;++d)m(f+q[d],e+c[d])&&a.push(new Move(f,e,f+q[d],e+c[d]));return a}function v(f,e){for(var a=[],d=0;4>d;++d)r(f+2*q[d],e+2*c[d])&&0==n[f+q[d]][e+c[d]]&&4<f+q[d]&&a.push(new Move(f,e,f+2*q[d],e+2*c[d]));return a}function w(f,e){for(var a=
[],d=0;4>d;++d)!r(f+2*q[d],e+2*c[d])||0!=n[f+q[d]][e+c[d]]||4<f+q[d]||a.push(new Move(f,e,f+2*q[d],e+2*c[d]));return a}function g(f,e){var a=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(d){r(f+d[0],e+d[1])&&0==n[f+d[2]][e+d[3]]&&a.push(new Move(f,e,f+d[0],e+d[1]))});return a}function a(f,e){for(var a=[],d=0;4>d;++d){var b,c;b=f+B[d];for(c=e+x[d];r(b,c)&&(a.push(new Move(f,e,b,c)),0==n[b][c]);b+=B[d],c+=x[d]);}return a}function b(f,
e){for(var a=[],d=0;4>d;++d){var b,c,g=!1;b=f+B[d];for(c=e+x[d];r(b,c);b+=B[d],c+=x[d])if(!g&&0==n[b][c])a.push(new Move(f,e,b,c));else if(!g&&0!=n[b][c])g=!0;else if(g&&0!=n[b][c]){a.push(new Move(f,e,b,c));break}}return a}function h(f,a){var b=[];4<f?b.push(new Move(f,a,f-1,a)):(r(f-1,a)&&b.push(new Move(f,a,f-1,a)),r(f,a-1)&&b.push(new Move(f,a,f,a-1)),r(f,a+1)&&b.push(new Move(f,a,f,a+1)));return b}function D(a,e){var b=[];4<a?(r(a+1,e)&&b.push(new Move(a,e,a+1,e)),r(a,e-1)&&b.push(new Move(a,
e,a,e-1)),r(a,e+1)&&b.push(new Move(a,e,a,e+1))):b.push(new Move(a,e,a+1,e));return b}function C(f,e,c){var d=l(n[f][e]),x=isRedPiece(n[f][e]),q=[];1==d?q=k(f,e):2==d?q=z(f,e):3==d?q=x?v(f,e):w(f,e):4==d?q=g(f,e):5==d?q=a(f,e):6==d?q=b(f,e):7==d&&(q=x?h(f,e):D(f,e));q.forEach(function(a){0!=n[a.i2][a.j2]&&isRedPiece(n[a.i2][a.j2])==x||c.push(a)})}function E(a){for(var e=[],b=0;10>b;++b)for(var d=0;9>d;++d)0!=n[b][d]&&isRedPiece(n[b][d])==a&&C(b,d,e);return e}this.reset=t;this.setMoves=function(a){var e=
A;t();for(var b=!0,d=0,c=0;c<a.length;++c)u(a[c][0],a[c][1],a[c][2],a[c][3]),b&&e.length>c&&e[c].i1==a[c][0]&&e[c].j1==a[c][1]&&e[c].i2==a[c][2]&&e[c].j2==a[c][3]?++d:b=!1;return d};this.move=u;this.checkMove=function(a,e,b,d){var c=p();if(!E(c).find(function(c,x,q){return c.i1==a&&c.j1==e&&c.i2==b&&c.j2==d}))return!1;if(n[b][d]==(c?PIECE_BK:PIECE_RK))return!0;var x=!1;u(a,e,b,d);E(!c).find(function(a,b,e){return n[a.i2][a.j2]==(c?PIECE_RK:PIECE_BK)})&&(x=!0);y();return!x};this.moveHistory=function(){for(var a=
[],b=0;b<A.length;++b)a.push(A[b]);return a};this.moveHistoryArrayFormat=function(){for(var a=[],b=0;b<A.length;++b){var c=A[b];a.push([c.i1,c.j1,c.i2,c.j2])}return a};this.lastMove=function(){return A[A.length-1]};this.pieceAt=function(a,b){return n[a][b]};this.isRedNext=p;this.numMoves=function(){return A.length};this.getFen=function(){for(var a="",b=0;10>b;++b){for(var c=0;9>c;++c)if(""==n[b][c]){for(var d=c+1;9>d&&""==n[b][d];)++d;a+=""+(d-c);c=d-1}else{var d=n[b][c],x=isRedPiece(d);x&&(d-=8);
var q="";1==d?q="K":2==d?q="A":3==d?q="E":4==d?q="H":5==d?q="R":6==d?q="C":7==d&&(q="P");x||(q=q.toLowerCase());a+=q}9>b&&(a+="/")}return a+=" "+(p()?"w":"b")};var n=[],A=[];t();var B=[0,1,0,-1],x=[1,0,-1,0],q=[1,1,-1,-1],c=[1,-1,-1,1]};function BoardUI(p){function l(){return document.getElementById("board")}function t(a,b){B&&(b=8-b);return n/2+b*n}function u(a,b){B&&(a=9-a);return 5>b?n/2+a*n:n/2+a*n+A}function y(a,b,c,f,e,g){var d=document.createElementNS(C,"line");d.setAttribute("x1",a);d.setAttribute("y1",b);d.setAttribute("x2",c);d.setAttribute("y2",f);d.classList.add(e);g&&(d.id=g);return d}function r(a,b,c,f,e){var g=t(a,b);b=u(a,b);var d=document.createElementNS(C,"circle");d.setAttribute("cx",g);d.setAttribute("cy",b);
d.setAttribute("r",c);d.classList.add(f[a]);d.classList.add("piece-element");e&&(d.id=e);return d}function m(a,b){return"abcdefghi"[b]+(9-a).toString()}function k(a,b,c,f,e){e&&w(b,c);var g=void 0;e&&(g="piece-outer-"+m(b,c));var g=r(b,c,23,"piece-outer",g),d=void 0;e&&(d="piece-inner-"+m(b,c));var d=r(b,c,20,"piece-inner",d),h=E[f],n=void 0;e&&(n="piece-text-"+m(b,c));e=n;n=t(b,c);b=u(b,c);c=document.createElementNS(C,"text");c.style.fontFamily="Roboto,monospace";c.style.fontSize="24px";c.setAttribute("text-anchor",
"middle");c.setAttribute("alignment-baseline","central");c.setAttribute("dominant-baseline","middle");c.setAttribute("x",n);c.setAttribute("y",b);c.appendChild(document.createTextNode(h));c.classList.add("piece-text");c.classList.add("piece-element");c.userSelect="none";e&&(c.id=e);isRedPiece(f)?(g.setAttribute("stroke","red"),d.style.stroke="red",c.style.fill="red"):(g.style.stroke="black",d.style.stroke="black",c.style.fill="black");g.style.strokeWidth=2;d.style.strokeWidth=2;g.style.fill="white";
d.style.fillOpacity=0;a.appendChild(g);a.appendChild(d);a.appendChild(c)}function z(a,b){return function(){p(a,b)}}function v(a,b){var c=r(a,b,23,"piece-cover","piece-cover-"+m(a,b));c.style.strokeWidth=0;c.style.fillOpacity=0;c.userSelect="none";c.onmousedown=z(a,b);c.touchend=c.onmousedown;g(c)}function w(b,g){var c="piece-cover-"+m(b,g);null!=document.getElementById(c)&&a(c)}function g(a){l().appendChild(a)}function a(a){l().removeChild(document.getElementById(a))}function b(a,b,c,f){var e;e=t(a,
b);a=u(a,b);b=t(c,f);c=u(c,f);e=y(e,a,b,c,"grid",void 0);e.style.strokeWidth=1;e.style.stroke="gray";g(e)}function h(){for(i=0;9>i;++i)b(0,i,4,i),0!=i&&8!=i||b(4,i,5,i),b(5,i,9,i);for(i=0;10>i;++i)b(i,0,i,8);b(0,3,2,5);b(0,5,2,3);b(7,3,9,5);b(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)v(i,j)}function D(){for(var a=l().getElementsByClassName("highlighter");0<a.length;)l().removeChild(a[0])}this.reset=function(a){if(B==a){for(a=l().getElementsByClassName("piece-element");0<a.length;)l().removeChild(a[0]);
D()}else B=a,removeAllChildren("board"),h()};this.drawPieceWithCover=function(a,b,c){k(l(),a,b,c,!0);v(a,b)};this.erasePiece=function(b,g){w(b,g);a("piece-text-"+m(b,g));a("piece-inner-"+m(b,g));a("piece-outer-"+m(b,g));v(b,g)};this.drawColorIndicator=function(a,b){var c=1;b&&(c+=8);k(a,0,0,c,!1)};this.highlightSquare=function(a,b){var c=t(a,b),f=u(a,b),e=n/6;for(a=-1;1>=a;a+=2){var h=y(c-23,f+23*a,c-23+e,f+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";g(h);h=y(c+23-e,f+23*
a,c+23,f+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";g(h)}for(a=-1;1>=a;a+=2)h=y(c+23*a,f-23,c+23*a,f-23+e,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",g(h),h=y(c+23*a,f+23-e,c+23*a,f+23,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",g(h)};this.eraseHighlights=D;var C="http://www.w3.org/2000/svg",E=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),n=50,A=0,B=!1;h()};function Board(p){function l(){for(var a=0;10>a;++a)for(var b=0;9>b;++b)m.pieceAt(a,b)!=PIECE_NONE&&k.drawPieceWithCover(a,b,m.pieceAt(a,b));g=m.numMoves()}function t(a){a=Math.max(0,a);a=Math.min(m.numMoves(),a);if(a!=g){var b=m.moveHistory();if(a>g)for(var h=g;h<a;++h)y(b[h]);else for(h=g-1;h>=a;--h)0<h?r(b[h],b[h-1]):r(b[h],null);g=a}}function u(a){return a==PIECE_NONE?!1:"r"==z?isRedPiece(a):"b"==z?!isRedPiece(a):!1}function y(a){k.erasePiece(a.i1,a.j1);a.capture&&k.erasePiece(a.i2,a.j2);k.drawPieceWithCover(a.i2,
a.j2,a.piece);k.eraseHighlights();k.highlightSquare(a.i1,a.j1);k.highlightSquare(a.i2,a.j2);w=null}function r(a,b){k.drawPieceWithCover(a.i1,a.j1,a.piece);k.erasePiece(a.i2,a.j2);a.capture&&k.drawPieceWithCover(a.i2,a.j2,a.capture);k.eraseHighlights();b&&(k.highlightSquare(b.i1,b.j1),k.highlightSquare(b.i2,b.j2));w=null}this.setState=function(a,b,h){a!=z&&(z=a,k.reset("b"==a),m.reset(),l(),w=null);v=b;a=m.moveHistory();h=m.setMoves(h);b=g;g==a.length&&(b=m.numMoves());for(b=Math.min(b,m.numMoves());g>
h;--g){var p=g-1;0<p?r(a[p],a[p-1]):r(a[p],null)}t(b)};this.resetState=function(a,b,h){z=a;k.reset("b"==a);m.reset();m.setMoves(h);l();w=null;g=m.numMoves();0<m.numMoves()&&(a=m.lastMove(),k.highlightSquare(a.i1,a.j1),k.highlightSquare(a.i2,a.j2))};this.showMove=t;this.isRedNext=function(){return m.isRedNext()};this.numMoves=function(){return m.numMoves()};this.numMovesShown=function(){return g};this.getFen=function(){for(var a=m.moveHistoryArrayFormat(),b=[],h=0;h<g;++h)b.push(a[h]);m.setMoves(b);
b=m.getFen();m.setMoves(a);return b};var m=new Chess,k=new BoardUI(function(a,b){if(!v){var h=m.isRedNext();if(("r"==z&&h||"b"==z&&!h)&&g==m.numMoves())if(w)if(m.checkMove(w[0],w[1],a,b)){var h=w[0],l=w[1];y(m.move(h,l,a,b));++g;p(h,l,a,b)}else u(m.pieceAt(a,b))&&(k.eraseHighlights(),w=[a,b],k.highlightSquare(a,b));else u(m.pieceAt(a,b))&&(k.eraseHighlights(),w=[a,b],k.highlightSquare(a,b))}}),z="r",v=!0,w=null,g=0;k.drawColorIndicator(document.getElementById("redIndicator"),!0);k.drawColorIndicator(document.getElementById("blackIndicator"),
!1);l()};function ExperimentViewer(p,l){function t(g,a,b,h,m,k){var l=new XMLHttpRequest;l.onreadystatechange=function(){4==l.readyState&&(200<=l.status&&299>=l.status?m(l.responseText):k&&k(l.responseText))};l.open(g,a,!0);b&&l.setRequestHeader("Content-type",b);h?l.send(h):l.send()}function u(g,a,b){t("GET",g,void 0,void 0,a,b)}function y(g){var a=document.getElementById("game-record-"+g);a?(a.classList.add("pendingSelection"),r(g)):alert("Game "+g+" does not exist.")}function r(g){u(encodeURI("/game_record/"+
p.id+"/"+g),function(a){v=JSON.parse(a);w&&w.classList.remove("selectedGame");a=document.getElementById("game-record-"+g);a.classList.remove("pendingSelection");a.classList.add("selectedGame");w=a;window.location.hash="#"+g;m()},function(a,b){var g=document.getElementById("game-record-"+a);g&&g.classList.remove("pendingSelection");alert("Failed to retrieve game record")})}function m(){removeAllChildren("red-player");var g=document.getElementById("red-player"),a=document.createElement("span");v&&a.appendChild(document.createTextNode(v.red.name));
g.appendChild(a);removeAllChildren("black-player");g=document.getElementById("black-player");a=document.createElement("span");v&&a.appendChild(document.createTextNode(v.black.name));g.appendChild(a);board_.resetState("r",!0,parseMoves(v?v.moves:""));removeAllChildren("gameTitle");a=document.getElementById("gameTitle");g=document.createElement("h3");g.appendChild(document.createTextNode(v?v.title:""));a.appendChild(g);var a=document.getElementById("playingStatus"),g=document.getElementById("redWonStatus"),
b=document.getElementById("blackWonStatus"),h=document.getElementById("drawStatus");a.style.display="none";g.style.display="none";b.style.display="none";h.style.display="none";v&&(v.moves.endsWith("R")?g.style.display="inline-block":v.moves.endsWith("B")?b.style.display="inline-block":v.moves.endsWith("D")?h.style.display="inline-block":a.style.display="inline-block");z()}function k(g,a){var b=document.createElement("td");b.appendChild(a);g.appendChild(b)}function z(){removeAllChildren("move-history");
var g=document.getElementById("move-history"),a=document.createElement("table");a.id="moveHistoryControls";var b=document.createElement("tr");a.appendChild(b);0<board_.numMovesShown()?(k(b,createLink("move-history-first",void 0,"#",function(){board_.showMove(0);z();return!1},"first")),k(b,createLink("move-history-prev",void 0,"#",function(){board_.showMove(board_.numMovesShown()-1);z();return!1},"prev"))):(k(b,document.createTextNode("first")),k(b,document.createTextNode("prev")));k(b,document.createTextNode(""+
board_.numMovesShown()+" / "+board_.numMoves()));board_.numMovesShown()<board_.numMoves()?(k(b,createLink("move-history-next",void 0,"#",function(){board_.showMove(board_.numMovesShown()+1);z();return!1},"next")),k(b,createLink("move-history-last",void 0,"#",function(){board_.showMove(board_.numMoves());z();return!1},"last"))):(k(b,document.createTextNode("next")),k(b,document.createTextNode("last")));g.appendChild(a);g=document.getElementById("fen");removeAllChildren("fen");g.appendChild(document.createTextNode(board_.getFen()))}
var v=null,w=null;board_=new Board(function(g,a,b,h){});(function(){for(var g=document.getElementById("gameList"),a=0;a<l.length;a++){var b=l[a],h=b.hasOwnProperty("control_is_red")&&b.control_is_red,m=document.createElement("tr"),k=document.createElement("td"),p=0;b.hasOwnProperty("result")&&(1==b.result?p=h?2:1:2==b.result&&(p=h?1:2));0==p?(k.appendChild(document.createTextNode("D")),k.classList.add("draw")):1==p?(k.appendChild(document.createTextNode("W")),k.classList.add("win")):(k.appendChild(document.createTextNode("L")),
k.classList.add("loss"));m.appendChild(k);k=document.createElement("td");k.appendChild(document.createTextNode(b.game_id));k.onclick=function(a){return function(){y(a.game_id)}}(b);k.id="game-record-"+b.game_id;m.appendChild(k);g.appendChild(m)}})();m();window.location.hash?y(window.location.hash.substring(1)):0<l.length&&y(l[0].game_id)}document.onreadystatechange=function(){"interactive"==document.readyState&&new ExperimentViewer(experimentMetadata,toc)};

function parseMoves(l){l=l.split("/");for(var p=[],t=1;t<l.length;++t){var u=l[t];if("R"==u||"B"==u||"D"==u)break;p.push([parseInt(u[0],10),parseInt(u[1],10),parseInt(u[2],10),parseInt(u[3],10)])}return p}function removeAllChildren(l){for(l=document.getElementById(l);l.lastChild;)l.removeChild(l.lastChild)}function createLink(l,p,t,u,y){var q=document.createElement("a");l&&(q.id=l);p&&(q.className=p);q.href=t;u&&(q.onclick=u);q.appendChild(document.createTextNode(y));return q}
String.prototype.endsWith||(String.prototype.endsWith=function(l,p){var t=this.toString();if(void 0===p||p>t.length)p=t.length;p-=l.length;t=t.indexOf(l,p);return-1!==t&&t===p});var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(l){return 8<=l}function Move(l,p,t,u,y,q){this.i1=l;this.j1=p;this.i2=t;this.j2=u;this.piece=y||PIECE_NONE;this.capture=q||PIECE_NONE}
function Chess(){function l(){return 0==A.length%2}function p(f){return 8<=f?f-8:f}function t(){n=[];A=[];for(var f=0;10>f;++f){n.push([]);for(var c=0;9>c;++c)n[f].push(0)}f="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=f.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(c=0;10>c;++c)for(var a=0,d=0;d<f[c].length;++d){if(9<=a)throw"Malformed fen string at row "+c+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var r=f[c][d];if("0"<=r&&"9">=r)a+=parseInt(f[c][d],10);else{var r=n[c],b=a,e=f[c][d],v=e==e.toLowerCase(),e=e.toLowerCase(),g=0;"k"==e?g=1:"a"==e?g=2:"e"==e?g=3:"h"==e?g=4:"r"==e?g=5:"c"==e?g=6:"p"==e&&(g=7);v||(g+=8);r[b]=g;++a}}}function u(f,c,a,d){A.push(new Move(f,c,a,d,n[f][c],n[a][d]));n[a][d]=n[f][c];n[f][c]=0;return A[A.length-1]}function y(){var f=A.pop();n[f.i1][f.j1]=n[f.i2][f.j2];n[f.i2][f.j2]=f.capture}function q(f,c){return 0<=f&&10>f&&0<=c&&9>c}function m(f,c){return 3<=c&&5>=c&&(0<=
f&&2>=f||7<=f&&9>=f)}function k(f,c){for(var a=[],d=0;4>d;++d)m(f+B[d],c+r[d])&&a.push(new Move(f,c,f+B[d],c+r[d]));for(d=-1;1>=d;d+=2)for(var b=f+d;0<=b&&10>b&&(p(n[b][c])==PIECE_K&&a.push(new Move(f,c,b,c)),0==n[b][c]);b+=d);return a}function z(f,c){for(var a=[],d=0;4>d;++d)m(f+v[d],c+e[d])&&a.push(new Move(f,c,f+v[d],c+e[d]));return a}function w(f,c){for(var a=[],d=0;4>d;++d)q(f+2*v[d],c+2*e[d])&&0==n[f+v[d]][c+e[d]]&&4<f+v[d]&&a.push(new Move(f,c,f+2*v[d],c+2*e[d]));return a}function x(f,c){for(var a=
[],d=0;4>d;++d)!q(f+2*v[d],c+2*e[d])||0!=n[f+v[d]][c+e[d]]||4<f+v[d]||a.push(new Move(f,c,f+2*v[d],c+2*e[d]));return a}function g(f,c){var a=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(d){q(f+d[0],c+d[1])&&0==n[f+d[2]][c+d[3]]&&a.push(new Move(f,c,f+d[0],c+d[1]))});return a}function a(f,c){for(var a=[],d=0;4>d;++d){var b,e;b=f+B[d];for(e=c+r[d];q(b,e)&&(a.push(new Move(f,c,b,e)),0==n[b][e]);b+=B[d],e+=r[d]);}return a}function b(f,
c){for(var a=[],d=0;4>d;++d){var b,e,g=!1;b=f+B[d];for(e=c+r[d];q(b,e);b+=B[d],e+=r[d])if(!g&&0==n[b][e])a.push(new Move(f,c,b,e));else if(!g&&0!=n[b][e])g=!0;else if(g&&0!=n[b][e]){a.push(new Move(f,c,b,e));break}}return a}function h(f,a){var b=[];4<f?b.push(new Move(f,a,f-1,a)):(q(f-1,a)&&b.push(new Move(f,a,f-1,a)),q(f,a-1)&&b.push(new Move(f,a,f,a-1)),q(f,a+1)&&b.push(new Move(f,a,f,a+1)));return b}function D(a,c){var b=[];4<a?(q(a+1,c)&&b.push(new Move(a,c,a+1,c)),q(a,c-1)&&b.push(new Move(a,
c,a,c-1)),q(a,c+1)&&b.push(new Move(a,c,a,c+1))):b.push(new Move(a,c,a+1,c));return b}function C(f,c,e){var d=p(n[f][c]),r=isRedPiece(n[f][c]),v=[];1==d?v=k(f,c):2==d?v=z(f,c):3==d?v=r?w(f,c):x(f,c):4==d?v=g(f,c):5==d?v=a(f,c):6==d?v=b(f,c):7==d&&(v=r?h(f,c):D(f,c));v.forEach(function(a){0!=n[a.i2][a.j2]&&isRedPiece(n[a.i2][a.j2])==r||e.push(a)})}function E(a){for(var c=[],b=0;10>b;++b)for(var d=0;9>d;++d)0!=n[b][d]&&isRedPiece(n[b][d])==a&&C(b,d,c);return c}this.reset=t;this.setMoves=function(a){var c=
A;t();for(var b=!0,d=0,e=0;e<a.length;++e)u(a[e][0],a[e][1],a[e][2],a[e][3]),b&&c.length>e&&c[e].i1==a[e][0]&&c[e].j1==a[e][1]&&c[e].i2==a[e][2]&&c[e].j2==a[e][3]?++d:b=!1;return d};this.move=u;this.checkMove=function(a,c,b,d){var e=l();if(!E(e).find(function(e,r,v){return e.i1==a&&e.j1==c&&e.i2==b&&e.j2==d}))return!1;if(n[b][d]==(e?PIECE_BK:PIECE_RK))return!0;var r=!1;u(a,c,b,d);E(!e).find(function(a,c,d){return n[a.i2][a.j2]==(e?PIECE_RK:PIECE_BK)})&&(r=!0);y();return!r};this.moveHistory=function(){for(var a=
[],c=0;c<A.length;++c)a.push(A[c]);return a};this.moveHistoryArrayFormat=function(){for(var a=[],c=0;c<A.length;++c){var b=A[c];a.push([b.i1,b.j1,b.i2,b.j2])}return a};this.lastMove=function(){return A[A.length-1]};this.pieceAt=function(a,c){return n[a][c]};this.isRedNext=l;this.numMoves=function(){return A.length};this.getFen=function(){for(var a="",c=0;10>c;++c){for(var b=0;9>b;++b)if(""==n[c][b]){for(var d=b+1;9>d&&""==n[c][d];)++d;a+=""+(d-b);b=d-1}else{var d=n[c][b],e=isRedPiece(d);e&&(d-=8);
var r="";1==d?r="K":2==d?r="A":3==d?r="E":4==d?r="H":5==d?r="R":6==d?r="C":7==d&&(r="P");e||(r=r.toLowerCase());a+=r}9>c&&(a+="/")}return a+=" "+(l()?"w":"b")};var n=[],A=[];t();var B=[0,1,0,-1],r=[1,0,-1,0],v=[1,1,-1,-1],e=[1,-1,-1,1]};function BoardUI(l){function p(){return document.getElementById("board")}function t(a,b){B&&(b=8-b);return n/2+b*n}function u(a,b){B&&(a=9-a);return 5>b?n/2+a*n:n/2+a*n+A}function y(a,b,e,f,c,g){var d=document.createElementNS(C,"line");d.setAttribute("x1",a);d.setAttribute("y1",b);d.setAttribute("x2",e);d.setAttribute("y2",f);d.classList.add(c);g&&(d.id=g);return d}function q(a,b,e,f,c){var g=t(a,b);b=u(a,b);var d=document.createElementNS(C,"circle");d.setAttribute("cx",g);d.setAttribute("cy",b);
d.setAttribute("r",e);d.classList.add(f[a]);d.classList.add("piece-element");c&&(d.id=c);return d}function m(a,b){return"abcdefghi"[b]+(9-a).toString()}function k(a,b,e,f,c){c&&x(b,e);var g=void 0;c&&(g="piece-outer-"+m(b,e));var g=q(b,e,23,"piece-outer",g),d=void 0;c&&(d="piece-inner-"+m(b,e));var d=q(b,e,20,"piece-inner",d),h=E[f],n=void 0;c&&(n="piece-text-"+m(b,e));c=n;n=t(b,e);b=u(b,e);e=document.createElementNS(C,"text");e.style.fontFamily="Roboto,monospace";e.style.fontSize="24px";e.setAttribute("text-anchor",
"middle");e.setAttribute("alignment-baseline","central");e.setAttribute("dominant-baseline","middle");e.setAttribute("x",n);e.setAttribute("y",b);e.appendChild(document.createTextNode(h));e.classList.add("piece-text");e.classList.add("piece-element");e.userSelect="none";c&&(e.id=c);isRedPiece(f)?(g.setAttribute("stroke","red"),d.style.stroke="red",e.style.fill="red"):(g.style.stroke="black",d.style.stroke="black",e.style.fill="black");g.style.strokeWidth=2;d.style.strokeWidth=2;g.style.fill="white";
d.style.fillOpacity=0;a.appendChild(g);a.appendChild(d);a.appendChild(e)}function z(a,b){return function(){l(a,b)}}function w(a,b){var e=q(a,b,23,"piece-cover","piece-cover-"+m(a,b));e.style.strokeWidth=0;e.style.fillOpacity=0;e.userSelect="none";e.onmousedown=z(a,b);e.touchend=e.onmousedown;g(e)}function x(b,g){var e="piece-cover-"+m(b,g);null!=document.getElementById(e)&&a(e)}function g(a){p().appendChild(a)}function a(a){p().removeChild(document.getElementById(a))}function b(a,b,e,f){var c;c=t(a,
b);a=u(a,b);b=t(e,f);e=u(e,f);c=y(c,a,b,e,"grid",void 0);c.style.strokeWidth=1;c.style.stroke="gray";g(c)}function h(){for(i=0;9>i;++i)b(0,i,4,i),0!=i&&8!=i||b(4,i,5,i),b(5,i,9,i);for(i=0;10>i;++i)b(i,0,i,8);b(0,3,2,5);b(0,5,2,3);b(7,3,9,5);b(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)w(i,j)}function D(){for(var a=p().getElementsByClassName("highlighter");0<a.length;)p().removeChild(a[0])}this.reset=function(a){if(B==a){for(a=p().getElementsByClassName("piece-element");0<a.length;)p().removeChild(a[0]);
D()}else B=a,removeAllChildren("board"),h()};this.drawPieceWithCover=function(a,b,e){k(p(),a,b,e,!0);w(a,b)};this.erasePiece=function(b,g){x(b,g);a("piece-text-"+m(b,g));a("piece-inner-"+m(b,g));a("piece-outer-"+m(b,g));w(b,g)};this.drawColorIndicator=function(a,b){var e=1;b&&(e+=8);k(a,0,0,e,!1)};this.highlightSquare=function(a,b){var e=t(a,b),f=u(a,b),c=n/6;for(a=-1;1>=a;a+=2){var h=y(e-23,f+23*a,e-23+c,f+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";g(h);h=y(e+23-c,f+23*
a,e+23,f+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";g(h)}for(a=-1;1>=a;a+=2)h=y(e+23*a,f-23,e+23*a,f-23+c,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",g(h),h=y(e+23*a,f+23-c,e+23*a,f+23,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",g(h)};this.eraseHighlights=D;var C="http://www.w3.org/2000/svg",E=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),n=50,A=0,B=!1;h()};function Board(l){function p(){for(var a=0;10>a;++a)for(var b=0;9>b;++b)m.pieceAt(a,b)!=PIECE_NONE&&k.drawPieceWithCover(a,b,m.pieceAt(a,b));g=m.numMoves()}function t(a){a=Math.max(0,a);a=Math.min(m.numMoves(),a);if(a!=g){var b=m.moveHistory();if(a>g)for(var h=g;h<a;++h)y(b[h]);else for(h=g-1;h>=a;--h)0<h?q(b[h],b[h-1]):q(b[h],null);g=a}}function u(a){return a==PIECE_NONE?!1:"r"==z?isRedPiece(a):"b"==z?!isRedPiece(a):!1}function y(a){k.erasePiece(a.i1,a.j1);a.capture&&k.erasePiece(a.i2,a.j2);k.drawPieceWithCover(a.i2,
a.j2,a.piece);k.eraseHighlights();k.highlightSquare(a.i1,a.j1);k.highlightSquare(a.i2,a.j2);x=null}function q(a,b){k.drawPieceWithCover(a.i1,a.j1,a.piece);k.erasePiece(a.i2,a.j2);a.capture&&k.drawPieceWithCover(a.i2,a.j2,a.capture);k.eraseHighlights();b&&(k.highlightSquare(b.i1,b.j1),k.highlightSquare(b.i2,b.j2));x=null}this.setState=function(a,b,h){a!=z&&(z=a,k.reset("b"==a),m.reset(),p(),x=null);w=b;a=m.moveHistory();h=m.setMoves(h);b=g;g==a.length&&(b=m.numMoves());for(b=Math.min(b,m.numMoves());g>
h;--g){var l=g-1;0<l?q(a[l],a[l-1]):q(a[l],null)}t(b)};this.resetState=function(a,b,h){z=a;k.reset("b"==a);m.reset();m.setMoves(h);p();x=null;g=m.numMoves();0<m.numMoves()&&(a=m.lastMove(),k.highlightSquare(a.i1,a.j1),k.highlightSquare(a.i2,a.j2))};this.showMove=t;this.isRedNext=function(){return m.isRedNext()};this.numMoves=function(){return m.numMoves()};this.numMovesShown=function(){return g};this.getFen=function(){for(var a=m.moveHistoryArrayFormat(),b=[],h=0;h<g;++h)b.push(a[h]);m.setMoves(b);
b=m.getFen();m.setMoves(a);return b};var m=new Chess,k=new BoardUI(function(a,b){if(!w){var h=m.isRedNext();if(("r"==z&&h||"b"==z&&!h)&&g==m.numMoves())if(x)if(m.checkMove(x[0],x[1],a,b)){var h=x[0],p=x[1];y(m.move(h,p,a,b));++g;l(h,p,a,b)}else u(m.pieceAt(a,b))&&(k.eraseHighlights(),x=[a,b],k.highlightSquare(a,b));else u(m.pieceAt(a,b))&&(k.eraseHighlights(),x=[a,b],k.highlightSquare(a,b))}}),z="r",w=!0,x=null,g=0;k.drawColorIndicator(document.getElementById("redIndicator"),!0);k.drawColorIndicator(document.getElementById("blackIndicator"),
!1);p()};function ExperimentViewer(l,p){function t(g,a,b,h,m,k){var l=new XMLHttpRequest;l.onreadystatechange=function(){4==l.readyState&&(200<=l.status&&299>=l.status?m(l.responseText):k&&k(l.responseText))};l.open(g,a,!0);b&&l.setRequestHeader("Content-type",b);h?l.send(h):l.send()}function u(g,a,b){t("GET",g,void 0,void 0,a,b)}function y(g){var a=document.getElementById("game-record-"+g);a?(a.classList.add("pendingSelection"),q(g)):alert("Game "+g+" does not exist.")}function q(g){u(encodeURI("/game_record/"+
l.id+"/"+g),function(a){w=JSON.parse(a);x&&x.classList.remove("selectedGame");a=document.getElementById("game-record-"+g);a.classList.remove("pendingSelection");a.classList.add("selectedGame");x=a;window.location.hash="#"+g;m()},function(a,b){var g=document.getElementById("game-record-"+a);g&&g.classList.remove("pendingSelection");alert("Failed to retrieve game record")})}function m(){removeAllChildren("red-player");var g=document.getElementById("red-player"),a=document.createElement("span");w&&a.appendChild(document.createTextNode(w.red.name));
g.appendChild(a);removeAllChildren("black-player");g=document.getElementById("black-player");a=document.createElement("span");w&&a.appendChild(document.createTextNode(w.black.name));g.appendChild(a);board_.resetState("r",!0,parseMoves(w?w.moves:""));removeAllChildren("gameTitle");a=document.getElementById("gameTitle");g=document.createElement("h3");g.appendChild(document.createTextNode(w?w.title:""));a.appendChild(g);var a=document.getElementById("playingStatus"),g=document.getElementById("redWonStatus"),
b=document.getElementById("blackWonStatus"),h=document.getElementById("drawStatus");a.style.display="none";g.style.display="none";b.style.display="none";h.style.display="none";w&&(w.moves.endsWith("R")?g.style.display="inline-block":w.moves.endsWith("B")?b.style.display="inline-block":w.moves.endsWith("D")?h.style.display="inline-block":a.style.display="inline-block");z()}function k(g,a){var b=document.createElement("td");b.appendChild(a);g.appendChild(b)}function z(){removeAllChildren("move-history");
var g=document.getElementById("move-history"),a=document.createElement("table");a.id="moveHistoryControls";var b=document.createElement("tr");a.appendChild(b);0<board_.numMovesShown()?(k(b,createLink("move-history-first",void 0,"#",function(){board_.showMove(0);z();return!1},"first")),k(b,createLink("move-history-prev",void 0,"#",function(){board_.showMove(board_.numMovesShown()-1);z();return!1},"prev"))):(k(b,document.createTextNode("first")),k(b,document.createTextNode("prev")));k(b,document.createTextNode(""+
board_.numMovesShown()+" / "+board_.numMoves()));board_.numMovesShown()<board_.numMoves()?(k(b,createLink("move-history-next",void 0,"#",function(){board_.showMove(board_.numMovesShown()+1);z();return!1},"next")),k(b,createLink("move-history-last",void 0,"#",function(){board_.showMove(board_.numMoves());z();return!1},"last"))):(k(b,document.createTextNode("next")),k(b,document.createTextNode("last")));g.appendChild(a);g=document.getElementById("fen");removeAllChildren("fen");g.appendChild(document.createTextNode(board_.getFen()))}
var w=null,x=null;board_=new Board(function(g,a,b,h){});(function(){for(var g=l.hasOwnProperty("control_is_red")&&l.control_is_red,a=document.getElementById("gameList"),b=0;b<p.length;b++){var h=p[b],m=document.createElement("tr"),k=document.createElement("td"),q=0;h.hasOwnProperty("result")&&(1==h.result?q=g?2:1:2==h.result&&(q=g?1:2));0==q?(k.appendChild(document.createTextNode("D")),k.classList.add("draw")):1==q?(k.appendChild(document.createTextNode("W")),k.classList.add("win")):(k.appendChild(document.createTextNode("L")),
k.classList.add("loss"));m.appendChild(k);k=document.createElement("td");k.appendChild(document.createTextNode(h.game_id));k.onclick=function(a){return function(){y(a.game_id)}}(h);k.id="game-record-"+h.game_id;m.appendChild(k);a.appendChild(m)}})();m();window.location.hash?y(window.location.hash.substring(1)):0<p.length&&y(p[0].game_id)}document.onreadystatechange=function(){"interactive"==document.readyState&&new ExperimentViewer(experimentMetadata,toc)};

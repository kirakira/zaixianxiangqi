function parseMoves(a){a=a.split("/");for(var b=[],c=1;c<a.length;++c){var d=a[c];if("R"==d||"B"==d||"D"==d)break;b.push([parseInt(d[0],10),parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10)])}return b}function removeAllChildren(a){for(a=document.getElementById(a);a.lastChild;)a.removeChild(a.lastChild)}
function createLink(a,b,c,d,m){var l=document.createElement("a");a&&(l.id=a);b.forEach(function(a){l.classList.add(a)});l.href=c;d&&(l.onclick=d);l.appendChild(document.createTextNode(m));return l}String.prototype.endsWith||(String.prototype.endsWith=function(a,b){var c=this.toString();if(void 0===b||b>c.length)b=c.length;b-=a.length;c=c.indexOf(a,b);return-1!==c&&c===b});
function ajax(a,b,c,d,m,l){var h=new XMLHttpRequest;h.onreadystatechange=function(){4==h.readyState&&(200<=h.status&&299>=h.status?m(h.responseText):l(h.responseText))};h.open(a,b,!0);c&&h.setRequestHeader("Content-type",c);d?h.send(d):h.send()}function ajaxGet(a,b,c){ajax("GET",a,void 0,void 0,b,c)}function ajaxPost(a,b,c,d){ajax("POST",a,"application/x-www-form-urlencoded; charset=UTF-8",b,c,d)}
function enableLink(a,b){var c=document.getElementById(a);b?c.classList.remove("disabled"):c.classList.add("disabled")}function getCookie(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;++c){for(var d=b[c];" "==d.charAt(0);)d=d.substring(1);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return""}function getSid(){return getCookie("sid")}function setSpanText(a,b){removeAllChildren(a);document.getElementById(a).appendChild(document.createTextNode(b))};var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(a){return 8<=a}function Move(a,b,c,d,m,l){this.i1=a;this.j1=b;this.i2=c;this.j2=d;this.piece=m||PIECE_NONE;this.capture=l||PIECE_NONE}
function Chess(){function a(){return 0==v.length%2}function b(n){return 8<=n?n-8:n}function c(){k=[];v=[];for(var n=0;10>n;++n){k.push([]);for(var t=0;9>t;++t)k[n].push(0)}n="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=n.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(t=0;10>t;++t)for(var a=0,b=0;b<n[t].length;++b){if(9<=a)throw"Malformed fen string at row "+t+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var c=n[t][b];if("0"<=c&&"9">=c)a+=parseInt(n[t][b],10);else{var c=k[t],g=a,e=n[t][b],r=e==e.toLowerCase(),e=e.toLowerCase(),d=0;"k"==e?d=1:"a"==e?d=2:"e"==e?d=3:"h"==e?d=4:"r"==e?d=5:"c"==e?d=6:"p"==e&&(d=7);r||(d+=8);c[g]=d;++a}}}function d(n,t,a,b){v.push(new Move(n,t,a,b,k[n][t],k[a][b]));k[a][b]=k[n][t];k[n][t]=0;return v[v.length-1]}function m(){var n=v.pop();k[n.i1][n.j1]=k[n.i2][n.j2];k[n.i2][n.j2]=n.capture}function l(n,a){return 0<=n&&10>n&&0<=a&&9>a}function h(n,a){return 3<=a&&5>=a&&(0<=
n&&2>=n||7<=n&&9>=n)}function g(a,t){for(var c=[],f=0;4>f;++f)h(a+z[f],t+r[f])&&c.push(new Move(a,t,a+z[f],t+r[f]));for(f=-1;1>=f;f+=2)for(var e=a+f;0<=e&&10>e&&(b(k[e][t])==PIECE_K&&c.push(new Move(a,t,e,t)),0==k[e][t]);e+=f);return c}function x(a,b){for(var c=[],f=0;4>f;++f)h(a+B[f],b+u[f])&&c.push(new Move(a,b,a+B[f],b+u[f]));return c}function A(a,b){for(var c=[],f=0;4>f;++f)l(a+2*B[f],b+2*u[f])&&0==k[a+B[f]][b+u[f]]&&4<a+B[f]&&c.push(new Move(a,b,a+2*B[f],b+2*u[f]));return c}function w(a,b){for(var c=
[],f=0;4>f;++f)!l(a+2*B[f],b+2*u[f])||0!=k[a+B[f]][b+u[f]]||4<a+B[f]||c.push(new Move(a,b,a+2*B[f],b+2*u[f]));return c}function p(a,b){var c=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(f){l(a+f[0],b+f[1])&&0==k[a+f[2]][b+f[3]]&&c.push(new Move(a,b,a+f[0],b+f[1]))});return c}function e(a,b){for(var c=[],f=0;4>f;++f){var e,g;e=a+z[f];for(g=b+r[f];l(e,g)&&(c.push(new Move(a,b,e,g)),0==k[e][g]);e+=z[f],g+=r[f]);}return c}function q(a,
b){for(var c=[],f=0;4>f;++f){var e,g,d=!1;e=a+z[f];for(g=b+r[f];l(e,g);e+=z[f],g+=r[f])if(!d&&0==k[e][g])c.push(new Move(a,b,e,g));else if(!d&&0!=k[e][g])d=!0;else if(d&&0!=k[e][g]){c.push(new Move(a,b,e,g));break}}return c}function D(a,b){var c=[];4<a?c.push(new Move(a,b,a-1,b)):(l(a-1,b)&&c.push(new Move(a,b,a-1,b)),l(a,b-1)&&c.push(new Move(a,b,a,b-1)),l(a,b+1)&&c.push(new Move(a,b,a,b+1)));return c}function y(a,b){var c=[];4<a?(l(a+1,b)&&c.push(new Move(a,b,a+1,b)),l(a,b-1)&&c.push(new Move(a,
b,a,b-1)),l(a,b+1)&&c.push(new Move(a,b,a,b+1))):c.push(new Move(a,b,a+1,b));return c}function C(a,c,d){var f=b(k[a][c]),r=isRedPiece(k[a][c]),u=[];1==f?u=g(a,c):2==f?u=x(a,c):3==f?u=r?A(a,c):w(a,c):4==f?u=p(a,c):5==f?u=e(a,c):6==f?u=q(a,c):7==f&&(u=r?D(a,c):y(a,c));u.forEach(function(a){0!=k[a.i2][a.j2]&&isRedPiece(k[a.i2][a.j2])==r||d.push(a)})}function E(a){for(var b=[],c=0;10>c;++c)for(var f=0;9>f;++f)0!=k[c][f]&&isRedPiece(k[c][f])==a&&C(c,f,b);return b}this.reset=c;this.setMoves=function(a){var b=
v;c();for(var e=!0,f=0,g=0;g<a.length;++g)d(a[g][0],a[g][1],a[g][2],a[g][3]),e&&b.length>g&&b[g].i1==a[g][0]&&b[g].j1==a[g][1]&&b[g].i2==a[g][2]&&b[g].j2==a[g][3]?++f:e=!1;return f};this.move=d;this.checkMove=function(b,c,g,f){var e=a();if(!E(e).find(function(a,e,d){return a.i1==b&&a.j1==c&&a.i2==g&&a.j2==f}))return!1;if(k[g][f]==(e?PIECE_BK:PIECE_RK))return!0;var r=!1;d(b,c,g,f);E(!e).find(function(a,b,c){return k[a.i2][a.j2]==(e?PIECE_RK:PIECE_BK)})&&(r=!0);m();return!r};this.moveHistory=function(){for(var a=
[],b=0;b<v.length;++b)a.push(v[b]);return a};this.moveHistoryArrayFormat=function(){for(var a=[],b=0;b<v.length;++b){var c=v[b];a.push([c.i1,c.j1,c.i2,c.j2])}return a};this.lastMove=function(){return v[v.length-1]};this.pieceAt=function(a,b){return k[a][b]};this.isRedNext=a;this.numMoves=function(){return v.length};this.getFen=function(){for(var b="",c=0;10>c;++c){for(var g=0;9>g;++g)if(""==k[c][g]){for(var e=g+1;9>e&&""==k[c][e];)++e;b+=""+(e-g);g=e-1}else{var e=k[c][g],d=isRedPiece(e);d&&(e-=8);
var r="";1==e?r="K":2==e?r="A":3==e?r="E":4==e?r="H":5==e?r="R":6==e?r="C":7==e&&(r="P");d||(r=r.toLowerCase());b+=r}9>c&&(b+="/")}return b+=" "+(a()?"w":"b")};var k=[],v=[];c();var z=[0,1,0,-1],r=[1,0,-1,0],B=[1,1,-1,-1],u=[1,-1,-1,1]};function BoardUI(a){function b(){return document.getElementById("board")}function c(a,b){z&&(b=8-b);return k/2+b*k}function d(a,b){z&&(a=9-a);return 5>b?k/2+a*k:k/2+a*k+v}function m(a,b,c,e,g,d){var f=document.createElementNS(C,"line");f.setAttribute("x1",a);f.setAttribute("y1",b);f.setAttribute("x2",c);f.setAttribute("y2",e);f.classList.add(g);d&&(f.id=d);return f}function l(a,b,e,g,h){var q=c(a,b);b=d(a,b);var f=document.createElementNS(C,"circle");f.setAttribute("cx",q);f.setAttribute("cy",b);
f.setAttribute("r",e);f.classList.add(g[a]);f.classList.add("piece-element");h&&(f.id=h);return f}function h(a,b){return"abcdefghi"[b]+(9-a).toString()}function g(a,b,e,g,q){q&&w(b,e);var k=void 0;q&&(k="piece-outer-"+h(b,e));var k=l(b,e,23,"piece-outer",k),f=void 0;q&&(f="piece-inner-"+h(b,e));var f=l(b,e,20,"piece-inner",f),x=E[g],m=void 0;q&&(m="piece-text-"+h(b,e));q=m;m=c(b,e);b=d(b,e);e=document.createElementNS(C,"text");e.style.fontFamily="Roboto,monospace";e.style.fontSize="24px";e.setAttribute("text-anchor",
"middle");e.setAttribute("alignment-baseline","central");e.setAttribute("dominant-baseline","middle");e.setAttribute("font-weight","bold");e.setAttribute("x",m);e.setAttribute("y",b);e.appendChild(document.createTextNode(x));e.classList.add("piece-text");e.classList.add("piece-element");e.userSelect="none";q&&(e.id=q);isRedPiece(g)?(k.setAttribute("stroke","red"),f.style.stroke="red",e.style.fill="red"):(k.style.stroke="black",f.style.stroke="black",e.style.fill="black");k.style.strokeWidth=2;f.style.strokeWidth=
2;k.style.fill="white";f.style.fillOpacity=0;a.appendChild(k);a.appendChild(f);a.appendChild(e)}function x(b,c){return function(){a(b,c)}}function A(a,b){var c=l(a,b,23,"piece-cover","piece-cover-"+h(a,b));c.style.strokeWidth=0;c.style.fillOpacity=0;c.userSelect="none";c.onmousedown=x(a,b);c.touchend=c.onmousedown;p(c)}function w(a,b){var c="piece-cover-"+h(a,b);null!=document.getElementById(c)&&e(c)}function p(a){b().appendChild(a)}function e(a){b().removeChild(document.getElementById(a))}function q(a,
b,e,g){var q;q=c(a,b);a=d(a,b);b=c(e,g);e=d(e,g);q=m(q,a,b,e,"grid",void 0);q.style.strokeWidth=1;q.style.stroke="gray";p(q)}function D(){for(i=0;9>i;++i)q(0,i,4,i),0!=i&&8!=i||q(4,i,5,i),q(5,i,9,i);for(i=0;10>i;++i)q(i,0,i,8);q(0,3,2,5);q(0,5,2,3);q(7,3,9,5);q(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)A(i,j)}function y(){for(var a=b().getElementsByClassName("highlighter");0<a.length;)b().removeChild(a[0])}this.reset=function(a){if(z==a){for(a=b().getElementsByClassName("piece-element");0<a.length;)b().removeChild(a[0]);
y()}else z=a,removeAllChildren("board"),D()};this.drawPieceWithCover=function(a,c,e){g(b(),a,c,e,!0);A(a,c)};this.erasePiece=function(a,b){w(a,b);e("piece-text-"+h(a,b));e("piece-inner-"+h(a,b));e("piece-outer-"+h(a,b));A(a,b)};this.drawColorIndicator=function(a,b){var c=1;b&&(c+=8);g(a,0,0,c,!1)};this.highlightSquare=function(a,b){var e=c(a,b),g=d(a,b),q=k/6;for(a=-1;1>=a;a+=2){var h=m(e-23,g+23*a,e-23+q,g+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";p(h);h=m(e+23-q,g+23*
a,e+23,g+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";p(h)}for(a=-1;1>=a;a+=2)h=m(e+23*a,g-23,e+23*a,g-23+q,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",p(h),h=m(e+23*a,g+23-q,e+23*a,g+23,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",p(h)};this.eraseHighlights=y;var C="http://www.w3.org/2000/svg",E=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),k=50,v=0,z=!1;D()};function Board(a){function b(){for(var a=0;10>a;++a)for(var b=0;9>b;++b)h.pieceAt(a,b)!=PIECE_NONE&&g.drawPieceWithCover(a,b,h.pieceAt(a,b));p=h.numMoves()}function c(a){a=Math.max(0,a);a=Math.min(h.numMoves(),a);if(a==p)return p;var b=h.moveHistory();if(a>p)for(var c=p;c<a;++c)m(b[c]);else for(c=p-1;c>=a;--c)0<c?l(b[c],b[c-1]):l(b[c],null);return p=a}function d(a){return a==PIECE_NONE?!1:"r"==x?isRedPiece(a):"b"==x?!isRedPiece(a):!1}function m(a){g.erasePiece(a.i1,a.j1);a.capture&&g.erasePiece(a.i2,
a.j2);g.drawPieceWithCover(a.i2,a.j2,a.piece);g.eraseHighlights();g.highlightSquare(a.i1,a.j1);g.highlightSquare(a.i2,a.j2);w=null}function l(a,b){g.drawPieceWithCover(a.i1,a.j1,a.piece);g.erasePiece(a.i2,a.j2);a.capture&&g.drawPieceWithCover(a.i2,a.j2,a.capture);g.eraseHighlights();b&&(g.highlightSquare(b.i1,b.j1),g.highlightSquare(b.i2,b.j2));w=null}this.setState=function(a,d,m){a!=x&&(x=a,g.reset("b"==a),h.reset(),b(),w=null);A=d;a=h.moveHistory();m=h.setMoves(m);d=p;p==a.length&&(d=h.numMoves());
for(d=Math.min(d,h.numMoves());p>m;--p){var y=p-1;0<y?l(a[y],a[y-1]):l(a[y],null)}c(d)};this.resetState=function(a,c,d){x=a;g.reset("b"==a);h.reset();h.setMoves(d);b();w=null;p=h.numMoves();0<h.numMoves()&&(a=h.lastMove(),g.highlightSquare(a.i1,a.j1),g.highlightSquare(a.i2,a.j2))};this.showMove=c;this.isRedNext=function(){return h.isRedNext()};this.numMoves=function(){return h.numMoves()};this.numMovesShown=function(){return p};this.getFen=function(){for(var a=h.moveHistoryArrayFormat(),b=[],c=0;c<
p;++c)b.push(a[c]);h.setMoves(b);b=h.getFen();h.setMoves(a);return b};var h=new Chess,g=new BoardUI(function(b,c){if(!A){var l=h.isRedNext();if(("r"==x&&l||"b"==x&&!l)&&p==h.numMoves())if(w)if(h.checkMove(w[0],w[1],b,c)){var l=w[0],y=w[1];m(h.move(l,y,b,c));++p;a(l,y,b,c)}else d(h.pieceAt(b,c))&&(g.eraseHighlights(),w=[b,c],g.highlightSquare(b,c));else d(h.pieceAt(b,c))&&(g.eraseHighlights(),w=[b,c],g.highlightSquare(b,c))}}),x="r",A=!0,w=null,p=0;g.drawColorIndicator(document.getElementById("redIndicator"),
!0);g.drawColorIndicator(document.getElementById("blackIndicator"),!1);b()};function Stopwatch(a){function b(){return document.getElementById(a)}function c(){if(l){var b=document.getElementById(a+"Hand"),c=.8*m,A=h/d*2*Math.PI;b.setAttribute("x2",c*Math.sin(A));b.setAttribute("y2",-c*Math.cos(A));++h;h%=d}}this.start=function(){l||(l=!0,h=0,c(),b().style.visibility="visible")};this.stop=function(){l=!1;b().style.visibility="hidden"};this.tick=c;this.frequency=function(){return d};var d=60,m=20,l=!1,h=0;(function(){var c=document.createElementNS("http://www.w3.org/2000/svg",
"circle");c.setAttribute("cx",0);c.setAttribute("cy",0);c.setAttribute("r",m);c.style.stroke="black";c.style.strokeWidth=2;c.style.fillOpacity=0;b().appendChild(c);c=document.createElementNS("http://www.w3.org/2000/svg","line");c.setAttribute("x1",0);c.setAttribute("y1",-m);c.setAttribute("x2",0);c.setAttribute("y2",-m-6);c.style.strokeWidth=4;c.style.stroke="black";b().appendChild(c);c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",-3);c.setAttribute("y",-m-6-4);
c.setAttribute("width",6);c.setAttribute("height",4);c.style.strokeWidth=.5;c.style.stroke="black";c.style.fillOpacity=0;b().appendChild(c);c=document.createElementNS("http://www.w3.org/2000/svg","circle");c.setAttribute("cx",0);c.setAttribute("cy",-m-6-2);c.setAttribute("r",6);c.style.stroke="black";c.style.strokeWidth=1;c.style.fillOpacity=0;b().appendChild(c);for(c=-3;3>=c;c+=1){var d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1",c);d.setAttribute("y1",-m-6-
4);d.setAttribute("x2",c);d.setAttribute("y2",-m-6);d.style.strokeWidth=.2;d.style.stroke="black";b().appendChild(d)}for(c=0;12>c;++c){var d=document.createElementNS("http://www.w3.org/2000/svg","line"),h=c/12*2*Math.PI,l=m,p=.7*m;d.setAttribute("x1",l*Math.sin(h));d.setAttribute("y1",-l*Math.cos(h));d.setAttribute("x2",p*Math.sin(h));d.setAttribute("y2",-p*Math.cos(h));d.style.strokeWidth=1;d.style.stroke="black";b().appendChild(d)}for(c=0;60>c;++c)d=document.createElementNS("http://www.w3.org/2000/svg",
"line"),h=c/60*2*Math.PI,l=m,p=.85*m,d.setAttribute("x1",l*Math.sin(h)),d.setAttribute("y1",-l*Math.cos(h)),d.setAttribute("x2",p*Math.sin(h)),d.setAttribute("y2",-p*Math.cos(h)),d.style.strokeWidth=.5,d.style.stroke="black",b().appendChild(d);c=document.createElementNS("http://www.w3.org/2000/svg","line");c.id=a+"Hand";c.setAttribute("x1",0);c.setAttribute("y1",0);c.setAttribute("x2",0);c.setAttribute("y2",.8*-m);c.style.strokeWidth=1.5;c.style.stroke="black";b().appendChild(c);b().style.visibility=
"hidden"})()};function toggleMenu(){var a=document.getElementById("menu-text"),b=document.getElementById("menu-content");"grid"==b.style.display?(b.style.display="none",a.innerHTML='menu <span class="menu-toggle">[+]</span>'):(b.style.display="grid",a.innerHTML='menu <span class="menu-toggle">[-]</span>')}var NavBarOptions=function(a,b){this.playerId=a;this.playerName=b;this.titleElementHTML=document.createTextNode("\u5728\u7ebf\u8c61\u68cb\u5bf9\u6218").outerHTML;this.menuFork=this.menuInviteAI=!1};
function createNavBarUsernameElement(a,b){var c=document.createElement("div");c.appendChild(document.createTextNode("Hello, "));c.appendChild(createLink(null,["player-link"],"/user/"+a,null,b));return c}function createNavBarTitleElement(a){var b=document.createElement("div");b.innerHTML=a;return b}
function createNavBarMenu(a){var b=document.createElement("div");b.classList.add("menu");var c=document.createElement("div");c.id="menu-text";c.onclick=toggleMenu;c.appendChild(document.createTextNode("menu "));var d=document.createElement("span");d.classList.add("menu-toggle");d.appendChild(document.createTextNode("[+]"));c.appendChild(d);b.appendChild(c);c=document.createElement("div");c.id="menu-content";c.classList.add("menu-content");d=document.createElement("div");d.appendChild(createLink(null,
[],"/new",null,"new game"));c.appendChild(d);a.menuInviteAI&&(d=document.createElement("div"),d.id="invite-ai-container",c.appendChild(d));a.menuFork&&(a=document.createElement("div"),a.id="forkGame",c.appendChild(a));a=document.createElement("div");a.id="update-profile";a.appendChild(createLink(null,[],"/update_profile",null,"update profile"));c.appendChild(a);b.appendChild(c);return b}
function initializeNavBar(a){var b=document.getElementById("nav");b.appendChild(createNavBarUsernameElement(a.playerId,a.playerName));b.appendChild(createNavBarTitleElement(a.titleElementHTML));b.appendChild(createNavBarMenu(a))};var Game=function(a,b,c,d){this.currentGameId_=a;this.myUid_=b;this.myName_=c;this.gameInfo_=d;this.ajaxSequenceHWM_=this.ajaxSequenceLWM_=0;this.pendingSequences_=[];this.initApplication()};Game.prototype.addPendingRequest=function(){++this.ajaxSequenceHWM_;this.pendingSequences_.push(this.ajaxSequenceHWM_);return this.ajaxSequenceHWM_};
Game.prototype.resolveRequest=function(a){a=this.pendingSequences_.indexOf(a);if(-1!=a){this.pendingSequences_.splice(a,1);for(var b=this.ajaxSequenceLWM_+1;b<=this.ajaxSequenceHWM_;++b)if(a=this.pendingSequences_.indexOf(b),-1==a)this.ajaxSequenceLWM_=b;else break;return!0}return!1};
Game.prototype.successWrapper=function(a,b,c){(requestResolved=this.resolveRequest(a))||this.ajaxSequenceHWM_==a?b(c):console.log("Dropped response from an old request: sequence "+a+", lwm "+this.ajaxSequenceLWM_+", hwm "+this.ajaxSequenceHWM_,NaN+this.pendingSequences_.join(", ")+"]")};Game.prototype.failureWrapper=function(a,b,c){this.resolveRequest(a);b(c)};
Game.prototype.get=function(a,b,c){var d=this.ajaxSequenceLWM_;ajaxGet(a,this.successWrapper.bind(this,d,b),this.failureWrapper.bind(this,d,c))};Game.prototype.post=function(a,b,c,d){var m=this.addPendingRequest();ajaxPost(a,b,this.successWrapper.bind(this,m,c),this.failureWrapper.bind(this,m,d))};
Game.prototype.onGameInfoUpdate=function(a){if("fail"==a)alert("Operation failed");else try{var b=JSON.parse(a);b.gameinfo&&("success"!==b.status&&console.log("last update failed"),b=b.gameinfo);this.gameInfo_=b;this.refreshGame()}catch(c){console.log("Unrecognized server response: "+a+". Error: "+c)}};
Game.prototype.parseMoves=function(a){a=a.split("/");for(var b=[],c=1;c<a.length;++c){var d=a[c];if("R"==d||"B"==d)break;b.push([parseInt(d[0],10),parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10)])}return b};Game.prototype.moveToString=function(a){return""+a[0]+a[1]+a[2]+a[3]};
Game.prototype.onPlayerMove=function(a,b,c,d){this.gameInfo_.moves+="/"+this.moveToString([a,b,c,d]);this.updateStatus();this.post("/gameinfo","uid="+this.myUid_+"&sid="+getSid()+"&gid="+this.currentGameId_+"&moves="+this.gameInfo_.moves,this.onGameInfoUpdate.bind(this),this.onGameInfoUpdateFailure.bind(this));this.refreshMoveHistoryControls()};Game.prototype.onGameInfoUpdateFailure=function(a){console.log("Retrieve game info failed")};
Game.prototype.requestGameInfo=function(a){this.get("/gameinfo?gid="+a,this.onGameInfoUpdate.bind(this),this.onGameInfoUpdateFailure.bind(this))};Game.prototype.createInviteAILink=function(a){removeAllChildren("invite-ai-container");var b=createLink("invite-ai-link",[],"#",function(){this.inviteAI();return!1}.bind(this),"invite Blur");document.getElementById("invite-ai-container").appendChild(b);a||enableLink("invite-ai-link",!1)};
Game.prototype.sit=function(a){enableLink(a+"-sit-link",!1);this.post("/gameinfo","uid="+this.myUid_+"&sid="+getSid()+"&gid="+this.currentGameId_+"&sit="+a,this.onGameInfoUpdate.bind(this),this.onGameInfoUpdateFailure.bind(this))};Game.prototype.inviteAI=function(){enableLink("invite-ai-link",!1);this.post("/invite_ai","uid="+this.myUid_+"&sid="+getSid()+"&gid="+this.currentGameId_,this.onGameInfoUpdate.bind(this),this.onGameInfoUpdateFailure.bind(this))};
Game.prototype.createHintYou=function(a){var b=document.createElement("sup");b.className="hint-you";a?b.appendChild(document.createTextNode(" ")):b.appendChild(document.createTextNode("you"));return b};
Game.prototype.refreshPlayerList=function(){removeAllChildren("red-player");removeAllChildren("black-player");if(void 0!==this.gameInfo_.red&&null!==this.gameInfo_.red){var a=document.getElementById("red-player"),b=document.createElement("span");b.appendChild(createLink("red-player-link",["player-link"],"/user/"+this.gameInfo_.red.id,void 0,this.gameInfo_.red.name));a.appendChild(b);a.appendChild(this.createHintYou(this.gameInfo_.red.id!=this.myUid_))}else b=createLink("red-sit-link",["sit-link"],
"#",function(){this.sit("red");return!1}.bind(this),"sit here"),document.getElementById("red-player").appendChild(b);void 0!==this.gameInfo_.black&&null!==this.gameInfo_.black?(a=document.getElementById("black-player"),b=document.createElement("span"),b.appendChild(createLink("black-player-link",["player-link"],"/user/"+this.gameInfo_.black.id,void 0,this.gameInfo_.black.name)),a.appendChild(b),a.appendChild(this.createHintYou(this.gameInfo_.black.id!=this.myUid_))):(b=createLink("black-sit-link",
["sit-link"],"#",function(){this.sit("black");return!1}.bind(this),"sit here"),document.getElementById("black-player").appendChild(b))};Game.prototype.gameStarted=function(){return this.gameInfo_.red&&this.gameInfo_.black};
Game.prototype.updateStatus=function(){var a=document.getElementById("waitingStatus"),b=document.getElementById("playingStatus"),c=document.getElementById("redWonStatus"),d=document.getElementById("blackWonStatus");a.style.display="none";b.style.display="none";c.style.display="none";d.style.display="none";this.gameInfo_.moves.endsWith("R")?(c.style.display="inline-block",this.redWatch_.stop(),this.blackWatch_.stop()):this.gameInfo_.moves.endsWith("B")?(d.style.display="inline-block",this.redWatch_.stop(),
this.blackWatch_.stop()):this.gameStarted()?(b.style.display="inline-block",this.board_.isRedNext()?(this.redWatch_.start(),this.blackWatch_.stop()):(this.blackWatch_.start(),this.redWatch_.stop())):a.style.display="inline-block"};Game.prototype.gameInProgress=function(){return this.gameStarted()&&!this.gameInfo_.moves.endsWith("R")&&!this.gameInfo_.moves.endsWith("B")};Game.prototype.appendCellToRow=function(a,b){var c=document.createElement("td");c.appendChild(b);a.appendChild(c)};
Game.prototype.refreshMoveHistoryControls=function(){removeAllChildren("move-history");var a=document.getElementById("move-history"),b=document.createElement("table");b.id="moveHistoryControls";var c=document.createElement("tr");b.appendChild(c);0<this.board_.numMovesShown()?(this.appendCellToRow(c,createLink("move-history-first",[],"#",function(){this.board_.showMove(0);this.refreshMoveHistoryControls();return!1}.bind(this),"first")),this.appendCellToRow(c,createLink("move-history-prev",[],"#",function(){this.board_.showMove(this.board_.numMovesShown()-
1);this.refreshMoveHistoryControls();return!1}.bind(this),"prev"))):(this.appendCellToRow(c,document.createTextNode("first")),this.appendCellToRow(c,document.createTextNode("prev")));this.appendCellToRow(c,document.createTextNode(""+this.board_.numMovesShown()+" / "+this.board_.numMoves()));this.board_.numMovesShown()<this.board_.numMoves()?(this.appendCellToRow(c,createLink("move-history-next",[],"#",function(){this.board_.showMove(this.board_.numMovesShown()+1);this.refreshMoveHistoryControls();
return!1}.bind(this),"next")),this.appendCellToRow(c,createLink("move-history-last",[],"#",function(){this.board_.showMove(this.board_.numMoves());this.refreshMoveHistoryControls();return!1}.bind(this),"last"))):(this.appendCellToRow(c,document.createTextNode("next")),this.appendCellToRow(c,document.createTextNode("last")));a.appendChild(b);document.getElementById("forkGame");removeAllChildren("forkGame");forkGame.appendChild(createLink("move-history-fork-link",[],"/fork/"+this.currentGameId_+"/"+
this.board_.numMovesShown().toString(),void 0,"fork at move "+this.board_.numMovesShown()))};
Game.prototype.refreshGame=function(){this.refreshPlayerList();var a="r";this.gameInfo_.black&&this.gameInfo_.black.id==this.myUid_&&(a="b");var b=this.gameInfo_.black&&this.gameInfo_.black.id==this.myUid_||this.gameInfo_.red&&this.gameInfo_.red.id==this.myUid_;this.board_.setState(a,!this.gameInProgress()||!b,this.parseMoves(this.gameInfo_.moves));this.updateStatus();this.refreshMoveHistoryControls();this.createInviteAILink(b&&(!this.gameInfo_.black||!this.gameInfo_.red))};
Game.prototype.initApplication=function(){var a=document.createElement("span");a.id="gameId";a.appendChild(document.createTextNode(this.currentGameId_));var a="Game "+a.outerHTML,b=new NavBarOptions(this.myUid_,this.myName_);b.titleElementHTML=a;b.menuInviteAI=!0;b.menuFork=!0;initializeNavBar(b);this.redWatch_=new Stopwatch("redStopwatch");this.blackWatch_=new Stopwatch("blackStopwatch");window.setInterval(function(){this.redWatch_.tick();this.blackWatch_.tick()}.bind(this),6E4/this.redWatch_.frequency());
this.board_=new Board(this.onPlayerMove.bind(this));this.refreshGame();window.setInterval(function(){this.requestGameInfo(this.currentGameId_)}.bind(this),1E3)};document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,myName,gameInfo)};

function parseMoves(b){b=b.split("/");for(var a=[],c=1;c<b.length;++c){var d=b[c];if("R"==d||"B"==d||"D"==d)break;a.push([parseInt(d[0],10),parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10)])}return a}function removeAllChildren(b){for(b=document.getElementById(b);b.lastChild;)b.removeChild(b.lastChild)}
function createLink(b,a,c,d,n){var p=document.createElement("a");b&&(p.id=b);a.forEach(function(a){p.classList.add(a)});p.href=c;d&&(p.onclick=d);p.appendChild(document.createTextNode(n));return p}String.prototype.endsWith||(String.prototype.endsWith=function(b,a){var c=this.toString();if(void 0===a||a>c.length)a=c.length;a-=b.length;c=c.indexOf(b,a);return-1!==c&&c===a});
function ajax(b,a,c,d,n,p){var l=new XMLHttpRequest;l.onreadystatechange=function(){4==l.readyState&&(200<=l.status&&299>=l.status?n(l.responseText):p(l.responseText))};l.open(b,a,!0);c&&l.setRequestHeader("Content-type",c);d?l.send(d):l.send()}function ajaxGet(b,a,c){ajax("GET",b,void 0,void 0,a,c)}function ajaxPost(b,a,c,d){ajax("POST",b,"application/x-www-form-urlencoded; charset=UTF-8",a,c,d)}
function enableLink(b,a){var c=document.getElementById(b);a?c.classList.remove("disabled"):c.classList.add("disabled")}function getCookie(b){b+="=";for(var a=document.cookie.split(";"),c=0;c<a.length;++c){for(var d=a[c];" "==d.charAt(0);)d=d.substring(1);if(0==d.indexOf(b))return d.substring(b.length,d.length)}return""}function getSid(){return getCookie("sid")}function setSpanText(b,a){removeAllChildren(b);document.getElementById(b).appendChild(document.createTextNode(a))}
function getTextWidth(b,a){var c=(getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"))).getContext("2d");c.font=a;return c.measureText(b).width};var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(b){return 8<=b}function Move(b,a,c,d,n,p){this.i1=b;this.j1=a;this.i2=c;this.j2=d;this.piece=n||PIECE_NONE;this.capture=p||PIECE_NONE}
function Chess(b){function a(){return 0==m.length%2}function c(t){return 8<=t?t-8:t}function d(t){var a=t.split("/");if(10!=a.length)throw"Malformed fen string: "+t;for(var b=0;10>b;++b)for(var g=0,f=0;f<a[b].length;++f){if(9<=g)throw"Malformed fen string at row "+b+": "+t;var c=a[b][f];if("0"<=c&&"9">=c)g+=parseInt(a[b][f],10);else{var c=h[b],m=g,e=a[b][f],d=e==e.toLowerCase(),e=e.toLowerCase(),v=0;"k"==e?v=1:"a"==e?v=2:"e"==e?v=3:"h"==e?v=4:"r"==e?v=5:"c"==e?v=6:"p"==e&&(v=7);d||(v+=8);c[m]=v;++g}}}
function n(){h=[];m=[];for(var t=0;10>t;++t){h.push([]);for(var a=0;9>a;++a)h[t].push(0)}b?d(b):d("rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR")}function p(t,a,b,g){m.push(new Move(t,a,b,g,h[t][a],h[b][g]));h[b][g]=h[t][a];h[t][a]=0;return m[m.length-1]}function l(){var a=m.pop();h[a.i1][a.j1]=h[a.i2][a.j2];h[a.i2][a.j2]=a.capture}function f(a,b){return 0<=a&&10>a&&0<=b&&9>b}function k(a,b){return 3<=b&&5>=b&&(0<=a&&2>=a||7<=a&&9>=a)}function u(a,b){for(var f=[],g=0;4>g;++g)k(a+B[g],
b+v[g])&&f.push(new Move(a,b,a+B[g],b+v[g]));for(g=-1;1>=g;g+=2)for(var e=a+g;0<=e&&10>e&&(c(h[e][b])==PIECE_K&&f.push(new Move(a,b,e,b)),0==h[e][b]);e+=g);return f}function A(a,b){for(var f=[],g=0;4>g;++g)k(a+x[g],b+z[g])&&f.push(new Move(a,b,a+x[g],b+z[g]));return f}function q(a,b){for(var c=[],g=0;4>g;++g)f(a+2*x[g],b+2*z[g])&&0==h[a+x[g]][b+z[g]]&&4<a+x[g]&&c.push(new Move(a,b,a+2*x[g],b+2*z[g]));return c}function r(a,b){for(var c=[],g=0;4>g;++g)!f(a+2*x[g],b+2*z[g])||0!=h[a+x[g]][b+z[g]]||4<
a+x[g]||c.push(new Move(a,b,a+2*x[g],b+2*z[g]));return c}function e(a,b){var c=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(g){f(a+g[0],b+g[1])&&0==h[a+g[2]][b+g[3]]&&c.push(new Move(a,b,a+g[0],b+g[1]))});return c}function w(a,b){for(var c=[],g=0;4>g;++g){var e,m;e=a+B[g];for(m=b+v[g];f(e,m)&&(c.push(new Move(a,b,e,m)),0==h[e][m]);e+=B[g],m+=v[g]);}return c}function D(a,b){for(var c=[],g=0;4>g;++g){var e,m,d=!1;e=a+B[g];for(m=b+
v[g];f(e,m);e+=B[g],m+=v[g])if(!d&&0==h[e][m])c.push(new Move(a,b,e,m));else if(!d&&0!=h[e][m])d=!0;else if(d&&0!=h[e][m]){c.push(new Move(a,b,e,m));break}}return c}function C(a,b){var c=[];4<a?c.push(new Move(a,b,a-1,b)):(f(a-1,b)&&c.push(new Move(a,b,a-1,b)),f(a,b-1)&&c.push(new Move(a,b,a,b-1)),f(a,b+1)&&c.push(new Move(a,b,a,b+1)));return c}function F(a,b){var c=[];4<a?(f(a+1,b)&&c.push(new Move(a,b,a+1,b)),f(a,b-1)&&c.push(new Move(a,b,a,b-1)),f(a,b+1)&&c.push(new Move(a,b,a,b+1))):c.push(new Move(a,
b,a+1,b));return c}function y(a,b,f){var g=c(h[a][b]),m=isRedPiece(h[a][b]),d=[];1==g?d=u(a,b):2==g?d=A(a,b):3==g?d=m?q(a,b):r(a,b):4==g?d=e(a,b):5==g?d=w(a,b):6==g?d=D(a,b):7==g&&(d=m?C(a,b):F(a,b));d.forEach(function(a){0!=h[a.i2][a.j2]&&isRedPiece(h[a.i2][a.j2])==m||f.push(a)})}function E(a){for(var b=[],c=0;10>c;++c)for(var e=0;9>e;++e)0!=h[c][e]&&isRedPiece(h[c][e])==a&&y(c,e,b);return b}b=void 0===b?null:b;this.reset=n;this.setMoves=function(a){var b=m;n();for(var c=!0,e=0,f=0;f<a.length;++f)p(a[f][0],
a[f][1],a[f][2],a[f][3]),c&&b.length>f&&b[f].i1==a[f][0]&&b[f].j1==a[f][1]&&b[f].i2==a[f][2]&&b[f].j2==a[f][3]?++e:c=!1;return e};this.move=p;this.checkMove=function(b,c,f,e){var m=a();if(!E(m).find(function(a,m,d){return a.i1==b&&a.j1==c&&a.i2==f&&a.j2==e}))return!1;if(h[f][e]==(m?PIECE_BK:PIECE_RK))return!0;var d=!1;p(b,c,f,e);E(!m).find(function(a,b,c){return h[a.i2][a.j2]==(m?PIECE_RK:PIECE_BK)})&&(d=!0);l();return!d};this.moveHistory=function(){for(var a=[],b=0;b<m.length;++b)a.push(m[b]);return a};
this.moveHistoryArrayFormat=function(){for(var a=[],b=0;b<m.length;++b){var c=m[b];a.push([c.i1,c.j1,c.i2,c.j2])}return a};this.lastMove=function(){return m[m.length-1]};this.pieceAt=function(a,b){return h[a][b]};this.isRedNext=a;this.numMoves=function(){return m.length};this.getFen=function(){for(var b="",c=0;10>c;++c){for(var f=0;9>f;++f)if(""==h[c][f]){for(var e=f+1;9>e&&""==h[c][e];)++e;b+=""+(e-f);f=e-1}else{var e=h[c][f],m=isRedPiece(e);m&&(e-=8);var d="";1==e?d="K":2==e?d="A":3==e?d="E":4==
e?d="H":5==e?d="R":6==e?d="C":7==e&&(d="P");m||(d=d.toLowerCase());b+=d}9>c&&(b+="/")}return b+=" "+(a()?"w":"b")};var h=[],m=[];n();var B=[0,1,0,-1],v=[1,0,-1,0],x=[1,1,-1,-1],z=[1,-1,-1,1]};function BoardUI(b){function a(){return document.getElementById("board")}function c(a,b){h&&(b=8-b);return y/2+b*y}function d(a,b){h&&(a=9-a);return 5>b?y/2+a*y:y/2+a*y+E}function n(a,b,c,e,f,d){var k=document.createElementNS(C,"line");k.setAttribute("x1",a);k.setAttribute("y1",b);k.setAttribute("x2",c);k.setAttribute("y2",e);k.classList.add(f);d&&(k.id=d);return k}function p(a,b,e,f,k){var w=c(a,b);b=d(a,b);var h=document.createElementNS(C,"circle");h.setAttribute("cx",w);h.setAttribute("cy",b);
h.setAttribute("r",e);h.classList.add(f[a]);h.classList.add("piece-element");k&&(h.id=k);return h}function l(a,b){return"abcdefghi"[b]+(9-a).toString()}function f(a,b,e,f,k){k&&A(b,e);var h=void 0;k&&(h="piece-outer-"+l(b,e));var h=p(b,e,23,"piece-outer",h),w=void 0;k&&(w="piece-inner-"+l(b,e));var w=p(b,e,20,"piece-inner",w),n=F[f],g=void 0;k&&(g="piece-text-"+l(b,e));k=g;g=c(b,e);b=d(b,e);e=document.createElementNS(C,"text");e.style.fontFamily="Roboto,monospace";e.style.fontSize="24px";e.setAttribute("text-anchor",
"middle");e.setAttribute("alignment-baseline","central");e.setAttribute("dominant-baseline","middle");e.setAttribute("font-weight","bold");e.setAttribute("x",g);e.setAttribute("y",b);e.appendChild(document.createTextNode(n));e.classList.add("piece-text");e.classList.add("piece-element");e.userSelect="none";k&&(e.id=k);isRedPiece(f)?(h.setAttribute("stroke","red"),w.style.stroke="red",e.style.fill="red"):(h.style.stroke="black",w.style.stroke="black",e.style.fill="black");h.style.strokeWidth=2;w.style.strokeWidth=
2;h.style.fill="white";w.style.fillOpacity=0;a.appendChild(h);a.appendChild(w);a.appendChild(e)}function k(a,e){return function(){b(a,e)}}function u(a,b){var e=p(a,b,23,"piece-cover","piece-cover-"+l(a,b));e.style.strokeWidth=0;e.style.fillOpacity=0;e.userSelect="none";e.onmousedown=k(a,b);e.touchend=e.onmousedown;q(e)}function A(a,b){var e="piece-cover-"+l(a,b);null!=document.getElementById(e)&&r(e)}function q(b){a().appendChild(b)}function r(b){a().removeChild(document.getElementById(b))}function e(a,
b,e,f){var k;k=c(a,b);a=d(a,b);b=c(e,f);e=d(e,f);k=n(k,a,b,e,"grid",void 0);k.style.strokeWidth=1;k.style.stroke="gray";q(k)}function w(){for(i=0;9>i;++i)e(0,i,4,i),0!=i&&8!=i||e(4,i,5,i),e(5,i,9,i);for(i=0;10>i;++i)e(i,0,i,8);e(0,3,2,5);e(0,5,2,3);e(7,3,9,5);e(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)u(i,j)}function D(){for(var b=a().getElementsByClassName("highlighter");0<b.length;)a().removeChild(b[0])}this.reset=function(b){if(h==b){for(b=a().getElementsByClassName("piece-element");0<b.length;)a().removeChild(b[0]);
D()}else h=b,removeAllChildren("board"),w()};this.drawPieceWithCover=function(b,e,c){f(a(),b,e,c,!0);u(b,e)};this.erasePiece=function(a,b){A(a,b);r("piece-text-"+l(a,b));r("piece-inner-"+l(a,b));r("piece-outer-"+l(a,b));u(a,b)};this.drawColorIndicator=function(a,b){var e=1;b&&(e+=8);f(a,0,0,e,!1)};this.highlightSquare=function(a,b){var e=c(a,b),f=d(a,b),k=y/6;for(a=-1;1>=a;a+=2){var h=n(e-23,f+23*a,e-23+k,f+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";q(h);h=n(e+23-k,f+23*
a,e+23,f+23*a,"highlighter",void 0);h.style.strokeWidth=2;h.style.stroke="blue";q(h)}for(a=-1;1>=a;a+=2)h=n(e+23*a,f-23,e+23*a,f-23+k,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",q(h),h=n(e+23*a,f+23-k,e+23*a,f+23,"highlighter",void 0),h.style.strokeWidth=2,h.style.stroke="blue",q(h)};this.eraseHighlights=D;var C="http://www.w3.org/2000/svg",F=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),y=50,E=0,h=!1;w()};function Board(b,a){function c(){for(var a=0;10>a;++a)for(var b=0;9>b;++b)f.pieceAt(a,b)!=PIECE_NONE&&k.drawPieceWithCover(a,b,f.pieceAt(a,b));r=f.numMoves()}function d(a){a=Math.max(0,a);a=Math.min(f.numMoves(),a);if(a==r)return r;var b=f.moveHistory();if(a>r)for(var c=r;c<a;++c)p(b[c]);else for(c=r-1;c>=a;--c)0<c?l(b[c],b[c-1]):l(b[c],null);return r=a}function n(a){return a==PIECE_NONE?!1:"r"==u?isRedPiece(a):"b"==u?!isRedPiece(a):!1}function p(a){k.erasePiece(a.i1,a.j1);a.capture&&k.erasePiece(a.i2,
a.j2);k.drawPieceWithCover(a.i2,a.j2,a.piece);k.eraseHighlights();k.highlightSquare(a.i1,a.j1);k.highlightSquare(a.i2,a.j2);q=null}function l(a,b){k.drawPieceWithCover(a.i1,a.j1,a.piece);k.erasePiece(a.i2,a.j2);a.capture&&k.drawPieceWithCover(a.i2,a.j2,a.capture);k.eraseHighlights();b&&(k.highlightSquare(b.i1,b.j1),k.highlightSquare(b.i2,b.j2));q=null}this.setState=function(a,b,n){a!=u&&(u=a,k.reset("b"==a),f.reset(),c(),q=null);A=b;a=f.moveHistory();n=f.setMoves(n);b=r;r==a.length&&(b=f.numMoves());
for(b=Math.min(b,f.numMoves());r>n;--r){var p=r-1;0<p?l(a[p],a[p-1]):l(a[p],null)}d(b)};this.resetState=function(a,b,d){u=a;k.reset("b"==a);f.reset();f.setMoves(d);c();q=null;r=f.numMoves();0<f.numMoves()&&(a=f.lastMove(),k.highlightSquare(a.i1,a.j1),k.highlightSquare(a.i2,a.j2))};this.showMove=d;this.isRedNext=function(){return f.isRedNext()};this.numMoves=function(){return f.numMoves()};this.numMovesShown=function(){return r};this.getFen=function(){for(var a=f.moveHistoryArrayFormat(),b=[],c=0;c<
r;++c)b.push(a[c]);f.setMoves(b);b=f.getFen();f.setMoves(a);return b};var f=new Chess(void 0===a?null:a),k=new BoardUI(function(a,c){if(!A){var d=f.isRedNext();if(("r"==u&&d||"b"==u&&!d)&&r==f.numMoves())if(q)if(f.checkMove(q[0],q[1],a,c)){var d=q[0],l=q[1];p(f.move(d,l,a,c));++r;b(d,l,a,c)}else n(f.pieceAt(a,c))&&(k.eraseHighlights(),q=[a,c],k.highlightSquare(a,c));else n(f.pieceAt(a,c))&&(k.eraseHighlights(),q=[a,c],k.highlightSquare(a,c))}}),u="r",A=!0,q=null,r=0;k.drawColorIndicator(document.getElementById("redIndicator"),
!0);k.drawColorIndicator(document.getElementById("blackIndicator"),!1);c()};function Stopwatch(b){function a(){return document.getElementById(b)}function c(){if(p){var a=document.getElementById(b+"Hand"),c=.8*n,u=l/d*2*Math.PI;a.setAttribute("x2",c*Math.sin(u));a.setAttribute("y2",-c*Math.cos(u));++l;l%=d}}this.start=function(){p||(p=!0,l=0,c(),a().style.visibility="visible")};this.stop=function(){p=!1;a().style.visibility="hidden"};this.tick=c;this.frequency=function(){return d};var d=60,n=20,p=!1,l=0;(function(){var c=document.createElementNS("http://www.w3.org/2000/svg",
"circle");c.setAttribute("cx",0);c.setAttribute("cy",0);c.setAttribute("r",n);c.style.stroke="black";c.style.strokeWidth=2;c.style.fillOpacity=0;a().appendChild(c);c=document.createElementNS("http://www.w3.org/2000/svg","line");c.setAttribute("x1",0);c.setAttribute("y1",-n);c.setAttribute("x2",0);c.setAttribute("y2",-n-6);c.style.strokeWidth=4;c.style.stroke="black";a().appendChild(c);c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",-3);c.setAttribute("y",-n-6-4);
c.setAttribute("width",6);c.setAttribute("height",4);c.style.strokeWidth=.5;c.style.stroke="black";c.style.fillOpacity=0;a().appendChild(c);c=document.createElementNS("http://www.w3.org/2000/svg","circle");c.setAttribute("cx",0);c.setAttribute("cy",-n-6-2);c.setAttribute("r",6);c.style.stroke="black";c.style.strokeWidth=1;c.style.fillOpacity=0;a().appendChild(c);for(c=-3;3>=c;c+=1){var d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1",c);d.setAttribute("y1",-n-6-
4);d.setAttribute("x2",c);d.setAttribute("y2",-n-6);d.style.strokeWidth=.2;d.style.stroke="black";a().appendChild(d)}for(c=0;12>c;++c){var d=document.createElementNS("http://www.w3.org/2000/svg","line"),l=c/12*2*Math.PI,p=n,q=.7*n;d.setAttribute("x1",p*Math.sin(l));d.setAttribute("y1",-p*Math.cos(l));d.setAttribute("x2",q*Math.sin(l));d.setAttribute("y2",-q*Math.cos(l));d.style.strokeWidth=1;d.style.stroke="black";a().appendChild(d)}for(c=0;60>c;++c)d=document.createElementNS("http://www.w3.org/2000/svg",
"line"),l=c/60*2*Math.PI,p=n,q=.85*n,d.setAttribute("x1",p*Math.sin(l)),d.setAttribute("y1",-p*Math.cos(l)),d.setAttribute("x2",q*Math.sin(l)),d.setAttribute("y2",-q*Math.cos(l)),d.style.strokeWidth=.5,d.style.stroke="black",a().appendChild(d);c=document.createElementNS("http://www.w3.org/2000/svg","line");c.id=b+"Hand";c.setAttribute("x1",0);c.setAttribute("y1",0);c.setAttribute("x2",0);c.setAttribute("y2",.8*-n);c.style.strokeWidth=1.5;c.style.stroke="black";a().appendChild(c);a().style.visibility=
"hidden"})()};function createMenuToggleSpan(b){var a=document.createElement("span");a.classList.add("menu-toggle");b?a.appendChild(document.createTextNode("[+]")):a.appendChild(document.createTextNode("[-]"));return a}function toggleMenu(){var b=document.getElementById("menu-text"),a=document.getElementById("menu-content");"grid"==a.style.display?(a.style.display="none",b.innerHTML=createMenuToggleSpan(!0).outerHTML):(a.style.display="grid",b.innerHTML=createMenuToggleSpan(!1).outerHTML)}
var NavBarOptions=function(b,a){this.playerId=b;this.playerName=a;this.titleElementHTML="<b>\u5728\u7ebf\u8c61\u68cb\u5bf9\u6218</b>";this.menuFork=this.menuInviteAI=!1};function createNavBarUsernameElement(b,a){var c=a,d=getTextWidth(a);d>.2*screen.width&&(c=a.substring(0,Math.max(1,Math.floor(.2*screen.width/d*a.length)-2))+"..");d=document.createElement("div");d.appendChild(document.createTextNode(c));return d}
function createNavBarTitleElement(b){var a=document.createElement("div");a.classList.add("nav-bar-middle");a.innerHTML=b;return a}
function createNavBarMenu(b){var a=document.createElement("div");a.classList.add("menu");var c=document.createElement("div");c.id="menu-text";c.appendChild(createMenuToggleSpan(!0));a.appendChild(c);c=document.createElement("div");c.id="menu-content";c.classList.add("menu-content");var d=document.createElement("div");d.appendChild(createLink(null,[],"/new",null,"new game"));c.appendChild(d);b.menuInviteAI&&(d=document.createElement("div"),d.id="invite-ai-container",c.appendChild(d));b.menuFork&&(d=
document.createElement("div"),d.id="forkGame",c.appendChild(d));d=document.createElement("div");d.appendChild(createLink(null,[],"/user/"+b.playerId,null,"my profile"));c.appendChild(d);b=document.createElement("div");b.id="update-profile";b.appendChild(createLink(null,[],"/update_profile",null,"update profile"));c.appendChild(b);a.appendChild(c);return a}
function createNavBarRightElement(b){var a=document.createElement("div");a.classList.add("nav-bar-right");a.appendChild(createNavBarUsernameElement(b.playerId,b.playerName));a.appendChild(createNavBarMenu(b));a.onclick=toggleMenu;return a}function createNavBarHomeElement(){var b=document.createElement("div");b.classList.add("nav-bar-left");b.appendChild(createLink(null,[],"/",null,"Home"));return b}
function initializeNavBar(b){var a=document.getElementById("nav");a.appendChild(createNavBarHomeElement());a.appendChild(createNavBarTitleElement(b.titleElementHTML));a.appendChild(createNavBarRightElement(b))};var Game=function(b,a,c,d){this.currentGameId_=b;this.myUid_=a;this.myName_=c;this.gameInfo_=d;this.ajaxSequenceHWM_=this.ajaxSequenceLWM_=0;this.pendingSequences_=[];this.initApplication()};Game.prototype.addPendingRequest=function(){++this.ajaxSequenceHWM_;this.pendingSequences_.push(this.ajaxSequenceHWM_);return this.ajaxSequenceHWM_};
Game.prototype.resolveRequest=function(b){b=this.pendingSequences_.indexOf(b);if(-1!=b){this.pendingSequences_.splice(b,1);for(var a=this.ajaxSequenceLWM_+1;a<=this.ajaxSequenceHWM_;++a)if(b=this.pendingSequences_.indexOf(a),-1==b)this.ajaxSequenceLWM_=a;else break;return!0}return!1};
Game.prototype.successWrapper=function(b,a,c){(requestResolved=this.resolveRequest(b))||this.ajaxSequenceHWM_==b?a(c):console.log("Dropped response from an old request: sequence "+b+", lwm "+this.ajaxSequenceLWM_+", hwm "+this.ajaxSequenceHWM_,NaN+this.pendingSequences_.join(", ")+"]")};Game.prototype.failureWrapper=function(b,a,c){this.resolveRequest(b);a(c)};
Game.prototype.get=function(b,a,c){var d=this.ajaxSequenceLWM_;ajaxGet(b,this.successWrapper.bind(this,d,a),this.failureWrapper.bind(this,d,c))};Game.prototype.post=function(b,a,c,d){var n=this.addPendingRequest();ajaxPost(b,a,this.successWrapper.bind(this,n,c),this.failureWrapper.bind(this,n,d))};
Game.prototype.onGameInfoUpdate=function(b){if("fail"==b)alert("Operation failed");else try{var a=JSON.parse(b);a.gameinfo&&("success"!==a.status&&console.log("last update failed"),a=a.gameinfo);this.gameInfo_=a;this.refreshGame()}catch(c){console.log("Unrecognized server response: "+b+". Error: "+c)}};
Game.prototype.parseMoves=function(b){b=b.split("/");for(var a=[],c=1;c<b.length;++c){var d=b[c];if("R"==d||"B"==d)break;a.push([parseInt(d[0],10),parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10)])}return a};Game.prototype.moveToString=function(b){return""+b[0]+b[1]+b[2]+b[3]};
Game.prototype.onPlayerMove=function(b,a,c,d){this.gameInfo_.moves+="/"+this.moveToString([b,a,c,d]);this.updateStatus();this.post("/gameinfo","uid="+this.myUid_+"&sid="+getSid()+"&gid="+this.currentGameId_+"&moves="+this.gameInfo_.moves,this.onGameInfoUpdate.bind(this),this.onGameInfoUpdateFailure.bind(this));this.refreshMoveHistoryControls()};Game.prototype.onGameInfoUpdateFailure=function(b){console.log("Retrieve game info failed")};
Game.prototype.requestGameInfo=function(b){this.get("/gameinfo?gid="+b,this.onGameInfoUpdate.bind(this),this.onGameInfoUpdateFailure.bind(this))};Game.prototype.createInviteAILink=function(b){removeAllChildren("invite-ai-container");var a=createLink("invite-ai-link",[],"#",function(){this.inviteAI();return!1}.bind(this),"invite Blur");document.getElementById("invite-ai-container").appendChild(a);b||enableLink("invite-ai-link",!1)};
Game.prototype.sit=function(b){enableLink(b+"-sit-link",!1);this.post("/gameinfo","uid="+this.myUid_+"&sid="+getSid()+"&gid="+this.currentGameId_+"&sit="+b,this.onGameInfoUpdate.bind(this),this.onGameInfoUpdateFailure.bind(this))};Game.prototype.inviteAI=function(){enableLink("invite-ai-link",!1);this.post("/invite_ai","uid="+this.myUid_+"&sid="+getSid()+"&gid="+this.currentGameId_,this.onGameInfoUpdate.bind(this),this.onGameInfoUpdateFailure.bind(this))};
Game.prototype.createHintYou=function(b){var a=document.createElement("sup");a.className="hint-you";b?a.appendChild(document.createTextNode(" ")):a.appendChild(document.createTextNode("you"));return a};
Game.prototype.refreshPlayerList=function(){removeAllChildren("red-player");removeAllChildren("black-player");if(void 0!==this.gameInfo_.red&&null!==this.gameInfo_.red){var b=document.getElementById("red-player"),a=document.createElement("span");a.appendChild(createLink("red-player-link",["player-link"],"/user/"+this.gameInfo_.red.id,void 0,this.gameInfo_.red.name));b.appendChild(a);b.appendChild(this.createHintYou(this.gameInfo_.red.id!=this.myUid_))}else a=createLink("red-sit-link",["sit-link"],
"#",function(){this.sit("red");return!1}.bind(this),"sit here"),document.getElementById("red-player").appendChild(a);void 0!==this.gameInfo_.black&&null!==this.gameInfo_.black?(b=document.getElementById("black-player"),a=document.createElement("span"),a.appendChild(createLink("black-player-link",["player-link"],"/user/"+this.gameInfo_.black.id,void 0,this.gameInfo_.black.name)),b.appendChild(a),b.appendChild(this.createHintYou(this.gameInfo_.black.id!=this.myUid_))):(a=createLink("black-sit-link",
["sit-link"],"#",function(){this.sit("black");return!1}.bind(this),"sit here"),document.getElementById("black-player").appendChild(a))};Game.prototype.gameStarted=function(){return this.gameInfo_.red&&this.gameInfo_.black};
Game.prototype.updateStatus=function(){var b=document.getElementById("waitingStatus"),a=document.getElementById("playingStatus"),c=document.getElementById("redWonStatus"),d=document.getElementById("blackWonStatus");b.style.display="none";a.style.display="none";c.style.display="none";d.style.display="none";this.gameInfo_.moves.endsWith("R")?(c.style.display="inline-block",this.redWatch_.stop(),this.blackWatch_.stop()):this.gameInfo_.moves.endsWith("B")?(d.style.display="inline-block",this.redWatch_.stop(),
this.blackWatch_.stop()):this.gameStarted()?(a.style.display="inline-block",this.board_.isRedNext()?(this.redWatch_.start(),this.blackWatch_.stop()):(this.blackWatch_.start(),this.redWatch_.stop())):b.style.display="inline-block"};Game.prototype.gameInProgress=function(){return this.gameStarted()&&!this.gameInfo_.moves.endsWith("R")&&!this.gameInfo_.moves.endsWith("B")};Game.prototype.appendCellToRow=function(b,a){var c=document.createElement("td");c.appendChild(a);b.appendChild(c)};
Game.prototype.refreshMoveHistoryControls=function(){removeAllChildren("move-history");var b=document.getElementById("move-history"),a=document.createElement("table");a.id="moveHistoryControls";var c=document.createElement("tr");a.appendChild(c);0<this.board_.numMovesShown()?(this.appendCellToRow(c,createLink("move-history-first",[],"#",function(){this.board_.showMove(0);this.refreshMoveHistoryControls();return!1}.bind(this),"first")),this.appendCellToRow(c,createLink("move-history-prev",[],"#",function(){this.board_.showMove(this.board_.numMovesShown()-
1);this.refreshMoveHistoryControls();return!1}.bind(this),"prev"))):(this.appendCellToRow(c,document.createTextNode("first")),this.appendCellToRow(c,document.createTextNode("prev")));this.appendCellToRow(c,document.createTextNode(""+this.board_.numMovesShown()+" / "+this.board_.numMoves()));this.board_.numMovesShown()<this.board_.numMoves()?(this.appendCellToRow(c,createLink("move-history-next",[],"#",function(){this.board_.showMove(this.board_.numMovesShown()+1);this.refreshMoveHistoryControls();
return!1}.bind(this),"next")),this.appendCellToRow(c,createLink("move-history-last",[],"#",function(){this.board_.showMove(this.board_.numMoves());this.refreshMoveHistoryControls();return!1}.bind(this),"last"))):(this.appendCellToRow(c,document.createTextNode("next")),this.appendCellToRow(c,document.createTextNode("last")));b.appendChild(a);document.getElementById("forkGame");removeAllChildren("forkGame");forkGame.appendChild(createLink("move-history-fork-link",[],"/fork/"+this.currentGameId_+"/"+
this.board_.numMovesShown().toString(),void 0,"fork at move "+this.board_.numMovesShown()))};
Game.prototype.refreshGame=function(){this.refreshPlayerList();var b="r";this.gameInfo_.black&&this.gameInfo_.black.id==this.myUid_&&(b="b");var a=this.gameInfo_.black&&this.gameInfo_.black.id==this.myUid_||this.gameInfo_.red&&this.gameInfo_.red.id==this.myUid_;this.board_.setState(b,!this.gameInProgress()||!a,this.parseMoves(this.gameInfo_.moves));this.updateStatus();this.refreshMoveHistoryControls();this.createInviteAILink(a&&(!this.gameInfo_.black||!this.gameInfo_.red))};
Game.prototype.initApplication=function(){var b=document.createElement("span");b.classList.add("game-id");b.appendChild(document.createTextNode(this.currentGameId_));var b="Game "+b.outerHTML,a=new NavBarOptions(this.myUid_,this.myName_);a.titleElementHTML=b;a.menuInviteAI=!0;a.menuFork=!0;initializeNavBar(a);this.redWatch_=new Stopwatch("redStopwatch");this.blackWatch_=new Stopwatch("blackStopwatch");window.setInterval(function(){this.redWatch_.tick();this.blackWatch_.tick()}.bind(this),6E4/this.redWatch_.frequency());
this.board_=new Board(this.onPlayerMove.bind(this),this.gameInfo_.initial_state);this.refreshGame();window.setInterval(function(){this.requestGameInfo(this.currentGameId_)}.bind(this),1E3)};document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,myName,gameInfo)};

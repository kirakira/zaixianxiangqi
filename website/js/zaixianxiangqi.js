var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(q){return 8<=q}function Move(q,h,c,w,v,l){this.i1=q;this.j1=h;this.i2=c;this.j2=w;this.piece=v||PIECE_NONE;this.capture=l||PIECE_NONE}
function Chess(){function q(){return 0==x.length%2}function h(b){return 8<=b?b-8:b}function c(){u=[];x=[];for(var b=0;10>b;++b)for(u.push([]),j=0;9>j;++j)u[b].push(0);b="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=b.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var d=0;for(k=0;k<b[i].length;++k){if(9<=d)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var m=b[i][k];if("0"<=m&&"9">=m)d+=parseInt(b[i][k],10);else{var m=u[i],I=d,a=b[i][k],e=a==a.toLowerCase(),a=a.toLowerCase(),p=0;"k"==a?p=1:"a"==a?p=2:"e"==a?p=3:"h"==a?p=4:"r"==a?p=5:"c"==a?p=6:"p"==a&&(p=7);e||(p+=8);m[I]=p;++d}}}}function w(b,d,m,a){x.push(new Move(b,d,m,a,u[b][d],u[m][a]));u[m][a]=u[b][d];u[b][d]=0;return x[x.length-1]}function v(){var b=x.pop();u[b.i1][b.j1]=u[b.i2][b.j2];u[b.i2][b.j2]=b.capture}function l(b,d){return 0<=b&&10>b&&0<=d&&9>d}function n(b,d){return 3<=d&&5>=d&&
(0<=b&&2>=b||7<=b&&9>=b)}function a(b,d){var m=[];for(r=0;4>r;++r)n(b+p[r],d+e[r])&&m.push(new Move(b,d,b+p[r],d+e[r]));for(delta=-1;1>=delta;delta+=2)for(ii=b+delta;0<=ii&&10>ii&&(h(u[ii][d])==PIECE_K&&m.push(new Move(b,d,ii,d)),0==u[ii][d]);ii+=delta);return m}function B(b,d){var m=[];for(r=0;4>r;++r)n(b+f[r],d+C[r])&&m.push(new Move(b,d,b+f[r],d+C[r]));return m}function F(b,d){var m=[];for(r=0;4>r;++r)l(b+2*f[r],d+2*C[r])&&0==u[b+f[r]][d+C[r]]&&4<b+f[r]&&m.push(new Move(b,d,b+2*f[r],d+2*C[r]));
return m}function A(b,d){var m=[];for(r=0;4>r;++r)!l(b+2*f[r],d+2*C[r])||0!=u[b+f[r]][d+C[r]]||4<b+f[r]||m.push(new Move(b,d,b+2*f[r],d+2*C[r]));return m}function t(b,d){var m=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(a){l(b+a[0],d+a[1])&&0==u[b+a[2]][d+a[3]]&&m.push(new Move(b,d,b+a[0],d+a[1]))});return m}function g(b,d){var m=[];for(r=0;4>r;++r){var a,z;a=b+p[r];for(z=d+e[r];l(a,z)&&(m.push(new Move(b,d,a,z)),0==u[a][z]);a+=
p[r],z+=e[r]);}return m}function D(b,d){var m=[];for(r=0;4>r;++r){var a,z,f=!1;a=b+p[r];for(z=d+e[r];l(a,z);a+=p[r],z+=e[r])if(!f&&0==u[a][z])m.push(new Move(b,d,a,z));else if(!f&&0!=u[a][z])f=!0;else if(f&&0!=u[a][z]){m.push(new Move(b,d,a,z));break}}return m}function H(b,d){var a=[];4<b?a.push(new Move(b,d,b-1,d)):(l(b-1,d)&&a.push(new Move(b,d,b-1,d)),l(b,d-1)&&a.push(new Move(b,d,b,d-1)),l(b,d+1)&&a.push(new Move(b,d,b,d+1)));return a}function y(b,d){var a=[];4<b?(l(b+1,d)&&a.push(new Move(b,
d,b+1,d)),l(b,d-1)&&a.push(new Move(b,d,b,d-1)),l(b,d+1)&&a.push(new Move(b,d,b,d+1))):a.push(new Move(b,d,b+1,d));return a}function G(b,d,m){var p=h(u[b][d]),e=isRedPiece(u[b][d]),f=[];1==p?f=a(b,d):2==p?f=B(b,d):3==p?f=e?F(b,d):A(b,d):4==p?f=t(b,d):5==p?f=g(b,d):6==p?f=D(b,d):7==p&&(f=e?H(b,d):y(b,d));f.forEach(function(d){0!=u[d.i2][d.j2]&&isRedPiece(u[d.i2][d.j2])==e||m.push(d)})}function E(b){var d=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=u[i][j]&&isRedPiece(u[i][j])==b&&G(i,j,d);return d}this.reset=
c;this.setMoves=function(b){var d=x;c();for(var a=!0,p=0,e=0;e<b.length;++e)w(b[e][0],b[e][1],b[e][2],b[e][3]),a&&d.length>e&&d[e].i1==b[e][0]&&d[e].j1==b[e][1]&&d[e].i2==b[e][2]&&d[e].j2==b[e][3]?++p:a=!1;return p};this.move=w;this.checkMove=function(b,d,a,e){var p=q();if(!E(p).find(function(p,f,g){return p.i1==b&&p.j1==d&&p.i2==a&&p.j2==e}))return!1;if(u[a][e]==(p?PIECE_BK:PIECE_RK))return!0;var f=!1;w(b,d,a,e);E(!p).find(function(d,b,a){return u[d.i2][d.j2]==(p?PIECE_RK:PIECE_BK)})&&(f=!0);v();
return!f};this.moveHistory=function(){for(var b=[],d=0;d<x.length;++d)b.push(x[d]);return b};this.pieceAt=function(b,d){return u[b][d]};this.isRedNext=q;this.numMoves=function(){return x.length};var u=[],x=[];c();var p=[0,1,0,-1],e=[1,0,-1,0],f=[1,1,-1,-1],C=[1,-1,-1,1]};function removeAllChildren(q){for(q=document.getElementById(q);q.lastChild;)q.removeChild(q.lastChild)}
function BoardUI(q){function h(){return document.getElementById("board")}function c(a,e){x&&(e=8-e);return E/2+e*E}function w(a,e){x&&(a=9-a);return 5>e?E/2+a*E:E/2+a*E+u}function v(a,e,f,g,b,d){var m=document.createElementNS(y,"line");m.setAttribute("x1",a);m.setAttribute("y1",e);m.setAttribute("x2",f);m.setAttribute("y2",g);m.setAttribute("class",b);d&&(m.id=d);return m}function l(a,e,f,g,b){var d=c(a,e);a=w(a,e);e=document.createElementNS(y,"circle");e.setAttribute("cx",d);e.setAttribute("cy",
a);e.setAttribute("r",f);e.setAttribute("class",g);b&&(e.id=b);return e}function n(a,e){return"abcdefghi"[e]+(9-a).toString()}function a(a,e,f,g,b){b&&A(e,f);var d=void 0;b&&(d="piece-outer-"+n(e,f));var d=l(e,f,23,"piece-outer",d),m=void 0;b&&(m="piece-inner-"+n(e,f));var m=l(e,f,20,"piece-inner",m),D=G[g],z=void 0;b&&(z="piece-text-"+n(e,f));b=z;z=c(e,f);e=w(e,f);f=document.createElementNS(y,"text");f.style.fontFamily="Roboto,monospace";f.style.fontSize="24px";f.setAttribute("text-anchor","middle");
f.setAttribute("alignment-baseline","central");f.setAttribute("dominant-baseline","middle");f.setAttribute("x",z);f.setAttribute("y",e);f.appendChild(document.createTextNode(D));f.setAttribute("class","piece-text");f.userSelect="none";b&&(f.id=b);isRedPiece(g)?(d.setAttribute("stroke","red"),m.style.stroke="red",f.style.fill="red"):(d.style.stroke="black",m.style.stroke="black",f.style.fill="black");d.style.strokeWidth=2;m.style.strokeWidth=2;d.style.fill="white";m.style.fillOpacity=0;a.appendChild(d);
a.appendChild(m);a.appendChild(f)}function B(a,e){return function(){q(a,e)}}function F(a,e){var f=l(a,e,23,"piece-cover","piece-cover-"+n(a,e));f.style.strokeWidth=0;f.style.fillOpacity=0;f.userSelect="none";f.onmousedown=B(a,e);f.touchend=f.onmousedown;t(f)}function A(a,e){var f="piece-cover-"+n(a,e);null!=document.getElementById(f)&&g(f)}function t(a){h().appendChild(a)}function g(a){h().removeChild(document.getElementById(a))}function D(a,e,f,g){var b;b=c(a,e);a=w(a,e);e=c(f,g);f=w(f,g);b=v(b,
a,e,f,"grid",void 0);b.style.strokeWidth=1;b.style.stroke="gray";t(b)}function H(a){x=a;removeAllChildren("board");for(i=0;9>i;++i)D(0,i,4,i),0!=i&&8!=i||D(4,i,5,i),D(5,i,9,i);for(i=0;10>i;++i)D(i,0,i,8);D(0,3,2,5);D(0,5,2,3);D(7,3,9,5);D(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)F(i,j)}this.reset=H;this.drawPieceWithCover=function(g,e,f){a(h(),g,e,f,!0);F(g,e)};this.erasePiece=function(a,e){A(a,e);g("piece-text-"+n(a,e));g("piece-inner-"+n(a,e));g("piece-outer-"+n(a,e));F(a,e)};this.drawColorIndicator=
function(g,e){var f=1;e&&(f+=8);a(g,0,0,f,!1)};this.highlightSquare=function(a,e){var f=c(a,e),g=w(a,e),b=E/6;for(a=-1;1>=a;a+=2){var d=v(f-23,g+23*a,f-23+b,g+23*a,"highlighter",void 0);d.style.strokeWidth=2;d.style.stroke="blue";t(d);d=v(f+23-b,g+23*a,f+23,g+23*a,"highlighter",void 0);d.style.strokeWidth=2;d.style.stroke="blue";t(d)}for(a=-1;1>=a;a+=2)d=v(f+23*a,g-23,f+23*a,g-23+b,"highlighter",void 0),d.style.strokeWidth=2,d.style.stroke="blue",t(d),d=v(f+23*a,g+23-b,f+23*a,g+23,"highlighter",void 0),
d.style.strokeWidth=2,d.style.stroke="blue",t(d)};this.eraseHighlights=function(){for(var a=h().getElementsByClassName("highlighter");0<a.length;)h().removeChild(a[0])};var y="http://www.w3.org/2000/svg",G=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),E=50,u=0,x=!1;H(!1)};function Board(q){function h(){for(var g=0;10>g;++g)for(var c=0;9>c;++c)n.pieceAt(g,c)!=PIECE_NONE&&a.drawPieceWithCover(g,c,n.pieceAt(g,c));t=n.numMoves()}function c(a){a=Math.max(0,a);a=Math.min(n.numMoves(),a);if(a!=t){var c=n.moveHistory();if(a>t)for(var h=t;h<a;++h)v(c[h]);else for(h=t-1;h>=a;--h)0<h?l(c[h],c[h-1]):l(c[h],null);t=a}}function w(a){return a==PIECE_NONE?!1:"r"==B?isRedPiece(a):"b"==B?!isRedPiece(a):!1}function v(g){a.erasePiece(g.i1,g.j1);g.capture&&a.erasePiece(g.i2,g.j2);a.drawPieceWithCover(g.i2,
g.j2,g.piece);a.eraseHighlights();a.highlightSquare(g.i1,g.j1);a.highlightSquare(g.i2,g.j2);A=null}function l(g,c){a.drawPieceWithCover(g.i1,g.j1,g.piece);a.erasePiece(g.i2,g.j2);g.capture&&a.drawPieceWithCover(g.i2,g.j2,g.capture);a.eraseHighlights();c&&(a.highlightSquare(c.i1,c.j1),a.highlightSquare(c.i2,c.j2));A=null}this.setState=function(g,q,v){g!=B&&(B=g,a.reset("b"==g),n.reset(),h(),A=null);F=q;g=n.moveHistory();v=n.setMoves(v);q=t;t==g.length&&(q=n.numMoves());for(q=Math.min(q,n.numMoves());t>
v;--t){var y=t-1;0<y?l(g[y],g[y-1]):l(g[y],null)}c(q)};this.showMove=c;this.isRedNext=function(){return n.isRedNext()};this.numMoves=function(){return n.numMoves()};this.numMovesShown=function(){return t};var n=new Chess,a=new BoardUI(function(g,c){if(!F){var h=n.isRedNext();if(("r"==B&&h||"b"==B&&!h)&&t==n.numMoves())if(A)if(n.checkMove(A[0],A[1],g,c)){var h=A[0],l=A[1];v(n.move(h,l,g,c));++t;q(h,l,g,c)}else w(n.pieceAt(g,c))&&(a.eraseHighlights(),A=[g,c],a.highlightSquare(g,c));else w(n.pieceAt(g,
c))&&(a.eraseHighlights(),A=[g,c],a.highlightSquare(g,c))}}),B="r",F=!0,A=null,t=0;a.drawColorIndicator(document.getElementById("redIndicator"),!0);a.drawColorIndicator(document.getElementById("blackIndicator"),!1);h()};function Stopwatch(q){function h(){return document.getElementById(q)}function c(){if(l){var a=document.getElementById(q+"Hand"),c=.8*v,h=n/w*2*Math.PI;a.setAttribute("x2",c*Math.sin(h));a.setAttribute("y2",-c*Math.cos(h));++n;n%=w}}this.start=function(){l||(l=!0,n=0,c(),h().style.visibility="visible")};this.stop=function(){l=!1;h().style.visibility="hidden"};this.tick=c;this.frequency=function(){return w};var w=60,v=20,l=!1,n=0;(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",
"circle");a.setAttribute("cx",0);a.setAttribute("cy",0);a.setAttribute("r",v);a.style.stroke="black";a.style.strokeWidth=2;a.style.fillOpacity=0;h().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0);a.setAttribute("y1",-v);a.setAttribute("x2",0);a.setAttribute("y2",-v-6);a.style.strokeWidth=4;a.style.stroke="black";h().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",-3);a.setAttribute("y",-v-6-4);
a.setAttribute("width",6);a.setAttribute("height",4);a.style.strokeWidth=.5;a.style.stroke="black";a.style.fillOpacity=0;h().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",0);a.setAttribute("cy",-v-6-2);a.setAttribute("r",6);a.style.stroke="black";a.style.strokeWidth=1;a.style.fillOpacity=0;h().appendChild(a);for(a=-3;3>=a;a+=1){var c=document.createElementNS("http://www.w3.org/2000/svg","line");c.setAttribute("x1",a);c.setAttribute("y1",-v-6-
4);c.setAttribute("x2",a);c.setAttribute("y2",-v-6);c.style.strokeWidth=.2;c.style.stroke="black";h().appendChild(c)}for(a=0;12>a;++a){var c=document.createElementNS("http://www.w3.org/2000/svg","line"),n=a/12*2*Math.PI,l=v,t=.7*v;c.setAttribute("x1",l*Math.sin(n));c.setAttribute("y1",-l*Math.cos(n));c.setAttribute("x2",t*Math.sin(n));c.setAttribute("y2",-t*Math.cos(n));c.style.strokeWidth=1;c.style.stroke="black";h().appendChild(c)}for(a=0;60>a;++a)c=document.createElementNS("http://www.w3.org/2000/svg",
"line"),n=a/60*2*Math.PI,l=v,t=.85*v,c.setAttribute("x1",l*Math.sin(n)),c.setAttribute("y1",-l*Math.cos(n)),c.setAttribute("x2",t*Math.sin(n)),c.setAttribute("y2",-t*Math.cos(n)),c.style.strokeWidth=.5,c.style.stroke="black",h().appendChild(c);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.id=q+"Hand";a.setAttribute("x1",0);a.setAttribute("y1",0);a.setAttribute("x2",0);a.setAttribute("y2",.8*-v);a.style.strokeWidth=1.5;a.style.stroke="black";h().appendChild(a);h().style.visibility=
"hidden"})()};String.prototype.endsWith||(String.prototype.endsWith=function(q,h){var c=this.toString();if(void 0===h||h>c.length)h=c.length;h-=q.length;c=c.indexOf(q,h);return-1!==c&&c===h});
function Game(q,h,c){function w(a,e,c,g,h,n,p){var l=new XMLHttpRequest;l.onreadystatechange=function(){if(4==l.readyState){var a=b.indexOf(c);if(-1!=a){b.splice(a,1);for(var d=f+1;d<=C;++d)if(a=b.indexOf(d),-1==a)f=d;else break;requestResolved=!0}else requestResolved=!1;200<=l.status&&299>=l.status?requestResolved||C==c?n(l.responseText):console.log("Dropped response from an old request."):p&&p(l.responseText)}};l.open(a,e,!0);g&&l.setRequestHeader("Content-type",g);h?l.send(h):l.send()}function v(a,
e,c,f){++C;b.push(C);w("POST",a,C,"application/x-www-form-urlencoded; charset=UTF-8",e,c,f)}function l(a){if("fail"==a)alert("Operation failed");else try{var b=JSON.parse(a);b.gameinfo&&("success"!==b.status&&console.log("last update failed"),b=b.gameinfo);c=b;E()}catch(e){console.log("Unrecognized server response: "+a)}}function n(a){a=a.split("/");for(var b=[],e=1;e<a.length;++e){var c=a[e];if("R"==c||"B"==c)break;b.push([parseInt(c[0],10),parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)])}return b}
function a(a,b,e,f){var g=c;a=[a,b,e,f];g.moves+="/"+(""+a[0]+a[1]+a[2]+a[3]);H();v("/gameinfo","uid="+h+"&sid="+F("sid")+"&gid="+q+"&moves="+c.moves,l,B);G()}function B(a){console.log("Retrieve game info failed")}function F(a){a+="=";for(var b=document.cookie.split(";"),e=0;e<b.length;++e){for(var c=b[e];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(a))return c.substring(a.length,c.length)}return""}function A(a){var b=document.getElementById(a+"-player"),c=document.getElementById(a+"-sit-link"),
e=c.innerText;b.removeChild(c);c=document.createElement("span");c.className="disabled-link";c.appendChild(document.createTextNode(e));b.appendChild(c);v("/gameinfo","uid="+h+"&sid="+F("sid")+"&gid="+q+"&sit="+a,l,B)}function t(a,b,c,e,f){var g=document.createElement("a");g.id=a;b&&(g.className=b);g.href=c;e&&(g.onclick=e);g.appendChild(document.createTextNode(f));return g}function g(a){var b=document.createElement("sup");b.className="hint-you";a?b.appendChild(document.createTextNode(" ")):b.appendChild(document.createTextNode("you"));
return b}function D(){removeAllChildren("red-player");removeAllChildren("black-player");if(void 0!==c.red&&null!==c.red){var a=document.getElementById("red-player"),b=document.createElement("span");b.appendChild(document.createTextNode(c.red.name));a.appendChild(b);a.appendChild(g(c.red.id!=h))}else b=t("red-sit-link","sit-link","#",function(){A("red");return!1},"sit here"),document.getElementById("red-player").appendChild(b);void 0!==c.black&&null!==c.black?(a=document.getElementById("black-player"),
b=document.createElement("span"),b.appendChild(document.createTextNode(c.black.name)),a.appendChild(b),a.appendChild(g(c.black.id!=h))):(b=t("black-sit-link","sit-link","#",function(){A("black");return!1},"sit here"),document.getElementById("black-player").appendChild(b))}function H(){var a=document.getElementById("waitingStatus"),b=document.getElementById("playingStatus"),f=document.getElementById("redWonStatus"),g=document.getElementById("blackWonStatus");a.style.display="none";b.style.display=
"none";f.style.display="none";g.style.display="none";c.moves.endsWith("R")?f.style.display="inline-block":c.moves.endsWith("B")?g.style.display="inline-block":c.red&&c.black?(b.style.display="inline-block",e.isRedNext()?(x.start(),p.stop()):(p.start(),x.stop())):a.style.display="inline-block"}function y(a,b){var c=document.createElement("td");c.appendChild(b);a.appendChild(c)}function G(){removeAllChildren("move-history");var a=document.getElementById("move-history"),b=document.createElement("table");
b.id="moveHistoryControls";var c=document.createElement("tr");b.appendChild(c);0<e.numMovesShown()?(y(c,t("move-history-first",void 0,"#",function(){e.showMove(0);G();return!1},"first")),y(c,t("move-history-prev",void 0,"#",function(){e.showMove(e.numMovesShown()-1);G();return!1},"prev"))):(y(c,document.createTextNode("first")),y(c,document.createTextNode("prev")));y(c,document.createTextNode(""+e.numMovesShown()+" / "+e.numMoves()));e.numMovesShown()<e.numMoves()?(y(c,t("move-history-next",void 0,
"#",function(){e.showMove(e.numMovesShown()+1);G();return!1},"next")),y(c,t("move-history-last",void 0,"#",function(){e.showMove(e.numMoves());G();return!1},"last"))):(y(c,document.createTextNode("next")),y(c,document.createTextNode("last")));a.appendChild(b);document.getElementById("forkGame");removeAllChildren("forkGame");forkGame.appendChild(t("move-history-fork-link",void 0,"/fork/"+q+"/"+e.numMovesShown().toString(),void 0,"fork at move "+e.numMovesShown()))}function E(){D();var a="r";c.black&&
c.black.id==h&&(a="b");var b=c.black&&c.black.id==h||c.red&&c.red.id==h;e.setState(a,!(c.red&&c.black&&!c.moves.endsWith("R")&&!c.moves.endsWith("B"))||!b,n(c.moves));H();G()}function u(){var a=document.getElementById("board");.81*window.innerHeight<=window.innerWidth?(a.style.removeProperty("width"),a.style.height="90vh"):(a.style.width="100vw",a.style.removeProperty("height"))}var x,p,e,f=0,C=0,b=[];(function(){x=new Stopwatch("redStopwatch");p=new Stopwatch("blackStopwatch");window.setInterval(function(){x.tick();
p.tick()},6E4/x.frequency());window.onload=u;window.onresize=u;e=new Board(a);E();window.setInterval(function(){w("GET","/gameinfo?gid="+q,f,void 0,void 0,l,B)},1E3)})()}function toggleMenu(){var q=document.getElementById("menu-text"),h=document.getElementById("menu-content");"grid"==h.style.display?(h.style.display="none",q.innerHTML='menu <span class="menu-toggle">[+]</span>'):(h.style.display="grid",q.innerHTML='menu <span class="menu-toggle">[-]</span>')}
document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,gameInfo)};

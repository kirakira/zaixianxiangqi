var PIECE_NONE=0,PIECE_K=1,PIECE_A=2,PIECE_E=3,PIECE_H=4,PIECE_R=5,PIECE_C=6,PIECE_P=7,PIECE_BK=1,PIECE_BA=2,PIECE_BE=3,PIECE_BH=4,PIECE_BR=5,PIECE_BC=6,PIECE_BP=7,PIECE_RK=9,PIECE_RA=10,PIECE_RE=11,PIECE_RH=12,PIECE_RR=13,PIECE_RC=14,PIECE_RP=15;function isRedPiece(v){return 8<=v}function Move(v,n,e,z,q,p){this.i1=v;this.j1=n;this.i2=e;this.j2=z;this.piece=q||PIECE_NONE;this.capture=p||PIECE_NONE}
function Chess(){function v(){return 0==A.length%2}function n(b){return 8<=b?b-8:b}function e(){m=[];A=[];for(var b=0;10>b;++b)for(m.push([]),j=0;9>j;++j)m[b].push(0);b="rheakaehr 9 1c5c1 p1p1p1p1p 9 9 P1P1P1P1P 1C5C1 9 RHEAKAEHR".split(" ");if(10!=b.length)throw"Malformed fen string: rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";for(i=0;10>i;++i){var d=0;for(k=0;k<b[i].length;++k){if(9<=d)throw"Malformed fen string at row "+i+": rheakaehr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RHEAKAEHR";
var g=b[i][k];if("0"<=g&&"9">=g)d+=parseInt(b[i][k],10);else{var g=m[i],H=d,h=b[i][k],a=h==h.toLowerCase(),h=h.toLowerCase(),c=0;"k"==h?c=1:"a"==h?c=2:"e"==h?c=3:"h"==h?c=4:"r"==h?c=5:"c"==h?c=6:"p"==h&&(c=7);a||(c+=8);g[H]=c;++d}}}}function z(b,d,g,h){A.push(new Move(b,d,g,h,m[b][d],m[g][h]));m[g][h]=m[b][d];m[b][d]=0;return A[A.length-1]}function q(){var b=A.pop();m[b.i1][b.j1]=m[b.i2][b.j2];m[b.i2][b.j2]=b.capture}function p(b,d){return 0<=b&&10>b&&0<=d&&9>d}function u(b,d){return 3<=d&&5>=d&&
(0<=b&&2>=b||7<=b&&9>=b)}function a(b,d){var g=[];for(r=0;4>r;++r)u(b+B[r],d+h[r])&&g.push(new Move(b,d,b+B[r],d+h[r]));for(delta=-1;1>=delta;delta+=2)for(ii=b+delta;0<=ii&&10>ii&&(n(m[ii][d])==PIECE_K&&g.push(new Move(b,d,ii,d)),0==m[ii][d]);ii+=delta);return g}function l(b,d){var g=[];for(r=0;4>r;++r)u(b+w[r],d+f[r])&&g.push(new Move(b,d,b+w[r],d+f[r]));return g}function C(b,d){var g=[];for(r=0;4>r;++r)p(b+2*w[r],d+2*f[r])&&0==m[b+w[r]][d+f[r]]&&4<b+w[r]&&g.push(new Move(b,d,b+2*w[r],d+2*f[r]));
return g}function E(b,d){var g=[];for(r=0;4>r;++r)!p(b+2*w[r],d+2*f[r])||0!=m[b+w[r]][d+f[r]]||4<b+w[r]||g.push(new Move(b,d,b+2*w[r],d+2*f[r]));return g}function t(b,d){var g=[];[[1,2,0,1],[1,-2,0,-1],[-1,2,0,1],[-1,-2,0,-1],[2,1,1,0],[2,-1,1,0],[-2,1,-1,0],[-2,-1,-1,0]].forEach(function(h){p(b+h[0],d+h[1])&&0==m[b+h[2]][d+h[3]]&&g.push(new Move(b,d,b+h[0],d+h[1]))});return g}function x(b,d){var g=[];for(r=0;4>r;++r){var a,c;a=b+B[r];for(c=d+h[r];p(a,c)&&(g.push(new Move(b,d,a,c)),0==m[a][c]);a+=
B[r],c+=h[r]);}return g}function c(b,d){var g=[];for(r=0;4>r;++r){var a,c,w=!1;a=b+B[r];for(c=d+h[r];p(a,c);a+=B[r],c+=h[r])if(!w&&0==m[a][c])g.push(new Move(b,d,a,c));else if(!w&&0!=m[a][c])w=!0;else if(w&&0!=m[a][c]){g.push(new Move(b,d,a,c));break}}return g}function y(b,d){var g=[];4<b?g.push(new Move(b,d,b-1,d)):(p(b-1,d)&&g.push(new Move(b,d,b-1,d)),p(b,d-1)&&g.push(new Move(b,d,b,d-1)),p(b,d+1)&&g.push(new Move(b,d,b,d+1)));return g}function D(b,d){var g=[];4<b?(p(b+1,d)&&g.push(new Move(b,
d,b+1,d)),p(b,d-1)&&g.push(new Move(b,d,b,d-1)),p(b,d+1)&&g.push(new Move(b,d,b,d+1))):g.push(new Move(b,d,b+1,d));return g}function F(b,d,g){var h=n(m[b][d]),w=isRedPiece(m[b][d]),f=[];1==h?f=a(b,d):2==h?f=l(b,d):3==h?f=w?C(b,d):E(b,d):4==h?f=t(b,d):5==h?f=x(b,d):6==h?f=c(b,d):7==h&&(f=w?y(b,d):D(b,d));f.forEach(function(d){0!=m[d.i2][d.j2]&&isRedPiece(m[d.i2][d.j2])==w||g.push(d)})}function G(b){var d=[];for(i=0;10>i;++i)for(j=0;9>j;++j)0!=m[i][j]&&isRedPiece(m[i][j])==b&&F(i,j,d);return d}this.reset=
e;this.setMoves=function(b){var d=A;e();for(var g=!0,h=0,a=0;a<b.length;++a)z(b[a][0],b[a][1],b[a][2],b[a][3]),g&&d.length>a&&d[a].i1==b[a][0]&&d[a].j1==b[a][1]&&d[a].i2==b[a][2]&&d[a].j2==b[a][3]?++h:g=!1;return h};this.move=z;this.checkMove=function(b,d,g,h){var a=v();if(!G(a).find(function(a,c,w){return a.i1==b&&a.j1==d&&a.i2==g&&a.j2==h}))return!1;if(m[g][h]==(a?PIECE_BK:PIECE_RK))return!0;var c=!1;z(b,d,g,h);G(!a).find(function(d,b,g){return m[d.i2][d.j2]==(a?PIECE_RK:PIECE_BK)})&&(c=!0);q();
return!c};this.moveHistory=function(){for(var b=[],d=0;d<A.length;++d)b.push(A[d]);return b};this.pieceAt=function(b,d){return m[b][d]};this.isRedNext=v;this.numMoves=function(){return A.length};var m=[],A=[];e();var B=[0,1,0,-1],h=[1,0,-1,0],w=[1,1,-1,-1],f=[1,-1,-1,1]};function removeAllChildren(v){for(v=document.getElementById(v);v.lastChild;)v.removeChild(v.lastChild)}
function BoardUI(v){function n(){return document.getElementById("board")}function e(h,a){B&&(a=8-a);return m/2+a*m}function z(a,c){B&&(a=9-a);return 5>c?m/2+a*m:m/2+a*m+A}function q(a,c,f,b,d,g){var l=document.createElementNS(D,"line");l.setAttribute("x1",a);l.setAttribute("y1",c);l.setAttribute("x2",f);l.setAttribute("y2",b);l.setAttribute("class",d);g&&(l.id=g);return l}function p(a,c,f,b,d){var g=e(a,c);a=z(a,c);c=document.createElementNS(D,"circle");c.setAttribute("cx",g);c.setAttribute("cy",
a);c.setAttribute("r",f);c.setAttribute("class",b);d&&(c.id=d);return c}function u(a,c){return"abcdefghi"[c]+(9-a).toString()}function a(a,c,f,b,d,g){d&&E(c,f);var l=void 0;d&&(l="piece-outer-"+u(c,f));var l=p(c,f,23,"piece-outer",l),y=void 0;d&&(y="piece-inner-"+u(c,f));y=p(c,f,20,"piece-inner",y);g=g?G[b]:F[b];var m=void 0;d&&(m="piece-text-"+u(c,f));d=m;m=e(c,f);c=z(c,f);f=document.createElementNS(D,"text");f.style.fontFamily="Roboto,monospace";f.style.fontSize=24;f.setAttribute("text-anchor",
"middle");f.setAttribute("alignment-baseline","central");f.setAttribute("dominant-baseline","middle");f.setAttribute("x",m);f.setAttribute("y",c);f.appendChild(document.createTextNode(g));f.setAttribute("class","piece-text");f.userSelect="none";d&&(f.id=d);isRedPiece(b)?(l.setAttribute("stroke","red"),y.style.stroke="red",f.style.fill="red"):(l.style.stroke="black",y.style.stroke="black",f.style.fill="black");l.style.strokeWidth=2;y.style.strokeWidth=2;l.style.fill="white";y.style.fillOpacity=0;a.appendChild(l);
a.appendChild(y);a.appendChild(f)}function l(a,c){return function(){v(a,c)}}function C(a,c){var f=p(a,c,23,"piece-cover","piece-cover-"+u(a,c));f.style.strokeWidth=0;f.style.fillOpacity=0;f.userSelect="none";f.onmousedown=l(a,c);f.touchend=f.onmousedown;t(f)}function E(a,c){var f="piece-cover-"+u(a,c);null!=document.getElementById(f)&&x(f)}function t(a){n().appendChild(a)}function x(a){n().removeChild(document.getElementById(a))}function c(a,c,f,b){var d;d=e(a,c);a=z(a,c);c=e(f,b);f=z(f,b);d=q(d,
a,c,f,"grid",void 0);d.style.strokeWidth=1;d.style.stroke="gray";t(d)}function y(a){B=a;removeAllChildren("board");for(i=0;9>i;++i)c(0,i,4,i),0!=i&&8!=i||c(4,i,5,i),c(5,i,9,i);for(i=0;10>i;++i)c(i,0,i,8);c(0,3,2,5);c(0,5,2,3);c(7,3,9,5);c(9,3,7,5);for(i=0;10>i;++i)for(j=0;9>j;++j)C(i,j)}this.reset=y;this.drawPieceWithCover=function(c,l,f,b){a(n(),c,l,f,!0,b);C(c,l)};this.erasePiece=function(a,c){E(a,c);x("piece-text-"+u(a,c));x("piece-inner-"+u(a,c));x("piece-outer-"+u(a,c));C(a,c)};this.drawColorIndicator=
function(c,l){var f=1;l&&(f+=8);a(c,0,0,f,!1,!1)};this.highlightSquare=function(a,c){var f=e(a,c),b=z(a,c),d=m/6;for(a=-1;1>=a;a+=2){var g=q(f-23,b+23*a,f-23+d,b+23*a,"highlighter",void 0);g.style.strokeWidth=2;g.style.stroke="blue";t(g);g=q(f+23-d,b+23*a,f+23,b+23*a,"highlighter",void 0);g.style.strokeWidth=2;g.style.stroke="blue";t(g)}for(a=-1;1>=a;a+=2)g=q(f+23*a,b-23,f+23*a,b-23+d,"highlighter",void 0),g.style.strokeWidth=2,g.style.stroke="blue",t(g),g=q(f+23*a,b+23-d,f+23*a,b+23,"highlighter",
void 0),g.style.strokeWidth=2,g.style.stroke="blue",t(g)};this.eraseHighlights=function(){for(var a=n().getElementsByClassName("highlighter");0<a.length;)n().removeChild(a[0])};var D="http://www.w3.org/2000/svg",F=" \u5c07 \u58eb \u8c61 \u99ac \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \u508c \u4fe5 \u70ae \u5175".split(" "),G=" \u5c07 \u58eb \u8c61 \ud83d\udc34 \u8eca \u7832 \u5352  \u5e25 \u4ed5 \u76f8 \ud83e\udd84 \u4fe5 \u70ae \u5175".split(" "),m=50,A=0,B=!1;y(!1)};function Board(v,n){function e(){for(var c=0;10>c;++c)for(var y=0;9>y;++y)a.pieceAt(c,y)!=PIECE_NONE&&l.drawPieceWithCover(c,y,a.pieceAt(c,y),!1);x=a.numMoves()}function z(c){c=Math.max(0,c);c=Math.min(a.numMoves(),c);if(c!=x){var l=a.moveHistory();if(c>x)for(var e=x;e<c;++e)p(l[e]);else for(e=x-1;e>=c;--e)0<e?u(l[e],l[e-1]):u(l[e],null);x=c}}function q(a){return a==PIECE_NONE?!1:"r"==C?isRedPiece(a):"b"==C?!isRedPiece(a):!1}function p(a){l.erasePiece(a.i1,a.j1);var e=!1;a.capture&&(l.erasePiece(a.i2,
a.j2),n&&(e=!0));l.drawPieceWithCover(a.i2,a.j2,a.piece,e);l.eraseHighlights();l.highlightSquare(a.i1,a.j1);l.highlightSquare(a.i2,a.j2);t=null}function u(a,e){l.drawPieceWithCover(a.i1,a.j1,a.piece,!1);l.erasePiece(a.i2,a.j2);a.capture&&l.drawPieceWithCover(a.i2,a.j2,a.capture,!1);l.eraseHighlights();e&&(l.highlightSquare(e.i1,e.j1),l.highlightSquare(e.i2,e.j2));t=null}this.setState=function(c,n,q){c!=C&&(C=c,l.reset("b"==c),a.reset(),e(),t=null);E=n;c=a.moveHistory();q=a.setMoves(q);n=x;x==c.length&&
(n=a.numMoves());for(n=Math.min(n,a.numMoves());x>q;--x){var p=x-1;0<p?u(c[p],c[p-1]):u(c[p],null)}z(n)};this.showMove=z;this.isRedNext=function(){return a.isRedNext()};this.numMoves=function(){return a.numMoves()};this.numMovesShown=function(){return x};var a=new Chess,l=new BoardUI(function(c,e){if(!E){var n=a.isRedNext();if(("r"==C&&n||"b"==C&&!n)&&x==a.numMoves())if(t)if(a.checkMove(t[0],t[1],c,e)){var n=t[0],u=t[1];p(a.move(n,u,c,e));++x;v(n,u,c,e)}else q(a.pieceAt(c,e))&&(l.eraseHighlights(),
t=[c,e],l.highlightSquare(c,e));else q(a.pieceAt(c,e))&&(l.eraseHighlights(),t=[c,e],l.highlightSquare(c,e))}}),C="r",E=!0,t=null,x=0;l.drawColorIndicator(document.getElementById("redIndicator"),!0);l.drawColorIndicator(document.getElementById("blackIndicator"),!1);e()};function Stopwatch(v){function n(){return document.getElementById(v)}function e(){if(p){var a=document.getElementById(v+"Hand"),l=.8*q,e=u/z*2*Math.PI;a.setAttribute("x2",l*Math.sin(e));a.setAttribute("y2",-l*Math.cos(e));++u;u%=z}}this.start=function(){p||(p=!0,u=0,e(),n().style.visibility="visible")};this.stop=function(){p=!1;n().style.visibility="hidden"};this.tick=e;this.frequency=function(){return z};var z=60,q=20,p=!1,u=0;(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",
"circle");a.setAttribute("cx",0);a.setAttribute("cy",0);a.setAttribute("r",q);a.style.stroke="black";a.style.strokeWidth=2;a.style.fillOpacity=0;n().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0);a.setAttribute("y1",-q);a.setAttribute("x2",0);a.setAttribute("y2",-q-6);a.style.strokeWidth=4;a.style.stroke="black";n().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",-3);a.setAttribute("y",-q-6-4);
a.setAttribute("width",6);a.setAttribute("height",4);a.style.strokeWidth=.5;a.style.stroke="black";a.style.fillOpacity=0;n().appendChild(a);a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",0);a.setAttribute("cy",-q-6-2);a.setAttribute("r",6);a.style.stroke="black";a.style.strokeWidth=1;a.style.fillOpacity=0;n().appendChild(a);for(a=-3;3>=a;a+=1){var e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1",a);e.setAttribute("y1",-q-6-
4);e.setAttribute("x2",a);e.setAttribute("y2",-q-6);e.style.strokeWidth=.2;e.style.stroke="black";n().appendChild(e)}for(a=0;12>a;++a){var e=document.createElementNS("http://www.w3.org/2000/svg","line"),p=a/12*2*Math.PI,u=q,t=.7*q;e.setAttribute("x1",u*Math.sin(p));e.setAttribute("y1",-u*Math.cos(p));e.setAttribute("x2",t*Math.sin(p));e.setAttribute("y2",-t*Math.cos(p));e.style.strokeWidth=1;e.style.stroke="black";n().appendChild(e)}for(a=0;60>a;++a)e=document.createElementNS("http://www.w3.org/2000/svg",
"line"),p=a/60*2*Math.PI,u=q,t=.85*q,e.setAttribute("x1",u*Math.sin(p)),e.setAttribute("y1",-u*Math.cos(p)),e.setAttribute("x2",t*Math.sin(p)),e.setAttribute("y2",-t*Math.cos(p)),e.style.strokeWidth=.5,e.style.stroke="black",n().appendChild(e);a=document.createElementNS("http://www.w3.org/2000/svg","line");a.id=v+"Hand";a.setAttribute("x1",0);a.setAttribute("y1",0);a.setAttribute("x2",0);a.setAttribute("y2",.8*-q);a.style.strokeWidth=1.5;a.style.stroke="black";n().appendChild(a);n().style.visibility=
"hidden"})()};String.prototype.endsWith||(String.prototype.endsWith=function(v,n){var e=this.toString();if(void 0===n||n>e.length)n=e.length;n-=v.length;e=e.indexOf(v,n);return-1!==e&&e===n});
function Game(v,n,e){function z(a,g,c,e,h,l,n){var m=new XMLHttpRequest;m.onreadystatechange=function(){if(4==m.readyState){var a=b.indexOf(c);if(-1!=a){b.splice(a,1);for(var d=w+1;d<=f;++d)if(a=b.indexOf(d),-1==a)w=d;else break;requestResolved=!0}else requestResolved=!1;200<=m.status&&299>=m.status?requestResolved||f==c?l(m.responseText):console.log("Dropped response from an old request."):n&&n(m.responseText)}};m.open(a,g,!0);e&&m.setRequestHeader("Content-type",e);h?m.send(h):m.send()}function q(a,
c,e,h){++f;b.push(f);z("POST",a,f,"application/x-www-form-urlencoded; charset=UTF-8",c,e,h)}function p(a){if("fail"==a)alert("Operation failed");else try{var b=JSON.parse(a);b.gameinfo&&("success"!==b.status&&console.log("last update failed"),b=b.gameinfo);e=b;G()}catch(c){console.log("Unrecognized server response: "+a)}}function u(a){a=a.split("/");for(var b=[],c=1;c<a.length;++c){var e=a[c];if("R"==e||"B"==e)break;b.push([parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10)])}return b}
function a(a,b,c,f){var h=e;a=[a,b,c,f];h.moves+="/"+(""+a[0]+a[1]+a[2]+a[3]);y();q("/gameinfo","uid="+n+"&sid="+C("sid")+"&gid="+v+"&moves="+e.moves,p,l);F()}function l(a){console.log("Retrieve game info failed")}function C(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;++c){for(var e=b[c];" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(a))return e.substring(a.length,e.length)}return""}function E(a){var b=document.getElementById(a+"-player"),c=document.getElementById(a+"-sit-link");
b.removeChild(c);b.appendChild(document.createTextNode("sitting down..."));q("/gameinfo","uid="+n+"&sid="+C("sid")+"&gid="+v+"&sit="+a,p,l)}function t(a,b,c,e,f){var h=document.createElement("a");h.id=a;b&&(h.className=b);h.href=c;e&&(h.onclick=e);h.appendChild(document.createTextNode(f));return h}function x(a){var b=document.createElement("sup");b.className="hint-you";a?b.appendChild(document.createTextNode(" ")):b.appendChild(document.createTextNode("you"));return b}function c(){removeAllChildren("red-player");
removeAllChildren("black-player");if(void 0!==e.red&&null!==e.red){var a=document.getElementById("red-player"),b=document.createElement("span");b.appendChild(document.createTextNode(e.red.name));a.appendChild(b);a.appendChild(x(e.red.id!=n))}else b=t("red-sit-link","sit-link","#",function(){E("red");return!1},"sit here"),document.getElementById("red-player").appendChild(b);void 0!==e.black&&null!==e.black?(a=document.getElementById("black-player"),b=document.createElement("span"),b.appendChild(document.createTextNode(e.black.name)),
a.appendChild(b),a.appendChild(x(e.black.id!=n))):(b=t("black-sit-link","sit-link","#",function(){E("black");return!1},"sit here"),document.getElementById("black-player").appendChild(b))}function y(){var a=document.getElementById("waitingStatus"),b=document.getElementById("playingStatus"),c=document.getElementById("redWonStatus"),f=document.getElementById("blackWonStatus");a.style.display="none";b.style.display="none";c.style.display="none";f.style.display="none";e.moves.endsWith("R")?c.style.display=
"inline-block":e.moves.endsWith("B")?f.style.display="inline-block":e.red&&e.black?(b.style.display="inline-block",h.isRedNext()?(A.start(),B.stop()):(B.start(),A.stop())):a.style.display="inline-block"}function D(a,b){var c=document.createElement("td");c.appendChild(b);a.appendChild(c)}function F(){removeAllChildren("move-history");var a=document.getElementById("move-history"),b=document.createElement("table");b.id="moveHistoryControls";var c=document.createElement("tr");b.appendChild(c);0<h.numMovesShown()?
(D(c,t("move-history-first",void 0,"#",function(){h.showMove(0);F();return!1},"first")),D(c,t("move-history-prev",void 0,"#",function(){h.showMove(h.numMovesShown()-1);F();return!1},"prev"))):(D(c,document.createTextNode("first")),D(c,document.createTextNode("prev")));D(c,document.createTextNode(""+h.numMovesShown()+" / "+h.numMoves()));h.numMovesShown()<h.numMoves()?(D(c,t("move-history-next",void 0,"#",function(){h.showMove(h.numMovesShown()+1);F();return!1},"next")),D(c,t("move-history-last",void 0,
"#",function(){h.showMove(h.numMoves());F();return!1},"last"))):(D(c,document.createTextNode("next")),D(c,document.createTextNode("last")));a.appendChild(b);b=document.createElement("div");b.id="moveHistoryFork";b.appendChild(t("move-history-fork-link",void 0,"/fork/"+v+"/"+h.numMovesShown().toString(),void 0,"fork"));b.appendChild(document.createTextNode(" current position"));a.appendChild(b)}function G(){c();var a="r";e.black&&e.black.id==n&&(a="b");var b=e.black&&e.black.id==n||e.red&&e.red.id==
n;h.setState(a,!(e.red&&e.black&&!e.moves.endsWith("R")&&!e.moves.endsWith("B"))||!b,u(e.moves));y();F()}function m(){var a=document.getElementById("board");.81*window.innerHeight<=window.innerWidth?(a.style.removeProperty("width"),a.style.height="90vh"):(a.style.width="100vw",a.style.removeProperty("height"))}var A,B,h,w=0,f=0,b=[];(function(){A=new Stopwatch("redStopwatch");B=new Stopwatch("blackStopwatch");window.setInterval(function(){A.tick();B.tick()},6E4/A.frequency());window.onload=m;window.onresize=
m;h=new Board(a,!1);G();window.setInterval(function(){z("GET","/gameinfo?gid="+v,w,void 0,void 0,p,l)},1E3)})()}document.onreadystatechange=function(){"interactive"==document.readyState&&new Game(currentGameId,myUid,gameInfo)};
